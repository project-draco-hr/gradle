{
  final ScriptSource scriptSource=scriptSource("");
  expectedProperties.put(DefaultScriptCompilationHandler.DEBUGINFO_KEY,scriptSource.getFileName());
  context.checking(new Expectations(){
{
      one(cachePropertiesHandlerMock).getCacheState(scriptSource,scriptCacheDir,expectedProperties);
      will(returnValue(CachePropertiesHandler.CacheState.VALID));
      one(cachePropertiesHandlerMock).writeProperties(scriptSource,scriptCacheDir,expectedProperties);
    }
  }
);
  scriptCompilationHandler.writeToCache(scriptSource,classLoader,scriptCacheDir,null,expectedScriptClass);
  checkScriptClassesInCache();
  Script script=scriptCompilationHandler.loadFromCache(scriptSource,classLoader,scriptCacheDir,expectedScriptClass);
  assertThat(script,is(expectedScriptClass));
}
