{
  TaskArtifactStateCacheAccess cacheAccess=get(TaskArtifactStateCacheAccess.class);
  FileSnapshotter fileSnapshotter=new DefaultFileSnapshotter(new CachingHasher(new DefaultHasher(),cacheAccess));
  FileSnapshotter outputFilesSnapshotter=new OutputFilesSnapshotter(fileSnapshotter,new RandomLongIdGenerator(),cacheAccess);
  TaskHistoryRepository taskHistoryRepository=new CacheBackedTaskHistoryRepository(cacheAccess,new CacheBackedFileSnapshotRepository(cacheAccess));
  Instantiator instantiator=get(Instantiator.class);
  return new ShortCircuitTaskArtifactStateRepository(get(StartParameter.class),instantiator,new DefaultTaskArtifactStateRepository(taskHistoryRepository,instantiator,outputFilesSnapshotter,fileSnapshotter));
}
