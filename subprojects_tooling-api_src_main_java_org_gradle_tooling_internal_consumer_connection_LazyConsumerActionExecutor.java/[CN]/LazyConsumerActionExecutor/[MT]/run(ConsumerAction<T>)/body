{
  try {
    if (action.getCancellationToken().isCancellationRequested()) {
      throw new BuildCancelledException("Build cancelled");
    }
    ConsumerConnection connection=onStartAction(action.getCancellationToken());
    return action.run(connection);
  }
  finally {
    onEndAction();
  }
}
