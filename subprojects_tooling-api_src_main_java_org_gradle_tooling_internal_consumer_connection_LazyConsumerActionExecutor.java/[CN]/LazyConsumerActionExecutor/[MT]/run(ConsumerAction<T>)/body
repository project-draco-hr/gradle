{
  try {
    BuildCancellationToken cancellationToken=action.getParameters().getCancellationToken();
    if (cancellationToken.isCancellationRequested()) {
      throw new BuildCancelledException("Build cancelled");
    }
    ConsumerConnection connection=onStartAction(cancellationToken);
    return action.run(connection);
  }
  finally {
    onEndAction();
  }
}
