{
  BuildRequestMetaData requestMetaData;
  BuildCancellationToken cancellationToken;
  BuildEventConsumer buildEventConsumer;
  if (tracker.getCurrentBuild() != null) {
    ServiceRegistry services=tracker.getCurrentBuild().getServices();
    requestMetaData=new DefaultBuildRequestMetaData(services.get(BuildClientMetaData.class),System.currentTimeMillis());
    cancellationToken=services.get(BuildCancellationToken.class);
    buildEventConsumer=services.get(BuildEventConsumer.class);
  }
 else {
    requestMetaData=new DefaultBuildRequestMetaData(System.currentTimeMillis());
    cancellationToken=new DefaultBuildCancellationToken();
    buildEventConsumer=new NoOpBuildEventConsumer();
  }
  final BuildSessionScopeServices sessionScopeServices=new BuildSessionScopeServices(sharedServices,startParameter);
  final BuildScopeServices buildScopeServices=new BuildScopeServices(sessionScopeServices);
  Stoppable servicesToStop=CompositeStoppable.stoppable(buildScopeServices,sessionScopeServices);
  return doNewInstance(startParameter,cancellationToken,requestMetaData,buildEventConsumer,buildScopeServices,servicesToStop);
}
