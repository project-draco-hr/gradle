{
  project.getTasks().withType(Test.class).allTasks(new Action<Test>(){
    public void execute(    Test test){
      test.dependsOn(COMPILE_TESTS_TASK_NAME);
      test.dependsOn(PROCESS_TEST_RESOURCES_TASK_NAME);
      test.dependsOn(COMPILE_TASK_NAME);
      test.dependsOn(PROCESS_RESOURCES_TASK_NAME);
      test.getConventionMapping().map(DefaultConventionsToPropertiesMapping.TEST);
      test.setConfiguration(project.getConfigurations().getByName(TEST_RUNTIME_CONFIGURATION_NAME));
      addDependsOnProjectBuildDependencies(test,TEST_RUNTIME_CONFIGURATION_NAME);
    }
  }
);
  project.getTasks().add(TEST_TASK_NAME,Test.class).setDescription("Runs the tests.");
}
