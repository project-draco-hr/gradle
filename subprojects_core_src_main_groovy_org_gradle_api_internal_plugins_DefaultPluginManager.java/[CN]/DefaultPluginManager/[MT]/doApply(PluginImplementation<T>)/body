{
  PluginId pluginId=plugin.getPluginId();
  String pluginIdStr=pluginId == null ? null : pluginId.toString();
  Class<? extends T> pluginClass=plugin.asClass();
  try {
    if (plugin.getType().equals(PotentialPlugin.Type.UNKNOWN)) {
      throw new InvalidPluginException("'" + pluginClass.getName() + "' is neither a plugin or a rule source and cannot be applied.");
    }
 else {
      boolean imperative=plugin.isImperative();
      if (addPluginInternal(plugin)) {
        if (imperative) {
          T instance=findInstance(pluginClass,pluginContainer);
          if (instance == null) {
            instance=instantiatePlugin(pluginClass);
          }
          Plugin<?> cast=Cast.uncheckedCast(instance);
          instances.put(pluginClass,cast);
          if (plugin.isHasRules()) {
            applicator.applyImperativeRulesHybrid(pluginIdStr,cast);
          }
 else {
            applicator.applyImperative(pluginIdStr,cast);
          }
          pluginContainer.add(cast);
          return instance;
        }
 else {
          applicator.applyRules(pluginIdStr,pluginClass);
        }
      }
 else {
        if (imperative) {
          T instance=pluginClass.cast(instances.get(pluginClass));
          if (instance == null) {
            throw new IllegalStateException("Plugin of type " + pluginClass.getName() + " has been applied, but an instance wasn't found in the plugin container");
          }
 else {
            return instance;
          }
        }
      }
    }
  }
 catch (  PluginApplicationException e) {
    throw e;
  }
catch (  Exception e) {
    throw new PluginApplicationException(plugin.getDisplayName(),e);
  }
  return null;
}
