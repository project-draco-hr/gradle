{
  try {
    try {
      while (true) {
        System.out.println(String.format("=== %s waiting to receive from %s ...",Thread.currentThread(),connection));
        InterHubMessage message=connection.receive();
        System.out.println(String.format("=== %s received %s from %s.",Thread.currentThread(),message,connection));
        if (message == null || message instanceof EndOfStream) {
          return;
        }
        lock.lock();
        try {
          incomingQueue.queue(message);
        }
  finally {
          lock.unlock();
        }
      }
    }
  finally {
      lock.lock();
      try {
        System.out.println(String.format("=== %s finished receiving from %s.",Thread.currentThread(),connection));
        connectionState.receiveFinished();
      }
  finally {
        lock.unlock();
      }
    }
  }
 catch (  Throwable e) {
    System.out.println(String.format("=== %s failed receiving from %s.",Thread.currentThread(),connection));
    e.printStackTrace();
    errorHandler.execute(e);
  }
}
