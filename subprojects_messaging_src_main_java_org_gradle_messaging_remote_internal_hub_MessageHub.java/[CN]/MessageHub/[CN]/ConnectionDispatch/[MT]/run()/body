{
  try {
    List<InterHubMessage> messages=new ArrayList<InterHubMessage>();
    try {
      while (true) {
        lock.lock();
        try {
          queue.take(messages);
        }
  finally {
          lock.unlock();
        }
        for (        Object message : messages) {
          InterHubMessage channelMessage=(InterHubMessage)message;
          System.out.println(String.format("=== %s dispatching %s to %s.",Thread.currentThread(),message,connection));
          connection.dispatch(channelMessage);
          if (message instanceof EndOfStream) {
            return;
          }
        }
        messages.clear();
      }
    }
  finally {
      lock.lock();
      try {
        System.out.println(String.format("=== %s finished dispatching to %s.",Thread.currentThread(),connection));
        connectionState.dispatchFinished();
      }
  finally {
        lock.unlock();
      }
    }
  }
 catch (  Throwable t) {
    System.out.println(String.format("=== %s failed dispatching to %s.",Thread.currentThread(),connection));
    t.printStackTrace();
    errorHandler.execute(t);
  }
}
