{
  ResolverResults results=resolver.resolve(configuration,repositories,metadataProcessor);
  ResolvedConfiguration resolvedConfiguration=results.getResolvedConfiguration();
  Set<Dependency> dependencies=configuration.getAllDependencies();
  CachingDependencyResolveContext resolveContext=new CachingDependencyResolveContext(configuration.isTransitive());
  SelfResolvingFilesProvider provider=new SelfResolvingFilesProvider(resolveContext,dependencies);
  return results.withResolvedConfiguration(new FilesAggregatingResolvedConfiguration(resolvedConfiguration,provider));
}
