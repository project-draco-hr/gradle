{
  final File tmpFile=temporaryFileProvider.createTemporaryFile("gradle_download","bin");
  try {
    try {
      resourceDownloader.download(resource,tmpFile);
    }
 catch (    IOException e) {
      throw new ResourceException(String.format("Failed to download resource '%s'.",resource.getName()),e);
    }
    return cacheLockingManager.useCache(String.format("Store %s",artifact),new Factory<LocallyAvailableExternalResource>(){
      public LocallyAvailableExternalResource create(){
        LocallyAvailableResource cachedResource=fileStore.move(artifact,tmpFile);
        File fileInFileStore=cachedResource.getFile();
        ExternalResourceMetaData metaData=resource.getMetaData();
        artifactUrlCachedResolutionIndex.store(metaData.getLocation(),fileInFileStore,metaData);
        return new DefaultLocallyAvailableExternalResource(resource.getName(),cachedResource,metaData);
      }
    }
);
  }
  finally {
    tmpFile.delete();
  }
}
