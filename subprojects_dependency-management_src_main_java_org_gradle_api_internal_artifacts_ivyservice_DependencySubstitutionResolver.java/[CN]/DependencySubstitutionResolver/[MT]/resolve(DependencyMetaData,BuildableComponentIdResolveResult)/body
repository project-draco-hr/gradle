{
  ComponentSelector selector=dependency.getSelector();
  DependencySubstitutionInternal details;
  if (selector instanceof ModuleComponentSelector) {
    details=new DefaultModuleDependencySubstitution((ModuleComponentSelector)selector,dependency.getRequested());
  }
 else   if (selector instanceof ProjectComponentSelector) {
    details=new DefaultProjectDependencySubstitution((ProjectComponentSelector)selector,dependency.getRequested());
  }
 else   if (selector instanceof LibraryComponentSelector) {
    details=new DefaultLibraryDependencySubstitution((LibraryComponentSelector)selector,dependency.getRequested());
  }
 else {
    throw new IllegalStateException("Unknown type of component selector: " + selector);
  }
  try {
    rule.execute(details);
  }
 catch (  Throwable e) {
    result.failed(new ModuleVersionResolveException(selector,e));
    return;
  }
  if (details.isUpdated()) {
    resolver.resolve(dependency.withTarget(details.getTarget()),result);
    result.setSelectionReason(details.getSelectionReason());
    return;
  }
  resolver.resolve(dependency,result);
}
