{
  FactoryRegistration<S> factoryRegistration=getFactoryRegistration(type);
  if (factoryRegistration != null) {
    throw new IllegalStateException(getDuplicateRegistrationMessage("a factory",type,factoryRegistration.source));
  }
  factories.put(type.getConcreteClass(),new FactoryRegistration<S>(sourceRule,factory));
}
