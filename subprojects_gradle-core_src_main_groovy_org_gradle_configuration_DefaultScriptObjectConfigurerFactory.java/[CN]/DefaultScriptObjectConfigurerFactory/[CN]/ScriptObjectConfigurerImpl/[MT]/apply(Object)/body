{
  ScriptSource withImports=new ImportsScriptSource(scriptSource,importsReader,null);
  ScriptCompiler compiler=scriptCompilerFactory.createCompiler(withImports);
  if (target instanceof ScriptAware) {
    ScriptAware scriptAware=(ScriptAware)target;
    ScriptClassLoaderProvider classLoaderProvider=scriptAware.getClassLoaderProvider();
    compiler.setClassloader(classLoaderProvider.getClassLoader());
    BuildScriptClasspathScriptTransformer classpathScriptTransformer=new BuildScriptClasspathScriptTransformer(classpathClosureName);
    compiler.setTransformer(classpathScriptTransformer);
    ScriptRunner<? extends BasicScript> classPathScript=compiler.compile(scriptType);
    classPathScript.setDelegate(target);
    classPathScript.run();
    classLoaderProvider.updateClassPath();
    compiler.setTransformer(new BuildScriptTransformer(classpathScriptTransformer));
    ScriptRunner<? extends BasicScript> script=compiler.compile(scriptType);
    script.setDelegate(target);
    scriptAware.setScript(script.getScript());
    script.run();
  }
 else {
    compiler.setClassloader(classLoader);
    ScriptRunner<? extends BasicScript> script=compiler.compile(scriptType);
    script.setDelegate(target);
    script.run();
  }
}
