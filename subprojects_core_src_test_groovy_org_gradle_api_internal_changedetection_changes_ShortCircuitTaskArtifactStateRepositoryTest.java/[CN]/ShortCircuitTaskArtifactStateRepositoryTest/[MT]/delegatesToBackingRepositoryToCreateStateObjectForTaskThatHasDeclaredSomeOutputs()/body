{
  TaskInternal task=taskWithOutputs();
  expectTaskStateCreated(task);
  TaskArtifactState state=repository.getStateFor(task);
  assertNotNull(state);
  final TaskExecutionHistory executionHistory=context.mock(TaskExecutionHistory.class);
  context.checking(new Expectations(){
{
      one(taskArtifactState).getExecutionHistory();
      will(returnValue(executionHistory));
      one(taskArtifactState).beforeTask();
      one(taskArtifactState).afterTask();
      one(taskArtifactState).finished();
    }
  }
);
  assertThat(state.getExecutionHistory(),sameInstance(executionHistory));
  state.beforeTask();
  state.afterTask();
  state.finished();
}
