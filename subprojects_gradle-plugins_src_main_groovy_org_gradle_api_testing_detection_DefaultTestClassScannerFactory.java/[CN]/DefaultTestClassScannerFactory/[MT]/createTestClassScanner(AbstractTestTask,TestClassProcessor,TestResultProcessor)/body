{
  final File testClassDirectory=testTask.getTestClassesDir();
  final Set<String> includePatterns=testTask.getIncludes();
  final Set<String> excludePatterns=testTask.getExcludes();
  Runnable detector;
  if (testTask.isScanForTestClasses()) {
    final TestFrameworkDetector testFrameworkDetector=testTask.getTestFramework().getDetector();
    detector=new DefaultTestClassScanner(testClassDirectory,includePatterns,excludePatterns,testFrameworkDetector,testClassProcessor);
  }
 else {
    detector=new DefaultTestClassScanner(testClassDirectory,includePatterns,excludePatterns,null,testClassProcessor);
  }
  return new TestMainAction(detector,testClassProcessor,testResultProcessor,new TrueTimeProvider());
}
