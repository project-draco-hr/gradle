{
  context.checking(new Expectations(){
{
      CacheBuilder tasksCacheBuilder=context.mock(CacheBuilder.class);
      CacheBuilder fileSnapshotCacheBuilder=context.mock(CacheBuilder.class);
      one(cacheRepository).cache("taskArtifacts");
      will(returnValue(tasksCacheBuilder));
      one(tasksCacheBuilder).forObject(gradle);
      will(returnValue(tasksCacheBuilder));
      one(tasksCacheBuilder).open();
      will(returnValue(persistentCache));
      atMost(1).of(cacheRepository).cache("fileSnapshots");
      will(returnValue(fileSnapshotCacheBuilder));
      atMost(1).of(fileSnapshotCacheBuilder).open();
      will(returnValue(persistentCache));
      between(1,2).of(persistentCache).openIndexedCache(with(notNullValue(Serializer.class)));
      will(onConsecutiveCalls(returnValue(new InMemoryIndexedCache()),returnValue(new InMemoryIndexedCache())));
    }
  }
);
}
