{
  if (!getClass().desiredAssertionStatus()) {
    throw new RuntimeException("Assertions should be enabled when running integration tests.");
  }
  StartParameter parameter=new StartParameter();
  parameter.setLogLevel(LogLevel.INFO);
  parameter.setGradleHomeDir(dist.getGradleHomeDir());
  parameter.setSearchUpwards(false);
  if (!isDisableTestGradleUserHome()) {
    parameter.setGradleUserHomeDir(dist.getUserHomeDir());
  }
  InProcessGradleExecuter inProcessGradleExecuter=new InProcessGradleExecuter(parameter);
  copyTo(inProcessGradleExecuter);
  GradleExecuter returnedExecuter=inProcessGradleExecuter;
  if (FORK || inProcessGradleExecuter.getParameter().isShowVersion() || !environmentVars.isEmpty()|| script != null) {
    ForkingGradleExecuter forkingGradleExecuter=new ForkingGradleExecuter(dist);
    copyTo(forkingGradleExecuter);
    forkingGradleExecuter.setDisableTestGradleUserHome(isDisableTestGradleUserHome());
    forkingGradleExecuter.withEnvironmentVars(environmentVars);
    forkingGradleExecuter.usingExecutable(script);
    returnedExecuter=forkingGradleExecuter;
  }
 else {
    if (inProcessStartParameterModifier != null) {
      inProcessStartParameterModifier.modify(inProcessGradleExecuter.getParameter());
    }
  }
  boolean settingsFound=false;
  for (File dir=new TestFile(getWorkingDir()); dir != null && dist.isFileUnderTest(dir) && !settingsFound; dir=dir.getParentFile()) {
    if (new File(dir,"settings.gradle").isFile()) {
      settingsFound=true;
    }
  }
  if (settingsFound) {
    returnedExecuter.withSearchUpwards();
  }
  return returnedExecuter;
}
