{
  target.getPlugins().apply(LanguageBasePlugin.class);
  ProjectSourceSet projectSourceSet=target.getExtensions().getByType(ProjectSourceSet.class);
  projectSourceSet.all(new Action<FunctionalSourceSet>(){
    public void execute(    final FunctionalSourceSet functionalSourceSet){
      functionalSourceSet.registerFactory(ResourceSet.class,new NamedDomainObjectFactory<ResourceSet>(){
        public ResourceSet create(        String name){
          return instantiator.newInstance(DefaultResourceSet.class,name,instantiator.newInstance(DefaultSourceDirectorySet.class,name,fileResolver),functionalSourceSet);
        }
      }
);
    }
  }
);
  BinariesContainer binariesContainer=target.getExtensions().getByType(BinariesContainer.class);
  JvmBinaryContainer jvmBinaryContainer=instantiator.newInstance(DefaultJvmBinaryContainer.class,instantiator);
  binariesContainer.add(jvmBinaryContainer);
  jvmBinaryContainer.registerFactory(ClassDirectoryBinary.class,new NamedDomainObjectFactory<ClassDirectoryBinary>(){
    public ClassDirectoryBinary create(    String name){
      return instantiator.newInstance(DefaultClassDirectoryBinary.class,name);
    }
  }
);
  jvmBinaryContainer.all(new Action<ClassDirectoryBinary>(){
    public void execute(    final ClassDirectoryBinary binary){
      ConventionMapping conventionMapping=new DslObject(binary).getConventionMapping();
      conventionMapping.map("classesDir",new Callable<File>(){
        public File call() throws Exception {
          return new File(new File(target.getBuildDir(),"classes"),binary.getName());
        }
      }
);
      final Task classesTask=target.getTasks().add(binary.getTaskName(null,"classes"));
      classesTask.setDescription(String.format("Assembles the %s classes.",binary.getName()));
      binary.setClassesTask(classesTask);
      binary.getSource().withType(ResourceSet.class).all(new Action<ResourceSet>(){
        public void execute(        ResourceSet resourceSet){
          Copy resourcesTask=binary.getResourcesTask();
          if (resourcesTask == null) {
            resourcesTask=target.getTasks().add(binary.getTaskName("process","resources"),ProcessResources.class);
            resourcesTask.setDescription(String.format("Processes the %s resources.",binary.getName()));
            new DslObject(resourcesTask).getConventionMapping().map("destinationDir",new Callable<File>(){
              public File call() throws Exception {
                return binary.getResourcesDir();
              }
            }
);
            binary.setResourcesTask(resourcesTask);
            classesTask.dependsOn(resourcesTask);
          }
          resourcesTask.from(resourceSet.getSource());
        }
      }
);
    }
  }
);
}
