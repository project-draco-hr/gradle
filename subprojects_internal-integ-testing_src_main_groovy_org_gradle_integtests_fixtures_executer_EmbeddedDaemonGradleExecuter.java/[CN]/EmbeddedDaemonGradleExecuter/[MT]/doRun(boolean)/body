{
  StringBuilder output=new StringBuilder();
  StringBuilder error=new StringBuilder();
  LoggingManagerInternal loggingManager=createLoggingManager(output,error);
  loggingManager.start();
  ExecuteBuildAction buildAction=createBuildAction();
  BuildActionParameters buildActionParameters=createBuildActionParameters();
  DaemonClient daemonClient=daemonClientServices.get(DaemonClient.class);
  Exception failure=null;
  try {
    daemonClient.execute(buildAction,buildActionParameters);
  }
 catch (  Exception e) {
    failure=e;
  }
 finally {
    daemonClient.stop();
    loggingManager.stop();
  }
  boolean didFail=failure != null;
  if (expectFailure != didFail) {
    String didOrDidntSnippet=didFail ? "DID fail" : "DID NOT fail";
    throw new RuntimeException(String.format("Gradle execution in %s %s with: %nOutput:%n%s%nError:%n%s%n-----%n",getWorkingDir(),didOrDidntSnippet,output,error),failure);
  }
  if (expectFailure) {
    return new OutputScrapingExecutionFailure(output.toString(),error.toString());
  }
 else {
    return new OutputScrapingExecutionResult(output.toString(),error.toString());
  }
}
