{
  ModuleVersionSelector requestedModule=dependency.getRequested();
  VersionSelector requestedVersion=versionSelectorScheme.parseSelector(requestedModule.getVersion());
  Collection<SpecRuleAction<? super ComponentSelection>> rules=componentSelectionRules.getRules();
  for (  ModuleComponentResolveState candidate : sortLatestFirst(versions)) {
    MetadataProvider metadataProvider=new MetadataProvider(candidate);
    boolean versionMatches=versionMatches(requestedVersion,candidate,metadataProvider);
    if (!metadataProvider.isUsable()) {
      applyTo(metadataProvider,result);
      return;
    }
    if (versionMatches) {
      ModuleComponentIdentifier candidateIdentifier=candidate.getId();
      boolean accepted=!isRejectedByRules(candidateIdentifier,rules,metadataProvider);
      if (!metadataProvider.isUsable()) {
        applyTo(metadataProvider,result);
        return;
      }
      if (accepted) {
        result.matches(candidateIdentifier);
        return;
      }
      if (requestedVersion.matchesUniqueVersion()) {
        break;
      }
    }
  }
  result.noMatchFound();
}
