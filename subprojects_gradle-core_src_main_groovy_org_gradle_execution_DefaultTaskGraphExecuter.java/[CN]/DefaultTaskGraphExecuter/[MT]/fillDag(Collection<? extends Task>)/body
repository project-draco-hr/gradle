{
  Set<Task> visiting=new HashSet<Task>();
  List<Task> queue=new ArrayList<Task>();
  queue.addAll(tasks);
  CachingTaskDependencyResolveContext context=new CachingTaskDependencyResolveContext();
  while (!queue.isEmpty()) {
    Task task=queue.get(0);
    if (!filter.isSatisfiedBy(task)) {
      queue.remove(0);
      continue;
    }
    if (executionPlan.contains(task)) {
      queue.remove(0);
      continue;
    }
    if (visiting.add(task)) {
      Set<Task> dependsOnTasks=new TreeSet<Task>(Collections.reverseOrder());
      dependsOnTasks.addAll(context.getDependencies(task));
      for (      Task dependsOnTask : dependsOnTasks) {
        if (visiting.contains(dependsOnTask)) {
          throw new CircularReferenceException(String.format("Circular dependency between tasks. Cycle includes %s.",task));
        }
        queue.add(0,dependsOnTask);
      }
    }
 else {
      queue.remove(0);
      visiting.remove(task);
      executionPlan.add(task);
    }
  }
}
