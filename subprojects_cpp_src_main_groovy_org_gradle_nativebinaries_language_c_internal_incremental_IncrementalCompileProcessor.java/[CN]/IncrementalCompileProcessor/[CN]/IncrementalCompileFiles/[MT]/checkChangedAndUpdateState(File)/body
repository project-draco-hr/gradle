{
  boolean changed=false;
  if (processed.containsKey(file)) {
    return processed.get(file);
  }
  if (!file.exists()) {
    return true;
  }
  processed.put(file,false);
  FileState state=findState(file);
  if (state == null) {
    state=new FileState();
  }
  byte[] currentHash=snapshotter.snapshot(file).getHash();
  Set<ResolvedInclude> resolvedIncludes;
  if (hasChanged(state,currentHash)) {
    SourceIncludes sourceIncludes=sourceIncludesParser.parseIncludes(file);
    resolvedIncludes=resolveIncludes(file,sourceIncludes);
    changed=true;
    state.setHash(currentHash);
    state.setIncludes(sourceIncludes);
    state.setResolvedIncludes(resolvedIncludes);
    saveState(file,state);
  }
 else {
    resolvedIncludes=resolveIncludes(file,state.getIncludes());
    if (!state.getResolvedIncludes().equals(resolvedIncludes)) {
      changed=true;
      state.setResolvedIncludes(resolvedIncludes);
      saveState(file,state);
    }
  }
  for (  ResolvedInclude dep : resolvedIncludes) {
    if (dep.isUnknown()) {
      LOGGER.info(String.format("Cannot determine changed state of included '%s' in source file '%s'. Assuming changed.",dep.getInclude(),file.getName()));
      changed=true;
    }
 else {
      boolean depChanged=checkChangedAndUpdateState(dep.getFile());
      changed=changed || depChanged;
    }
  }
  processed.put(file,changed);
  return changed;
}
