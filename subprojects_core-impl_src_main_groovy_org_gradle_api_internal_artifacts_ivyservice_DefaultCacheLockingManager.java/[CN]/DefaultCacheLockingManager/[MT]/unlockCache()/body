{
  lock.lock();
  try {
    closeMetadataLocks();
    if (!artifactLocks.isEmpty()) {
      new CompositeStoppable().addCloseables(artifactLocks.values()).stop();
      throw new IllegalStateException("Some artifact file locks were not released.");
    }
  }
  finally {
    locked=false;
    metadataLocks.clear();
    artifactLocks.clear();
    lock.unlock();
  }
}
