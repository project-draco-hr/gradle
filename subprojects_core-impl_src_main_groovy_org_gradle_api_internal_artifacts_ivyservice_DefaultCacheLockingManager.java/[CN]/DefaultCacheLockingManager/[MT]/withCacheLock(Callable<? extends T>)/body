{
  boolean wasUnlocked=locked.compareAndSet(false,true);
  if (!wasUnlocked) {
    throw new IllegalStateException("Cannot lock the artifact cache, as it is already locked by this process.");
  }
  try {
    FileLock lock=fileLockManager.lock(cacheMetaData.getCacheDir(),FileLockManager.LockMode.Exclusive,"artifact cache");
    try {
      return action.call();
    }
 catch (    Exception e) {
      throw UncheckedException.asUncheckedException(e);
    }
 finally {
      lock.close();
    }
  }
  finally {
    locked.set(false);
  }
}
