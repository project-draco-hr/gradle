{
  URI uri=toUri(destination);
  LockableSftpClient client=sftpClientFactory.createSftpClient(uri,credentials);
  try {
    String path=uri.getPath();
    ChannelSftp channel=client.getSftpClient();
    ensureParentDirectoryExists(channel,path,uri);
    InputStream sourceStream=sourceFactory.create();
    try {
      channel.put(sourceStream,uri.getPath());
    }
  finally {
      sourceStream.close();
    }
  }
 catch (  com.jcraft.jsch.SftpException e) {
    throw new SftpException(String.format("Could not write to resource '%s'.",uri),e);
  }
 finally {
    sftpClientFactory.releaseSftpClient(client);
  }
}
