{
  ClassPathRegistry classPathRegistry=new DefaultClassPathRegistry(new DefaultClassPathProvider(new DefaultModuleRegistry()));
  ClassLoaderFactory classLoaderFactory=new DefaultClassLoaderFactory();
  Collection<URL> antClasspath=classPathRegistry.getClassPath("ANT").getAsURLs();
  URL[] runtimeClasspath=classPathRegistry.getClassPath("GRADLE_RUNTIME").getAsURLArray();
  ClassLoader antClassLoader=classLoaderFactory.createIsolatedClassLoader(antClasspath);
  ClassLoader runtimeClassLoader=new URLClassLoader(runtimeClasspath,antClassLoader);
  Thread.currentThread().setContextClassLoader(runtimeClassLoader);
  Class<?> mainClass=runtimeClassLoader.loadClass(mainClassName);
  Method mainMethod=mainClass.getMethod("main",String[].class);
  mainMethod.invoke(null,new Object[]{args});
}
