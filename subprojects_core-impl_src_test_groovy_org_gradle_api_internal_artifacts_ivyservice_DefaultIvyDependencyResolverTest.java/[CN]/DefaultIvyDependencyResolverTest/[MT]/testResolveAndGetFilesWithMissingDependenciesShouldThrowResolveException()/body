{
  ModuleDescriptor moduleDescriptor=createAnonymousModuleDescriptor();
  prepareTestsThatRetrieveDependencies(moduleDescriptor);
  Exception failure=new Exception("broken");
  prepareResolveReportWithError(failure);
  ResolvedConfiguration configuration=ivyDependencyResolver.resolve(configurationStub);
  context.checking(new Expectations(){
{
      allowing(configurationStub).getAllDependencies();
    }
  }
);
  try {
    configuration.getFiles(Specs.SATISFIES_ALL);
    fail();
  }
 catch (  ResolveException e) {
    assertThat(e.getMessage(),startsWith("Could not resolve all dependencies for <configuration>"));
    assertThat(e.getCause(),sameInstance((Throwable)failure));
  }
}
