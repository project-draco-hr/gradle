{
  ModuleDescriptor moduleDescriptor=createAnonymousModuleDescriptor();
  prepareTestsThatRetrieveDependencies(moduleDescriptor);
  Exception failure=new Exception("broken");
  prepareResolveReportWithError(failure);
  ResolvedConfiguration configuration=ivyDependencyResolver.resolve(configurationStub,ivyStub);
  assertTrue(configuration.hasError());
  try {
    configuration.rethrowFailure();
    fail();
  }
 catch (  ResolveException e) {
    assertThat(e.getMessage(),startsWith("Could not resolve all dependencies for <configuration>"));
    assertThat(e.getCause(),sameInstance((Throwable)failure));
  }
}
