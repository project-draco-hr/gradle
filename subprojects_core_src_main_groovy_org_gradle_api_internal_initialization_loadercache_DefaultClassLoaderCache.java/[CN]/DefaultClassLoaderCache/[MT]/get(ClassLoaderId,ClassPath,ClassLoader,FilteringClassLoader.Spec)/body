{
synchronized (lock) {
    ClassPathSnapshot classPathSnapshot=snapshotter.snapshot(classPath);
    ClassLoaderSpec spec=new ClassLoaderSpec(parent,classPathSnapshot,filterSpec);
    CachedClassLoader cachedLoader=byId.get(id);
    if (cachedLoader == null || !cachedLoader.is(spec)) {
      CachedClassLoader newLoader=getAndRetainLoader(classPath,spec,id);
      byId.put(id,newLoader);
      if (cachedLoader != null) {
        cachedLoader.release(id);
      }
      return newLoader.classLoader;
    }
 else {
      return cachedLoader.classLoader;
    }
  }
}
