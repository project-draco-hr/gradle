{
  ClassPathSnapshot classPathSnapshot=snapshotter.snapshot(classPath);
  ClassLoaderSpec spec=new ClassLoaderSpec(parent,classPathSnapshot,filterSpec);
synchronized (lock) {
    CachedClassLoader cachedLoader=byId.get(id);
    if (cachedLoader == null || !cachedLoader.is(spec)) {
      CachedClassLoader newLoader=getLoader(classPath,spec).retain();
      byId.put(id,newLoader);
      if (cachedLoader != null) {
        cachedLoader.release();
      }
      return newLoader.classLoader;
    }
 else {
      return cachedLoader.classLoader;
    }
  }
}
