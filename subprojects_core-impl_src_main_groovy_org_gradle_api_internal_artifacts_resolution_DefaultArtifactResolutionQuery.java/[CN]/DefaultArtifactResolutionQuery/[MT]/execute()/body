{
  List<ResolutionAwareRepository> repositories=CollectionUtils.collect(repositoryHandler,Transformers.cast(ResolutionAwareRepository.class));
  ConfigurationInternal configuration=configurationContainer.detachedConfiguration();
  final DependencyToModuleVersionResolver resolver=ivyFactory.create(configuration,repositories,metadataProcessor);
  return lockingManager.useCache("resolve artifacts",new Factory<ArtifactResolutionQueryResult>(){
    public ArtifactResolutionQueryResult create(){
      Set<JvmLibrary> jvmLibraries=Sets.newHashSet();
      Set<UnresolvedSoftwareComponent> unresolvedComponents=Sets.newHashSet();
      for (      ComponentIdentifier componentId : componentIds) {
        if (!(componentId instanceof ModuleComponentIdentifier)) {
          throw new AssertionError(String.format("cannot handle component identifiers of type %s",componentId.getClass().getName()));
        }
        ModuleComponentIdentifier moduleComponentId=(ModuleComponentIdentifier)componentId;
        BuildableModuleVersionResolveResult moduleResolveResult=new DefaultBuildableModuleVersionResolveResult();
        resolver.resolve(new DefaultDependencyMetaData(new DefaultDependencyDescriptor(toModuleRevisionId(moduleComponentId),true)),moduleResolveResult);
        if (moduleResolveResult.getFailure() != null) {
          unresolvedComponents.add(new DefaultUnresolvedSoftwareComponent(moduleComponentId,moduleResolveResult.getFailure()));
        }
 else {
          moduleResolveResult.setArtifactResolver(new ErrorHandlingArtifactResolver(moduleResolveResult.getArtifactResolver()));
          List<JvmLibraryArtifact> jvmLibraryArtifacts=Lists.newArrayList();
          for (          Class<? extends SoftwareArtifact> artifactType : artifactTypes) {
            if (artifactType == JvmLibraryJavadocArtifact.class) {
              Artifact artifact=new DefaultArtifact(toModuleRevisionId(moduleComponentId),null,moduleComponentId.getModule(),"javadoc","jar",ImmutableMap.of("m:classifier","javadoc"));
              DefaultBuildableArtifactResolveResult artifactResolveResult=new DefaultBuildableArtifactResolveResult();
              moduleResolveResult.getArtifactResolver().resolve(new DefaultModuleVersionArtifactMetaData(moduleResolveResult.getId(),artifact),artifactResolveResult);
              if (artifactResolveResult.getFailure() != null) {
                int x=1;
              }
 else {
                jvmLibraryArtifacts.add(new DefaultJvmLibraryJavadocArtifact(artifactResolveResult.getFile()));
              }
            }
 else             if (artifactType == JvmLibrarySourcesArtifact.class) {
              Artifact artifact=new DefaultArtifact(toModuleRevisionId(moduleComponentId),null,moduleComponentId.getModule(),"source","jar",ImmutableMap.of("m:classifier","sources"));
              DefaultBuildableArtifactResolveResult artifactResolveResult=new DefaultBuildableArtifactResolveResult();
              moduleResolveResult.getArtifactResolver().resolve(new DefaultModuleVersionArtifactMetaData(moduleResolveResult.getId(),artifact),artifactResolveResult);
              if (artifactResolveResult.getFailure() != null) {
                int x=1;
              }
 else {
                jvmLibraryArtifacts.add(new DefaultJvmLibrarySourcesArtifact(artifactResolveResult.getFile()));
              }
            }
          }
          jvmLibraries.add(new DefaultJvmLibrary(moduleComponentId,jvmLibraryArtifacts));
        }
      }
      return new DefaultArtifactResolutionQueryResult(jvmLibraries,unresolvedComponents);
    }
  }
);
}
