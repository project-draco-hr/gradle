{
  if (isDirectoryFileTree(fileTree)) {
    DirectoryFileTree directoryFileTree=DirectoryFileTree.class.cast(((FileTreeAdapter)fileTree).getTree());
    if (isEligibleForCaching(directoryFileTree)) {
      final String absolutePath=directoryFileTree.getDir().getAbsolutePath();
      Collection<FileTreeElement> cachedTree=allowReuse ? cachedTrees.get(absolutePath) : null;
      if (cachedTree != null) {
        recordCacheHit(directoryFileTree);
        return cachedTree;
      }
 else {
        recordCacheMiss(directoryFileTree,allowReuse);
        cachedTree=doVisitTree(fileTree);
        cachedTrees.put(absolutePath,cachedTree);
        return cachedTree;
      }
    }
  }
  return doVisitTree(fileTree);
}
