{
  TaskFilePropertyCompareType compareType=TaskFilePropertyCompareType.values()[decoder.readSmallInt()];
  Map<String,IncrementalFileSnapshot> snapshots=new HashMap<String,IncrementalFileSnapshot>();
  int snapshotsCount=decoder.readSmallInt();
  for (int i=0; i < snapshotsCount; i++) {
    String key=stringInterner.intern(decoder.readString());
    byte fileSnapshotKind=decoder.readByte();
    if (fileSnapshotKind == 1) {
      snapshots.put(key,DirSnapshot.getInstance());
    }
 else     if (fileSnapshotKind == 2) {
      snapshots.put(key,MissingFileSnapshot.getInstance());
    }
 else     if (fileSnapshotKind == 3) {
      snapshots.put(key,new FileHashSnapshot(hashValueSerializer.read(decoder)));
    }
 else {
      throw new RuntimeException("Unable to read serialized file collection snapshot. Unrecognized value found in the data stream.");
    }
  }
  return new FileCollectionSnapshotImpl(snapshots,compareType);
}
