{
  Collection<File> applicationClasspath=processBuilder.getApplicationClasspath();
  Collection<URL> workerClassPath=classPathRegistry.getClassPath("WORKER_PROCESS").getAsURLs();
  LogLevel logLevel=processBuilder.getLogLevel();
  Set<String> sharedPackages=processBuilder.getSharedPackages();
  Object requestedSecurityManager=execSpec.getSystemProperties().get("java.security.manager");
  ClassPath workerMainClassPath=classPathRegistry.getClassPath("WORKER_MAIN");
  execSpec.setMain("jarjar." + GradleWorkerMain.class.getName());
  boolean useOptionsFile=Jvm.current().getJavaVersion().isJava9Compatible() && execSpec.getExecutable().equals(Jvm.current().getJavaExecutable().getPath());
  if (useOptionsFile) {
    File optionsFile=temporaryFileProvider.createTemporaryFile("gradle-worker-classpath","txt");
    List<String> jvmArgs=writeOptionsFile(workerMainClassPath.getAsFiles(),applicationClasspath,optionsFile);
    execSpec.jvmArgs(jvmArgs);
  }
 else {
    execSpec.classpath(workerMainClassPath.getAsFiles());
    execSpec.systemProperty("java.security.manager","jarjar." + BootstrapSecurityManager.class.getName());
  }
  ActionExecutionWorker worker=new ActionExecutionWorker(processBuilder.getWorker(),workerId,displayName,serverAddress,processBuilder.getGradleUserHomeDir());
  ByteArrayOutputStream bytes=new ByteArrayOutputStream();
  try {
    DataOutputStream outstr=new DataOutputStream(new EncodedStream.EncodedOutput(bytes));
    if (!useOptionsFile) {
      outstr.writeInt(applicationClasspath.size());
      for (      File file : applicationClasspath) {
        outstr.writeUTF(file.getAbsolutePath());
      }
      outstr.writeUTF(requestedSecurityManager == null ? "" : requestedSecurityManager.toString());
    }
    outstr.writeInt(workerClassPath.size());
    for (    URL entry : workerClassPath) {
      outstr.writeUTF(entry.toString());
    }
    outstr.writeInt(logLevel.ordinal());
    outstr.writeInt(sharedPackages.size());
    for (    String str : sharedPackages) {
      outstr.writeUTF(str);
    }
    outstr.writeInt(implementationClassPath.size());
    for (    URL entry : implementationClassPath) {
      outstr.writeUTF(entry.toString());
    }
    byte[] serializedWorker=GUtil.serialize(worker);
    outstr.writeInt(serializedWorker.length);
    outstr.write(serializedWorker);
    outstr.flush();
  }
 catch (  IOException e) {
    throw new UncheckedIOException(e);
  }
  execSpec.setStandardInput(new ByteArrayInputStream(bytes.toByteArray()));
}
