{
  ComparableGradleBuildInvocationSpec comparableSourceBuild=new ComparableGradleBuildInvocationSpec(getSourceBuild());
  ComparableGradleBuildInvocationSpec comparableTargetBuild=new ComparableGradleBuildInvocationSpec(getTargetBuild());
  if (comparableSourceBuild.equals(comparableTargetBuild)) {
    getLogger().warn("The source build and target build are identical. Set '{}.targetBuild.gradleVersion' if you want to compare with a different Gradle version.",getName());
  }
  if (!comparableSourceBuild.isExecutable() || !comparableTargetBuild.isExecutable()) {
    throw new GradleException(String.format("Builds must be executed with %s or newer (source: %s, target: %s)",ComparableGradleBuildInvocationSpec.EXEC_MINIMUM_VERSION,comparableSourceBuild.getGradleVersion().getVersion(),comparableTargetBuild.getGradleVersion().getVersion()));
  }
  boolean sourceBuildHasOutcomesModel=comparableSourceBuild.isCanObtainProjectOutcomesModel();
  boolean targetBuildHasOutcomesModel=comparableTargetBuild.isCanObtainProjectOutcomesModel();
  if (!sourceBuildHasOutcomesModel && !targetBuildHasOutcomesModel) {
    throw new GradleException(String.format("Cannot run comparison because both the source and target build are to be executed with a Gradle version older than %s (source: %s, target: %s).",ComparableGradleBuildInvocationSpec.PROJECT_OUTCOMES_MINIMUM_VERSION,comparableSourceBuild.getGradleVersion().getVersion(),comparableTargetBuild.getGradleVersion().getVersion()));
  }
  Logger logger=getLogger();
  ProgressLogger progressLogger=progressLoggerFactory.newOperation(getClass());
  String executingSourceBuildMessage=executingMessage("source",comparableSourceBuild);
  String executingTargetBuildMessage=executingMessage("target",comparableTargetBuild);
  progressLogger.setDescription("Gradle Build Comparison");
  progressLogger.setShortDescription(getName());
  Set<BuildOutcome> fromOutcomes=null;
  if (sourceBuildHasOutcomesModel) {
    logger.info(executingSourceBuildMessage);
    progressLogger.started(executingSourceBuildMessage);
    ProjectOutcomes fromOutput=buildProjectOutcomesOrJustExec(comparableSourceBuild,false);
    progressLogger.progress("inspecting source build outcomes");
    GradleBuildOutcomeSetTransformer fromOutcomeTransformer=createOutcomeSetTransformer(SOURCE_FILESTORE_PREFIX);
    fromOutcomes=fromOutcomeTransformer.transform(fromOutput);
  }
  logger.info(executingTargetBuildMessage);
  if (sourceBuildHasOutcomesModel) {
    progressLogger.progress(executingTargetBuildMessage);
  }
 else {
    progressLogger.started(executingTargetBuildMessage);
  }
  ProjectOutcomes toOutput=buildProjectOutcomesOrJustExec(comparableTargetBuild,!targetBuildHasOutcomesModel);
  Set<BuildOutcome> toOutcomes=null;
  if (targetBuildHasOutcomesModel) {
    progressLogger.progress("inspecting target build outcomes");
    GradleBuildOutcomeSetTransformer toOutcomeTransformer=createOutcomeSetTransformer(TARGET_FILESTORE_PREFIX);
    toOutcomes=toOutcomeTransformer.transform(toOutput);
  }
 else {
    toOutcomes=createOutcomeSetInferrer(TARGET_FILESTORE_PREFIX,comparableTargetBuild.getProjectDir()).transform(fromOutcomes);
  }
  if (!sourceBuildHasOutcomesModel) {
    logger.info(executingSourceBuildMessage);
    progressLogger.progress(executingSourceBuildMessage);
    buildProjectOutcomesOrJustExec(comparableSourceBuild,true);
    progressLogger.progress("inspecting source build outcomes");
    fromOutcomes=createOutcomeSetInferrer(SOURCE_FILESTORE_PREFIX,comparableSourceBuild.getProjectDir()).transform(toOutcomes);
  }
  progressLogger.progress("preparing for comparison");
  DefaultBuildOutcomeComparatorFactory comparatorFactory=new DefaultBuildOutcomeComparatorFactory();
  BuildOutcomeAssociator[] associators=new BuildOutcomeAssociator[2];
  DefaultBuildOutcomeComparisonResultRendererFactory<HtmlRenderContext> renderers=new DefaultBuildOutcomeComparisonResultRendererFactory<HtmlRenderContext>(HtmlRenderContext.class);
  associators[0]=new ByTypeAndNameBuildOutcomeAssociator<BuildOutcome>(GeneratedArchiveBuildOutcome.class);
  comparatorFactory.registerComparator(new GeneratedArchiveBuildOutcomeComparator());
  renderers.registerRenderer(new GeneratedArchiveBuildOutcomeComparisonResultHtmlRenderer("Source Build","Target Build"));
  associators[1]=new ByTypeAndNameBuildOutcomeAssociator<BuildOutcome>(UnknownBuildOutcome.class);
  comparatorFactory.registerComparator(new UnknownBuildOutcomeComparator());
  renderers.registerRenderer(new UnknownBuildOutcomeComparisonResultHtmlRenderer("Source Build","Target Build"));
  BuildOutcomeAssociator compositeAssociator=new CompositeBuildOutcomeAssociator(associators);
  BuildComparisonSpecFactory specFactory=new BuildComparisonSpecFactory(compositeAssociator);
  BuildComparisonSpec comparisonSpec=specFactory.createSpec(fromOutcomes,toOutcomes);
  progressLogger.progress("comparing build outcomes");
  BuildComparator buildComparator=new DefaultBuildComparator(comparatorFactory);
  BuildComparisonResult result=buildComparator.compareBuilds(comparisonSpec);
  writeReport(result,renderers);
  progressLogger.completed();
  communicateResult(result);
}
