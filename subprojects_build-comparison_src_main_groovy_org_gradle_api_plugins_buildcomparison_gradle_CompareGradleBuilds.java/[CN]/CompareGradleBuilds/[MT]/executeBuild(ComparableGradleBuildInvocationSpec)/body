{
  GradleVersion gradleVersion=spec.getGradleVersion();
  GradleConnector connector=GradleConnector.newConnector().forProjectDirectory(spec.getProjectDir());
  File gradleUserHomeDir=getProject().getGradle().getStartParameter().getGradleUserHomeDir();
  if (gradleUserHomeDir != null) {
    connector.useGradleUserHomeDir(gradleUserHomeDir);
  }
  if (gradleVersion.equals(GradleVersion.current())) {
    connector.useInstallation(getProject().getGradle().getGradleHomeDir());
  }
 else {
    connector.useGradleVersion(gradleVersion.getVersion());
  }
  ProjectConnection connection=connector.connect();
  try {
    return spec.executeWith(connection);
  }
  finally {
    connection.close();
  }
}
