{
  if (message instanceof ConsumerAvailable) {
    ConsumerAvailable consumerAvailable=(ConsumerAvailable)message;
    consumers.add(consumerAvailable.getId());
    if (!queue.isEmpty()) {
      for (      Object queued : queue) {
        context.dispatchOutgoing(new Request(consumerAvailable.getId(),queued));
      }
      queue.clear();
      if (stopping) {
        LOGGER.debug("All queued outgoing messages have been dispatched. Stopping now.");
        context.stopped();
      }
    }
  }
 else   if (message instanceof ConsumerUnavailable) {
    ConsumerUnavailable consumerUnavailable=(ConsumerUnavailable)message;
    consumers.remove(consumerUnavailable.getId());
  }
 else {
    throw new IllegalArgumentException(String.format("Received unexpected incoming message: %s",message));
  }
}
