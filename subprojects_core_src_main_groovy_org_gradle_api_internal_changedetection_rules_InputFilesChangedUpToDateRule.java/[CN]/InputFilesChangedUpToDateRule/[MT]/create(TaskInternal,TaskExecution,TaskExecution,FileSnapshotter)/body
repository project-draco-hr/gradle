{
  final FileCollectionSnapshot inputFilesSnapshot=inputFilesSnapshotter.snapshot(task.getInputs().getFiles());
  return new CachingUpToDateState(){
    @Override protected void doFindChanges(    final Action<TaskUpToDateStateChange> action){
      if (previousExecution.getInputFilesSnapshot() == null) {
        action.execute(new DescriptiveChange("Input file history is not available for %s.",task));
        return;
      }
      inputFilesSnapshot.changesSince(previousExecution.getInputFilesSnapshot(),new ChangeListener<File>(){
        public void added(        File file){
          action.execute(new InputFileChange(task,file,ChangeType.ADDED));
        }
        public void removed(        File file){
          action.execute(new InputFileChange(task,file,ChangeType.REMOVED));
        }
        public void changed(        File file){
          action.execute(new InputFileChange(task,file,ChangeType.MODIFIED));
        }
      }
);
    }
    public void snapshotAfterTask(){
      currentExecution.setInputFilesSnapshot(inputFilesSnapshot);
    }
  }
;
}
