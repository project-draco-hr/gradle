{
  File[] children=file.listFiles();
  List<FileVisitDetailsImpl> dirs=new ArrayList<FileVisitDetailsImpl>();
  for (int i=0; !stopFlag.get() && i < children.length; i++) {
    File child=children[i];
    boolean isFile=child.isFile();
    RelativePath childPath=new RelativePath(isFile,path,child.getName());
    FileVisitDetailsImpl details=new FileVisitDetailsImpl(child,childPath,stopFlag);
    if (isAllowed(details)) {
      if (isFile) {
        visitor.visitFile(details);
      }
 else {
        dirs.add(details);
      }
    }
  }
  for (int i=0; !stopFlag.get() && i < dirs.size(); i++) {
    FileVisitDetailsImpl dir=dirs.get(i);
    visitor.visitDir(dir);
    walkDir(dir.file,dir.relativePath,stopFlag);
  }
}
