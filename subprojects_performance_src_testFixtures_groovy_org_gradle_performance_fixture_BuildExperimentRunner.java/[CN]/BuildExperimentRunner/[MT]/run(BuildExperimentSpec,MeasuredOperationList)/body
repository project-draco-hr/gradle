{
  System.out.println();
  System.out.println(String.format("%s ...",experiment.getDisplayName()));
  System.out.println();
  File workingDirectory=experiment.getInvocation().getWorkingDirectory();
  final List<String> additionalJvmOpts=dataCollector.getAdditionalJvmOpts(workingDirectory);
  final List<String> additionalArgs=new ArrayList<String>(dataCollector.getAdditionalArgs(workingDirectory));
  additionalArgs.add("-PbuildExperimentDisplayName=" + experiment.getDisplayName());
  if (System.getProperty("org.gradle.performance.heapdump") != null) {
    additionalArgs.add("-Pheapdump");
  }
  GradleInvocationSpec buildSpec=experiment.getInvocation().withAdditionalJvmOpts(additionalJvmOpts).withAdditionalArgs(additionalArgs);
  File projectDir=buildSpec.getWorkingDirectory();
  GradleSession session=executerProvider.session(buildSpec);
  session.prepare();
  try {
    for (int i=0; i < experiment.getWarmUpCount(); i++) {
      System.out.println();
      System.out.println(String.format("Warm-up #%s",i + 1));
      runOnce(session,experiment,new MeasuredOperationList(),projectDir,Phase.WARMUP,i + 1,experiment.getWarmUpCount());
    }
    waitForMillis(experiment.getSleepAfterWarmUpMillis());
    for (int i=0; i < experiment.getInvocationCount(); i++) {
      if (i > 0) {
        waitForMillis(experiment.getSleepAfterTestRoundMillis());
      }
      System.out.println();
      System.out.println(String.format("Test run #%s",i + 1));
      runOnce(session,experiment,results,projectDir,Phase.MEASUREMENT,i + 1,experiment.getInvocationCount());
    }
  }
  finally {
    session.cleanup();
  }
}
