{
  setExtension(DEFAULT_EXTENSION);
  manifest=new DefaultManifest(getFileResolver());
  metaInf=(CopySpecInternal)getRootSpec().addFirst().into("META-INF");
  metaInf.addChild().from(new Callable<FileTreeAdapter>(){
    public FileTreeAdapter call() throws Exception {
      MapFileTree manifestSource=new MapFileTree(getTemporaryDirFactory(),getFileSystem());
      manifestSource.add("MANIFEST.MF",new Action<OutputStream>(){
        public void execute(        OutputStream outputStream){
          Manifest manifest=getManifest();
          if (manifest == null) {
            manifest=new DefaultManifest(null);
          }
          manifest.writeTo(new OutputStreamWriter(outputStream));
        }
      }
);
      return new FileTreeAdapter(manifestSource);
    }
  }
);
  getMainSpec().eachFile(new Action<FileCopyDetails>(){
    public void execute(    FileCopyDetails details){
      if (details.getPath().equalsIgnoreCase("META-INF/MANIFEST.MF")) {
        details.exclude();
      }
    }
  }
);
}
