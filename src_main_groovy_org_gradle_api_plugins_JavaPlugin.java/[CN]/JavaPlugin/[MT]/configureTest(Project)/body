{
  project.getTasks().withType(Test.class).allTasks(new Action<Test>(){
    public void execute(    Test test){
      test.dependsOn(COMPILE_TESTS_TASK_NAME);
      test.conventionMapping(DefaultConventionsToPropertiesMapping.TEST);
      test.setConfiguration(project.getConfigurations().getByName(TEST_RUNTIME_CONFIGURATION_NAME));
      addDependsOnProjectDependencies(test,TEST_RUNTIME_CONFIGURATION_NAME);
      test.doFirst(new TaskAction(){
        public void execute(        Task task){
          Test test=(Test)task;
          List unmanagedClasspathFromTestCompile=((Compile)test.getProject().task(COMPILE_TESTS_TASK_NAME)).getUnmanagedClasspath();
          test.unmanagedClasspath(unmanagedClasspathFromTestCompile.toArray(new Object[unmanagedClasspathFromTestCompile.size()]));
        }
      }
);
    }
  }
);
  project.getTasks().add(TEST_TASK_NAME,Test.class).setDescription("Runs the tests.");
}
