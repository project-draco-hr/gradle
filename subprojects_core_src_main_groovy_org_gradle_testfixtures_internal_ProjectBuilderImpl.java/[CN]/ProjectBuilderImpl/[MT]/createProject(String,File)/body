{
  File projectDir=prepareProjectDir(inputProjectDir);
  final File homeDir=new File(projectDir,"gradleHome");
  StartParameter startParameter=new StartParameter();
  startParameter.setGradleUserHomeDir(new File(projectDir,"userHome"));
  ServiceRegistry topLevelRegistry=new TestBuildScopeServices(GLOBAL_SERVICES,startParameter,homeDir);
  GradleInternal gradle=new DefaultGradle(null,startParameter,topLevelRegistry.get(ServiceRegistryFactory.class));
  DefaultProjectDescriptor projectDescriptor=new DefaultProjectDescriptor(null,name,projectDir,new DefaultProjectDescriptorRegistry(),topLevelRegistry.get(FileResolver.class));
  ProjectInternal project=topLevelRegistry.get(IProjectFactory.class).createProject(projectDescriptor,null,gradle);
  gradle.setRootProject(project);
  gradle.setDefaultProject(project);
  gradle.getServices().get(BuildClassLoaderRegistry.class).addRootClassLoader(getClass().getClassLoader());
  return project;
}
