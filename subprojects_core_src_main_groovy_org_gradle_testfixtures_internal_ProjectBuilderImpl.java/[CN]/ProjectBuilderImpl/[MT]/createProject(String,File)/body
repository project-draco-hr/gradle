{
  File projectDir=prepareProjectDir(inputProjectDir);
  final File homeDir=new File(projectDir,"gradleHome");
  StartParameter startParameter=new StartParameter();
  startParameter.setGradleUserHomeDir(new File(projectDir,"userHome"));
  ServiceRegistry topLevelRegistry=new TestBuildScopeServices(GLOBAL_SERVICES,startParameter,homeDir);
  GradleInternal gradle=CLASS_GENERATOR.newInstance(DefaultGradle.class,null,startParameter,topLevelRegistry.get(ServiceRegistryFactory.class));
  DefaultProjectDescriptor projectDescriptor=new DefaultProjectDescriptor(null,name,projectDir,new DefaultProjectDescriptorRegistry(),topLevelRegistry.get(FileResolver.class));
  ClassLoaderScope baseScope=gradle.getClassLoaderScope();
  ClassLoaderScope rootProjectScope=baseScope.createChild();
  ProjectInternal project=topLevelRegistry.get(IProjectFactory.class).createProject(projectDescriptor,null,gradle,rootProjectScope,baseScope);
  gradle.setRootProject(project);
  gradle.setDefaultProject(project);
  return project;
}
