{
  File projectDir=prepareProjectDir(inputProjectDir);
  final File homeDir=new File(projectDir,"gradleHome");
  StartParameter startParameter=new StartParameter();
  startParameter.setGradleUserHomeDir(new File(projectDir,"userHome"));
  ServiceRegistryFactory topLevelRegistry=new TestBuildScopeServices(GLOBAL_SERVICES,startParameter,homeDir);
  GradleInternal gradle=new DefaultGradle(null,startParameter,topLevelRegistry);
  DefaultProjectDescriptor projectDescriptor=new DefaultProjectDescriptor(null,name,projectDir,new DefaultProjectDescriptorRegistry(),new BaseDirFileResolver(FileSystems.getDefault(),projectDir));
  ProjectInternal project=topLevelRegistry.get(IProjectFactory.class).createProject(projectDescriptor,null,gradle);
  gradle.setRootProject(project);
  gradle.setDefaultProject(project);
  gradle.getServices().get(BuildClassLoaderRegistry.class).addRootClassLoader(getClass().getClassLoader());
  return project;
}
