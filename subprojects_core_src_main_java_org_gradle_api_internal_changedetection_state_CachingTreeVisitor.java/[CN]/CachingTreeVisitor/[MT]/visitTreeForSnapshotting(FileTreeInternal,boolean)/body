{
  if (isDirectoryFileTree(fileTree)) {
    DirectoryFileTree directoryFileTree=DirectoryFileTree.class.cast(((FileTreeAdapter)fileTree).getTree());
    if (isEligibleForCaching(directoryFileTree)) {
      final String absolutePath=directoryFileTree.getDir().getAbsolutePath();
      VisitedTree cachedTree=allowReuse ? cachedTrees.getIfPresent(absolutePath) : null;
      if (cachedTree != null) {
        recordCacheHit(directoryFileTree);
        return cachedTree;
      }
 else {
        recordCacheMiss(directoryFileTree,allowReuse);
        cachedTree=doVisitTree(fileTree,true);
        cachedTrees.put(absolutePath,cachedTree);
        return cachedTree;
      }
    }
  }
  return doVisitTree(fileTree,false);
}
