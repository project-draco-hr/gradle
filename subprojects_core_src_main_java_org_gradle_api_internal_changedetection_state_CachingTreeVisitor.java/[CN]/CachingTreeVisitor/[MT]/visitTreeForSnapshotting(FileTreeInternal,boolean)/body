{
  if (isDirectoryFileTree(fileTree)) {
    DirectoryFileTree directoryFileTree=DirectoryFileTree.class.cast(((FileTreeAdapter)fileTree).getTree());
    final String absolutePath=directoryFileTree.getDir().getAbsolutePath();
    if (isCacheablePath(absolutePath)) {
      VisitedTreeCacheEntry cacheEntry=findOrCreateCacheEntry(absolutePath);
      cacheEntry.lock();
      try {
        VisitedTree cachedTree=null;
        if (cacheEntry != null) {
          if (allowReuse) {
            cachedTree=cacheEntry.get(directoryFileTree.getPatternSet());
          }
 else {
            cacheEntry.clear();
          }
        }
        if (cachedTree != null) {
          recordCacheHit(directoryFileTree);
          return cachedTree;
        }
 else {
          recordCacheMiss(directoryFileTree,allowReuse);
          cachedTree=doVisitTree(fileTree,true);
          cacheEntry.put(directoryFileTree.getPatternSet(),cachedTree);
          return cachedTree;
        }
      }
  finally {
        cacheEntry.unlock();
      }
    }
  }
  return doVisitTree(fileTree,false);
}
