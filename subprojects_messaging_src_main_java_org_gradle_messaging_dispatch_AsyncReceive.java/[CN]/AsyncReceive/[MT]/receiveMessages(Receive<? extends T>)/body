{
  while (true) {
    Dispatch<? super T> dispatch;
    lock.lock();
    try {
      while (dispatches.isEmpty() && state == State.Init) {
        try {
          condition.await();
        }
 catch (        InterruptedException e) {
          throw UncheckedException.throwAsUncheckedException(e);
        }
      }
      if (state != State.Init) {
        return;
      }
      dispatch=dispatches.remove(0);
    }
  finally {
      lock.unlock();
    }
    try {
      T message=receive.receive();
      if (message == null) {
        return;
      }
      dispatch.dispatch(message);
    }
  finally {
      lock.lock();
      try {
        dispatches.add(dispatch);
        condition.signalAll();
      }
  finally {
        lock.unlock();
      }
    }
  }
}
