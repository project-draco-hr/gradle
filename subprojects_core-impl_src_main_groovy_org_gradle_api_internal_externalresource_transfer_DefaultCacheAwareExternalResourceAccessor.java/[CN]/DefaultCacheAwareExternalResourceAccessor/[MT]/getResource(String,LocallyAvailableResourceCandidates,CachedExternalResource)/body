{
  LOGGER.debug("Constructing external resource: {}",source);
  if (cached == null && (localCandidates == null || localCandidates.isNone())) {
    return delegate.getResource(source);
  }
  final ExternalResourceMetaData remoteMetaData=delegate.getMetaData(source);
  if (remoteMetaData == null) {
    return null;
  }
  if (cached != null) {
    boolean isUnchanged=ExternalResourceMetaDataCompare.isDefinitelyUnchanged(cached.getExternalResourceMetaData(),new Factory<ExternalResourceMetaData>(){
      public ExternalResourceMetaData create(){
        return remoteMetaData;
      }
    }
);
    if (isUnchanged) {
      LOGGER.info("Cached resource is up-to-date (lastModified: {}). [HTTP: {}]",cached.getExternalLastModified(),source);
      return new CachedExternalResourceAdapter(source,cached,delegate);
    }
  }
  boolean hasLocalCandidates=localCandidates != null && !localCandidates.isNone();
  if (hasLocalCandidates) {
    HashValue remoteChecksum=remoteMetaData.getSha1();
    if (remoteChecksum == null) {
      remoteChecksum=delegate.getResourceSha1(source);
    }
    if (remoteChecksum != null) {
      LocallyAvailableResource local=localCandidates.findByHashValue(remoteChecksum);
      if (local != null) {
        LOGGER.info("Found locally available resource with matching checksum: [{}, {}]",source,local.getFile());
        return new LocallyAvailableExternalResource(source,local);
      }
    }
  }
  return delegate.getResource(source);
}
