{
  EndPointQueue selected=waiting.isEmpty() ? null : waiting.get(0);
  while (!queue.isEmpty()) {
    InterHubMessage message=queue.get(0);
switch (message.getDelivery()) {
case Stateful:
case AllHandlers:
      if (endpoints.isEmpty()) {
        return;
      }
    if (message.getDelivery() == InterHubMessage.Delivery.Stateful) {
      mostRecentStateful=message;
    }
  for (  EndPointQueue endpoint : endpoints) {
    endpoint.put(message);
  }
queue.remove(0);
waiting.clear();
continue;
case SingleHandler:
if (selected == null) {
return;
}
queue.remove(0);
waiting.remove(selected);
selected.put(message);
break;
default :
throw new IllegalArgumentException("Unknown delivery type: " + message.getDelivery());
}
}
}
