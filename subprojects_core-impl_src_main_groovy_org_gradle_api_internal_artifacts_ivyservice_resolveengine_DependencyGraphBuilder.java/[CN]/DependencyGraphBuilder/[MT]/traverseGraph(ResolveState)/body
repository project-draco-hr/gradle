{
  Set<ModuleId> conflicts=new LinkedHashSet<ModuleId>();
  resolveState.onMoreSelected(resolveState.root);
  List<DependencyEdge> dependencies=new ArrayList<DependencyEdge>();
  while (resolveState.peek() != null || !conflicts.isEmpty()) {
    if (resolveState.peek() != null) {
      ConfigurationNode node=resolveState.pop();
      System.out.println("=> Visiting configuration " + node);
      dependencies.clear();
      node.visitOutgoingDependencies(dependencies);
      for (      DependencyEdge dependency : dependencies) {
        System.out.println("* Visiting dependency " + dependency);
        dependency.resolveModuleRevisionId();
        DefaultModuleRevisionResolveState moduleRevision=dependency.getTargetModuleRevision();
        if (moduleRevision == null) {
          continue;
        }
        ModuleId moduleId=moduleRevision.id.getModuleId();
        if (moduleRevision.state == ModuleState.New) {
          Set<DefaultModuleRevisionResolveState> versions=resolveState.getRevisions(moduleId);
          if (versions.size() == 1) {
            System.out.println("  Selecting new module version " + moduleRevision);
            resolveState.select(moduleRevision);
          }
 else {
            System.out.println("  Found new conflicting module version " + moduleRevision);
            conflicts.add(moduleId);
            DefaultModuleRevisionResolveState previouslySelected=resolveState.clearSelection(moduleId);
            if (previouslySelected != null) {
              System.out.println("  Removing outgoing edges from " + previouslySelected);
              for (              ConfigurationNode configuration : previouslySelected.configurations) {
                System.out.println("  * removing " + configuration);
                configuration.removeOutgoingEdges();
              }
            }
          }
        }
        dependency.attachToTargetConfigurations();
      }
    }
 else {
      ModuleId moduleId=conflicts.iterator().next();
      conflicts.remove(moduleId);
      Set<DefaultModuleRevisionResolveState> candidates=resolveState.getRevisions(moduleId);
      DefaultModuleRevisionResolveState selected=conflictResolver.select(candidates,resolveState.root.moduleRevision);
      System.out.println("=> Selected " + selected + " from conflicting modules "+ candidates);
      resolveState.select(selected);
      for (      DefaultModuleRevisionResolveState candidate : candidates) {
        candidate.restart(selected);
      }
    }
  }
}
