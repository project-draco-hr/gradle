{
  allPlugins.add(pluginClass);
  if (pluginId == null) {
    for (    String unclaimedId : unclaimedIds) {
      if (pluginRegistry.hasId(pluginClass,unclaimedId)) {
        addPlugin(unclaimedId,pluginClass);
        return;
      }
    }
    for (    PluginWithId pluginWithId : pluginsWithIds) {
      if (pluginRegistry.hasId(pluginClass,pluginWithId.id)) {
        addPlugin(pluginWithId.id,pluginClass);
        return;
      }
    }
    noIdPlugins.add(pluginClass);
  }
 else {
    for (    PluginWithId plugin : pluginsWithIds) {
      if (plugin.id.equals(pluginId)) {
        throw new InvalidPluginException("Cannot apply plugin '" + pluginId + "' of type "+ pluginClass.getName()+ " as a plugin of type "+ plugin.clazz.getName()+ " has already been applied with this id");
      }
    }
    pluginsWithIds.add(new PluginWithId(pluginId,pluginClass));
  }
}
