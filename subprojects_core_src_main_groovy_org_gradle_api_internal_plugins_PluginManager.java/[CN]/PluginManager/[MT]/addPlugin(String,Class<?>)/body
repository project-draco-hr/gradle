{
  allPlugins.add(pluginClass);
  if (pluginId == null) {
    for (    String unclaimedId : unclaimedIds) {
      PotentialPluginWithId potentialPluginWithId=pluginRegistry.lookup(unclaimedId);
      if (potentialPluginWithId == null || !potentialPluginWithId.asClass().equals(pluginClass)) {
        potentialPluginWithId=pluginRegistry.lookup(unclaimedId,pluginClass.getClassLoader());
      }
      if (potentialPluginWithId != null && potentialPluginWithId.asClass().equals(pluginClass)) {
        addPlugin(unclaimedId,pluginClass);
        return;
      }
    }
    for (    PluginWithId pluginWithId : pluginsWithIds) {
      PotentialPluginWithId lookup=pluginRegistry.lookup(pluginWithId.id,pluginClass.getClassLoader());
      if (lookup != null && lookup.asClass().equals(pluginClass)) {
        addPlugin(pluginWithId.id,pluginClass);
        return;
      }
    }
    noIdPlugins.add(pluginClass);
  }
 else {
    for (    PluginWithId plugin : pluginsWithIds) {
      if (plugin.id.equals(pluginId)) {
        throw new InvalidPluginException("Cannot apply plugin '" + pluginId + "' of type "+ pluginClass.getName()+ " as a plugin of type "+ plugin.clazz.getName()+ " has already been applied with this id");
      }
    }
    pluginsWithIds.add(new PluginWithId(pluginId,pluginClass));
  }
}
