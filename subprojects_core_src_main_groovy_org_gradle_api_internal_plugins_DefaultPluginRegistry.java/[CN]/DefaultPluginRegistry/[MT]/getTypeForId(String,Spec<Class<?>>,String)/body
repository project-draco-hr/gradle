{
  if (parent != null) {
    try {
      return parent.getTypeForId(pluginId,classSpec,exceptionMessageFormat);
    }
 catch (    UnknownPluginException e) {
    }
  }
  Class<?> implClass=idMappings.get(pluginId);
  if (implClass != null) {
    if (!classSpec.isSatisfiedBy(implClass)) {
      throw new PluginInstantiationException(String.format(exceptionMessageFormat,implClass.getName(),pluginId));
    }
    return implClass;
  }
  ClassLoader classLoader=this.classLoaderFactory.create();
  PluginDescriptor pluginDescriptor=findPluginDescriptor(pluginId,classLoader);
  if (pluginDescriptor == null) {
    throw new UnknownPluginException("Plugin with id '" + pluginId + "' not found.");
  }
  String implClassName=pluginDescriptor.getImplementationClassName();
  if (!GUtil.isTrue(implClassName)) {
    throw new PluginInstantiationException(String.format("No implementation class specified for plugin '%s' in %s.",pluginId,pluginDescriptor));
  }
  try {
    implClass=classLoader.loadClass(implClassName);
    if (!classSpec.isSatisfiedBy(implClass)) {
      throw new PluginInstantiationException(String.format("%s Specified in %s.",String.format(exceptionMessageFormat,implClassName,pluginId),pluginDescriptor));
    }
  }
 catch (  ClassNotFoundException e) {
    throw new PluginInstantiationException(String.format("Could not find implementation class '%s' for plugin '%s' specified in %s.",implClassName,pluginId,pluginDescriptor),e);
  }
  idMappings.put(pluginId,implClass);
  return implClass;
}
