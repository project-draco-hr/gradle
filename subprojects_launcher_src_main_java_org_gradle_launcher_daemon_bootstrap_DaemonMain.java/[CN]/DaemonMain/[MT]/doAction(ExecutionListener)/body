{
  if (redirectIo) {
    try {
      redirectOutputsAndInput(startParameter);
    }
 catch (    IOException e) {
      listener.onFailure(e);
      return;
    }
  }
  final Long pid=new LenientEnvHacker().getPid();
  Runtime.getRuntime().addShutdownHook(new Thread(){
    public void run(){
      LOGGER.info("Daemon[pid = {}] finishing",pid);
    }
  }
);
  LoggingServiceRegistry loggingServices=LoggingServiceRegistry.newChildProcessLogging();
  DaemonServerConnector connector=new DaemonTcpServerConnector();
  File registryDir=startParameter.getGradleUserHomeDir();
  DaemonRegistry daemonRegistry=new PersistentDaemonRegistry(registryDir);
  int idleTimeout=getIdleTimeout(startParameter);
  float idleTimeoutSecs=idleTimeout / 1000;
  LOGGER.lifecycle("Starting daemon[pid = {}] with settings: idleTimeout = {} secs, registryDir = {}",pid,idleTimeoutSecs,registryDir);
  Daemon daemon=new Daemon(connector,daemonRegistry,new DefaultDaemonCommandExecuter(loggingServices));
  daemon.start();
  try {
    daemon.awaitIdleTimeout(idleTimeout);
    LOGGER.info("Daemon hit idle timeout (" + idleTimeoutSecs + " secs), stopping");
    daemon.stop();
  }
 catch (  DaemonStoppedException e) {
    LOGGER.info("Daemon stopping due to stop request");
    listener.onFailure(e);
  }
}
