{
  LoggingServiceRegistry loggingRegistry=LoggingServiceRegistry.newChildProcessLogging();
  LoggingManagerInternal loggingManager=loggingRegistry.getFactory(LoggingManagerInternal.class).create();
  DaemonServices daemonServices=new DaemonServices(daemonBaseDir,idleTimeoutMs,daemonUid,loggingRegistry,loggingManager);
  DaemonDir daemonDir=daemonServices.get(DaemonDir.class);
  final DaemonContext daemonContext=daemonServices.get(DaemonContext.class);
  if (redirectIo) {
    PrintStream log=createLogOutput(daemonDir,daemonContext);
    redirectOutputsAndInput(log);
    loggingRegistry.get(OutputEventRenderer.class).addStandardOutputAndError();
    loggingManager.setLevel(LogLevel.DEBUG);
  }
  loggingManager.start();
  Runtime.getRuntime().addShutdownHook(new Thread(){
    public void run(){
      LOGGER.info("Daemon[pid = {}] finishing",daemonContext.getPid());
    }
  }
);
  Daemon daemon=daemonServices.get(Daemon.class);
  daemon.start();
  try {
    daemon.awaitIdleTimeout(idleTimeoutMs);
    LOGGER.info("Daemon hit idle timeout (" + idleTimeoutMs + "ms), stopping");
    daemon.stop();
  }
 catch (  DaemonStoppedException e) {
    LOGGER.info("Daemon stopping due to stop request");
    listener.onFailure(e);
  }
}
