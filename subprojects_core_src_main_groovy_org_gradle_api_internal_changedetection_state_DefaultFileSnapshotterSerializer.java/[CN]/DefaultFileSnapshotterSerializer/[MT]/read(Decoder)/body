{
  Map<String,DefaultFileCollectionSnapshotter.IncrementalFileSnapshot> snapshots=new HashMap<String,DefaultFileCollectionSnapshotter.IncrementalFileSnapshot>();
  DefaultFileCollectionSnapshotter.FileCollectionSnapshotImpl snapshot=new DefaultFileCollectionSnapshotter.FileCollectionSnapshotImpl(snapshots);
  int snapshotsCount=decoder.readSmallInt();
  for (int i=0; i < snapshotsCount; i++) {
    String key=stringInterner.intern(decoder.readString());
    byte fileSnapshotKind=decoder.readByte();
    if (fileSnapshotKind == 1) {
      snapshots.put(key,new DefaultFileCollectionSnapshotter.DirSnapshot());
    }
 else     if (fileSnapshotKind == 2) {
      snapshots.put(key,new DefaultFileCollectionSnapshotter.MissingFileSnapshot());
    }
 else     if (fileSnapshotKind == 3) {
      byte hashSize=decoder.readByte();
      byte[] hash=new byte[hashSize];
      decoder.readBytes(hash);
      snapshots.put(key,new DefaultFileCollectionSnapshotter.FileHashSnapshot(hash));
    }
 else {
      throw new RuntimeException("Unable to read serialized file collection snapshot. Unrecognized value found in the data stream.");
    }
  }
  return snapshot;
}
