{
  try {
    ByteArrayOutputStream content=new ByteArrayOutputStream();
    ObjectOutputStream objectStream=new ObjectOutputStream(content){
      @Override protected void writeClassDescriptor(      ObjectStreamClass desc) throws IOException {
        Class<?> targetClass=desc.forClass();
        writeClass(targetClass);
      }
      @Override protected void annotateProxyClass(      Class<?> cl) throws IOException {
        writeInt(cl.getInterfaces().length);
        for (        Class<?> type : cl.getInterfaces()) {
          writeClass(type);
        }
      }
      private void writeClass(      Class<?> targetClass) throws IOException {
        writeClassLoader(targetClass);
        writeUTF(targetClass.getName());
      }
      private void writeClassLoader(      Class<?> targetClass) throws IOException {
        writeShort(map.getClassLoaderId(targetClass));
      }
    }
;
    objectStream.writeObject(payload);
    objectStream.close();
    return new SerializedPayload(map.getClassLoaders(),content.toByteArray());
  }
 catch (  IOException e) {
    throw UncheckedException.throwAsUncheckedException(e);
  }
}
