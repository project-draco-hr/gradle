{
  File canonicalDir=GFileUtils.canonicalise(cacheDir);
  CacheReferenceImpl cacheReference=caches.get(canonicalDir);
  if (cacheReference == null) {
    DefaultPersistentDirectoryCache cache=createCache(usage,properties,canonicalDir);
    cacheReference=new CacheReferenceImpl(cache,properties);
    caches.put(canonicalDir,cacheReference);
  }
 else {
    if (usage != CacheUsage.ON) {
      throw new IllegalStateException(String.format("Cannot rebuild cache '%s' as it is already open.",cacheDir));
    }
    if (!properties.equals(cacheReference.properties)) {
      throw new IllegalStateException(String.format("Cache '%s' is already open with different state.",cacheDir));
    }
  }
  cacheReference.addReference();
  return cacheReference;
}
