{
  File toolsJar=Jvm.current().getToolsJar();
  if (toolsJar != null) {
    final ClassLoader systemClassLoaderParent=ClassLoader.getSystemClassLoader().getParent();
    ClasspathUtil.addUrl((URLClassLoader)systemClassLoaderParent,new DefaultClassPath(toolsJar).getAsURLs());
  }
  ClassLoader runtimeClassLoader=getClass().getClassLoader();
  ClassPath coreImplClassPath=classPathRegistry.getClassPath("GRADLE_CORE_IMPL");
  coreImplClassLoader=new MutableURLClassLoader(runtimeClassLoader,coreImplClassPath);
  ClassPath pluginsClassPath=classPathRegistry.getClassPath("GRADLE_PLUGINS");
  ClassLoader pluginsImports=new CachingClassLoader(new MultiParentClassLoader(runtimeClassLoader,coreImplClassLoader));
  pluginsClassLoader=new MutableURLClassLoader(pluginsImports,pluginsClassPath);
  rootClassLoader=classLoaderFactory.createFilteringClassLoader(pluginsClassLoader);
  rootClassLoader.allowPackage("org.gradle");
  rootClassLoader.allowResources("META-INF/gradle-plugins");
  rootClassLoader.allowPackage("org.apache.tools.ant");
  rootClassLoader.allowPackage("groovy");
  rootClassLoader.allowPackage("org.codehaus.groovy");
  rootClassLoader.allowPackage("groovyjarjarantlr");
  rootClassLoader.allowPackage("org.apache.ivy");
  rootClassLoader.allowPackage("org.slf4j");
  rootClassLoader.allowPackage("org.apache.commons.logging");
  rootClassLoader.allowPackage("org.apache.log4j");
  rootClassLoader.allowPackage("javax.inject");
}
