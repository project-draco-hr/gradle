{
  final ScriptSource expectedScriptSource=new ImportsScriptSource(scriptSource,importsReader,rootDir);
  final Throwable failure=new RuntimeException();
  context.checking(new Expectations(){
{
      allowing(build).getProjectEvaluationBroadcaster();
      will(returnValue(listener));
    }
  }
);
  evaluator.projectsLoaded(build);
  context.checking(new Expectations(){
{
      one(listener).beforeEvaluate(project);
      one(scriptProcessor).createScript(with(Matchers.reflectionEquals(expectedScriptSource)),with(same(classLoader)),with(equal(ProjectScript.class)));
      will(returnValue(buildScript));
      one(projectScriptMetaData).applyMetaData(buildScript,project);
      one(project).setBuildScript(buildScript);
      one(standardOutputRedirector).on(LogLevel.QUIET);
      one(buildScript).run();
      will(throwException(failure));
      one(standardOutputRedirector).flush();
      one(listener).afterEvaluate(with(sameInstance(project)),with(notNullValue(Throwable.class)));
    }
  }
);
  try {
    evaluator.evaluate(project);
    fail();
  }
 catch (  GradleScriptException e) {
    assertThat(e.getOriginalMessage(),equalTo("A problem occurred evaluating " + project + "."));
    assertThat(e.getScriptSource(),sameInstance(scriptSource));
    assertThat(e.getCause(),sameInstance(failure));
  }
}
