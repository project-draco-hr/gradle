{
  TestFile dir=tmpDir.getTestDirectory().file("dir").createDir();
  final RuntimeException failure=new RuntimeException();
  context.checking(new Expectations(){
{
      oneOf(action).execute(with(notNullValue(PersistentCache.class)));
      will(throwException(failure));
    }
  }
);
  try {
    new DefaultPersistentDirectoryCache(dir,"<display-name>",validator,properties,mode(LockMode.Shared),action,lockManager).open();
    fail();
  }
 catch (  CacheOpenException e) {
    assertThat(e.getCause(),sameInstance((Throwable)failure));
  }
  context.checking(new Expectations(){
{
      oneOf(action).execute(with(notNullValue(PersistentCache.class)));
    }
  }
);
  DefaultPersistentDirectoryCache cache=new DefaultPersistentDirectoryCache(dir,"<display-name>",validator,properties,mode(LockMode.Shared),action,lockManager);
  try {
    cache.open();
    assertThat(loadProperties(dir.file("cache.properties")),equalTo(properties));
  }
  finally {
    cache.close();
  }
}
