{
  Throwable actualException=findMostRelevantCause(exception);
  if (actualException == null) {
    return exception;
  }
  if (actualException instanceof LocationAwareException) {
    return actualException;
  }
  ScriptSource source=null;
  Integer lineNumber=null;
  Throwable target=actualException;
  if (actualException instanceof ScriptCompilationException) {
    ScriptCompilationException scriptCompilationException=(ScriptCompilationException)actualException;
    source=scriptCompilationException.getScriptSource();
    lineNumber=scriptCompilationException.getLineNumber();
  }
  if (actualException instanceof ListenerNotificationException && actualException.getCause() != null) {
    target=actualException.getCause();
  }
  if (source == null) {
    for (Throwable currentException=actualException; currentException != null; currentException=currentException.getCause()) {
      for (      StackTraceElement element : currentException.getStackTrace()) {
        if (scripts.containsKey(element.getFileName())) {
          source=scripts.get(element.getFileName());
          lineNumber=element.getLineNumber() >= 0 ? element.getLineNumber() : null;
          break;
        }
      }
    }
  }
  return new LocationAwareException(actualException,target,source,lineNumber);
}
