{
  List<Task> finalisers=new ArrayList<Task>();
  List<Task> queue=new ArrayList<Task>(tasks);
  Collections.sort(queue);
  for (  Task task : queue) {
    addEntryTask(task);
  }
  Set<Task> visiting=new HashSet<Task>();
  CachingTaskDependencyResolveContext context=new CachingTaskDependencyResolveContext();
  while (!queue.isEmpty()) {
    Task task=queue.get(0);
    TaskInfo node=graph.addNode(task);
    if (node.getDependenciesProcessed()) {
      requireWithDependenciesIfOnlyFinalising(node);
      queue.remove(0);
      continue;
    }
    boolean filtered=!filter.isSatisfiedBy(task);
    if (filtered) {
      node.setRequired(false);
      queue.remove(0);
      continue;
    }
    if (visiting.add(task)) {
      if (node.isOnlyFinalising()) {
        finalisers.add(task);
      }
      Set<? extends Task> dependsOnTasks=context.getDependencies(task);
      for (      Task dependsOnTask : dependsOnTasks) {
        if (visiting.contains(dependsOnTask)) {
          continue;
        }
        queue.add(0,dependsOnTask);
      }
      for (      Task finaliserTask : task.getFinalisedBy().getDependencies(task)) {
        addFinaliserNodeToGraph(queue,finaliserTask).addSoftSuccessor(node);
      }
    }
 else {
      queue.remove(0);
      visiting.remove(task);
      if (finalisers.size() > 0) {
        node.shouldNotRun();
        finalisers.remove(task);
      }
 else {
        node.setRequired(true);
      }
      Set<? extends Task> dependencies=context.getDependencies(task);
      for (      Task dependency : dependencies) {
        graph.addHardEdge(node,dependency);
      }
      for (      Task mustRunAfter : task.getMustRunAfter().getDependencies(task)) {
        graph.addSoftEdge(node,mustRunAfter);
      }
      node.dependenciesProcessed();
    }
  }
}
