{
  final RuntimeException failure=new RuntimeException();
  ScriptRunner<Script> scriptRunner=factory.create(scriptMock);
  context.checking(new Expectations(){
{
      Sequence sequence=context.sequence("seq");
      one(scriptExecutionListenerMock).beforeScript(scriptMock);
      inSequence(sequence);
      one(standardOutputRedirectorMock).on(LogLevel.QUIET);
      inSequence(sequence);
      one(scriptMock).run();
      inSequence(sequence);
      will(throwException(failure));
      one(standardOutputRedirectorMock).flush();
      inSequence(sequence);
      one(standardOutputRedirectorMock).off();
      inSequence(sequence);
      one(scriptExecutionListenerMock).afterScript(with(sameInstance(scriptMock)),with(notNullValue(Throwable.class)));
      inSequence(sequence);
    }
  }
);
  ClassLoader originalClassLoader=Thread.currentThread().getContextClassLoader();
  assertThat(originalClassLoader,not(sameInstance(classLoaderDummy)));
  try {
    scriptRunner.run();
    fail();
  }
 catch (  GradleScriptException e) {
    assertThat(e.getOriginalMessage(),equalTo("A problem occurred evaluating <script-to-string>."));
    assertThat(e.getScriptSource(),sameInstance(scriptSourceDummy));
    assertThat(e.getCause(),sameInstance((Throwable)failure));
  }
  assertThat(Thread.currentThread().getContextClassLoader(),sameInstance(originalClassLoader));
}
