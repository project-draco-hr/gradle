{
  Configuration groovyConfiguration=project.getConfigurations().getByName(GROOVY_CONFIGURATION_NAME);
  if (!groovyConfiguration.getDependencies().isEmpty()) {
    return groovyConfiguration;
  }
  Matcher groovyJar=findGroovyJar(classpath);
  if (groovyJar == null) {
    return groovyConfiguration;
  }
  if (project.getRepositories().isEmpty()) {
    return project.files(groovyJar.group(0));
  }
  String notation="org.codehaus.groovy:" + groovyJar.group(1) + ":"+ groovyJar.group(2);
  if (groovyJar.group(3) != null) {
    notation+=":indy";
  }
  List<Dependency> dependencies=Lists.newArrayList();
  dependencies.add(project.getDependencies().create(notation));
  if (groovyJar.group(1).equals("groovy") && VersionNumber.parse(groovyJar.group(2)).getMajor() >= 2) {
    dependencies.add(project.getDependencies().create(notation.replace(":groovy:",":groovy-ant:")));
  }
  return project.getConfigurations().detachedConfiguration(dependencies.toArray(new Dependency[dependencies.size()]));
}
