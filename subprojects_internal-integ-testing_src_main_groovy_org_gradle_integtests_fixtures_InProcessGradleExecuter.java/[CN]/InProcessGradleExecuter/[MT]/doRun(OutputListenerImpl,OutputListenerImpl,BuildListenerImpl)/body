{
  InputStream originalStdIn=System.in;
  System.setIn(getStdin());
  File userDir=new File(System.getProperty("user.dir"));
  StartParameter parameter=new StartParameter();
  parameter.setLogLevel(LogLevel.INFO);
  parameter.setSearchUpwards(true);
  parameter.setCurrentDir(getWorkingDir());
  CommandLineParser parser=new CommandLineParser();
  DefaultCommandLineConverter converter=new DefaultCommandLineConverter();
  converter.configure(parser);
  converter.convert(parser.parse(getAllArgs()),parameter);
  Properties originalSysProperties=new Properties();
  originalSysProperties.putAll(System.getProperties());
  processEnvironment.maybeSetProcessDir(getWorkingDir());
  Map<String,String> previousEnv=new HashMap<String,String>();
  for (  Map.Entry<String,String> entry : getEnvironmentVars().entrySet()) {
    previousEnv.put(entry.getKey(),System.getenv(entry.getKey()));
    processEnvironment.maybeSetEnvironmentVariable(entry.getKey(),entry.getValue());
  }
  DefaultGradleLauncherFactory factory=(DefaultGradleLauncherFactory)GradleLauncher.getFactory();
  factory.addListener(listener);
  GradleLauncher gradleLauncher=GradleLauncher.newInstance(parameter);
  gradleLauncher.addStandardOutputListener(outputListener);
  gradleLauncher.addStandardErrorListener(errorListener);
  try {
    return gradleLauncher.run();
  }
  finally {
    System.setProperties(originalSysProperties);
    processEnvironment.maybeSetProcessDir(userDir);
    for (    Map.Entry<String,String> entry : previousEnv.entrySet()) {
      String oldValue=entry.getValue();
      if (oldValue != null) {
        processEnvironment.maybeSetEnvironmentVariable(entry.getKey(),oldValue);
      }
 else {
        processEnvironment.maybeRemoveEnvironmentVariable(entry.getKey());
      }
    }
    factory.removeListener(listener);
    System.setIn(originalStdIn);
  }
}
