{
  project.getPlugins().apply(PublishingPlugin.class);
  DefaultPublishingExtension extension=(DefaultPublishingExtension)project.getExtensions().getByType(PublishingExtension.class);
  Set<Configuration> visibleConfigurations=project.getConfigurations().matching(new Spec<Configuration>(){
    public boolean isSatisfiedBy(    Configuration configuration){
      return configuration.isVisible();
    }
  }
);
  PublicationContainer publications=extension.getPublications();
  publications.add(createPublication("main",project,visibleConfigurations));
  final BaseRepositoryFactory baseRepositoryFactory=dependencyResolutionServices.getBaseRepositoryFactory();
  PublicationRepositoryContainer repositories=extension.getRepositories();
  repositories.setFactory(new IvyArtifactRepositoryFactory(baseRepositoryFactory));
  new IvyPublishDynamicTaskCreator(project.getTasks(),new DefaultIvyPublishTaskNamer()).monitor(publications,repositories);
}
