{
  TestNG testNg=new TestNG();
  testNg.setOutputDirectory(testReportDir.getAbsolutePath());
  testNg.setDefaultSuiteName(options.getSuiteName());
  testNg.setDefaultTestName(options.getTestName());
  testNg.setAnnotations(options.getAnnotations());
  if (options.getJavadocAnnotations()) {
    testNg.setSourcePath(GUtil.join(options.getTestResources(),File.pathSeparator));
  }
  testNg.setUseDefaultListeners(options.getUseDefaultListeners());
  testNg.addListener(listener);
  testNg.setVerbose(0);
  testNg.setGroups(GUtil.join(options.getIncludeGroups(),","));
  testNg.setExcludedGroups(GUtil.join(options.getExcludeGroups(),","));
  for (  String listenerClass : options.getListeners()) {
    try {
      testNg.addListener(applicationClassLoader.loadClass(listenerClass).newInstance());
    }
 catch (    Throwable e) {
      throw new GradleException(String.format("Could not add a test listener with class '%s'.",listenerClass),e);
    }
  }
  if (!suiteFiles.isEmpty()) {
    testNg.setTestSuites(GFileUtils.toPaths(suiteFiles));
  }
 else {
    Class[] classes=testClasses.toArray(new Class[testClasses.size()]);
    testNg.setTestClasses(classes);
  }
  testNg.run();
}
