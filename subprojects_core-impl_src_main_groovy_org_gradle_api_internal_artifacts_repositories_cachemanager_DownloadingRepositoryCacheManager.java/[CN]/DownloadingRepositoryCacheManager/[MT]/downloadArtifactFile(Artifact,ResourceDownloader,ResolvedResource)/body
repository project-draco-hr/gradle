{
  final Resource resource=artifactRef.getResource();
  final File tmpFile=temporaryFileProvider.createTemporaryFile("gradle_download","bin");
  try {
    resourceDownloader.download(artifact,resource,tmpFile);
    return cacheLockingManager.useCache(String.format("Store %s",artifact),new Factory<File>(){
      public File create(){
        FileStoreEntry fileStoreEntry=fileStore.move(artifact.getId(),tmpFile);
        File fileInFileStore=fileStoreEntry.getFile();
        if (resource instanceof ExternalResource) {
          ExternalResource externalResource=(ExternalResource)resource;
          ExternalResourceMetaData metaData=externalResource.getMetaData();
          artifactUrlCachedResolutionIndex.store(metaData.getLocation(),fileInFileStore,metaData);
        }
        return fileInFileStore;
      }
    }
);
  }
  finally {
    tmpFile.delete();
  }
}
