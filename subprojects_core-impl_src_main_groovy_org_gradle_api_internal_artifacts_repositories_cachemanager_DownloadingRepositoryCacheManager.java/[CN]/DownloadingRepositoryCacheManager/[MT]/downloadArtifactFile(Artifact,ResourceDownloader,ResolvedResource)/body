{
  final Resource resource=artifactRef.getResource();
  FileStoreEntry fileStoreEntry=fileStore.add(artifact.getId(),new Action<File>(){
    public void execute(    File file){
      try {
        resourceDownloader.download(artifact,resource,file);
      }
 catch (      IOException e) {
        throw new UncheckedIOException(e);
      }
    }
  }
);
  final File fileInFileStore=fileStoreEntry.getFile();
  if (resource instanceof ExternalResource) {
    ExternalResource externalResource=(ExternalResource)resource;
    ExternalResourceMetaData metaData=externalResource.getMetaData();
    artifactUrlCachedResolutionIndex.store(metaData.getLocation(),fileInFileStore,metaData);
  }
  return fileInFileStore;
}
