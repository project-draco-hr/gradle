{
  final File tmpFile=temporaryFileProvider.createTemporaryFile("gradle_download","bin");
  try {
    resourceDownloader.download(artifact,resource,tmpFile);
    return cacheLockingManager.useCache(String.format("Store %s",artifact),new Factory<LocallyAvailableExternalResource>(){
      public LocallyAvailableExternalResource create(){
        LocallyAvailableResource cachedResource=fileStore.move(artifact.getId(),tmpFile);
        File fileInFileStore=cachedResource.getFile();
        ExternalResourceMetaData metaData=resource.getMetaData();
        artifactUrlCachedResolutionIndex.store(metaData.getLocation(),fileInFileStore,metaData);
        return new DefaultLocallyAvailableExternalResource(resource.getName(),cachedResource,metaData);
      }
    }
);
  }
  finally {
    tmpFile.delete();
  }
}
