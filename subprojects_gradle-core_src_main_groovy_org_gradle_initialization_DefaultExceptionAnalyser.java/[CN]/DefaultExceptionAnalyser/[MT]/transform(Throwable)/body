{
  Throwable actualException=findDeepest(exception);
  if (actualException == null) {
    return exception;
  }
  ScriptSource source=null;
  Integer lineNumber=null;
  if (actualException instanceof ScriptCompilationException) {
    ScriptCompilationException scriptCompilationException=(ScriptCompilationException)actualException;
    source=scriptCompilationException.getScriptSource();
    lineNumber=scriptCompilationException.getLineNumber();
  }
  if (source == null) {
    for (Throwable currentException=actualException; currentException != null; currentException=currentException.getCause()) {
      for (      StackTraceElement element : currentException.getStackTrace()) {
        if (scripts.containsKey(element.getFileName())) {
          source=scripts.get(element.getFileName());
          lineNumber=element.getLineNumber() >= 0 ? element.getLineNumber() : null;
          break;
        }
      }
    }
  }
  if (source == null) {
    if (actualException instanceof TaskExecutionException) {
      TaskExecutionException taskExecutionException=(TaskExecutionException)actualException;
      source=((ProjectInternal)taskExecutionException.getTask().getProject()).getBuildScriptSource();
    }
  }
  if (source == null) {
    return actualException;
  }
  return generator.newInstance(actualException.getClass(),actualException,source,lineNumber);
}
