{
  long expiry=monotonicClockMillis() + 20000;
synchronized (lock) {
    while (released && connected && !stopped) {
      long delay=expiry - monotonicClockMillis();
      if (delay <= 0) {
        throw new AssertionFailedError(String.format("Timeout waiting for client to disconnect from %s.",getUri()));
      }
      System.out.println("waiting for client to disconnect");
      try {
        lock.wait(delay);
      }
 catch (      InterruptedException e) {
        throw new RuntimeException(e);
      }
    }
    if (stopped) {
      throw new AssertionFailedError(String.format("Server was stopped while waiting for client to disconnect from %s.",getUri()));
    }
    System.out.println("client disconnected - unblocking");
  }
}
