{
  if (message instanceof ChannelMessage) {
    ChannelMessage channelMessage=(ChannelMessage)message;
    output.writeByte(1);
    writeChannelId(channelMessage);
    payloadWriter.write(channelMessage.getPayload());
  }
 else   if (message instanceof EndOfStream) {
    output.writeByte(2);
  }
 else {
    throw new IllegalArgumentException();
  }
  output.flush();
}
