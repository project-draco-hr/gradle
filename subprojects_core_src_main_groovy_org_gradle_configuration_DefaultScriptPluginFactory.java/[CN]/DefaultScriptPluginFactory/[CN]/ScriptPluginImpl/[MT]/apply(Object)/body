{
  final DefaultServiceRegistry services=new DefaultServiceRegistry();
  services.add(ScriptPluginFactory.class,DefaultScriptPluginFactory.this);
  services.add(ScriptHandlerFactory.class,scriptHandlerFactory);
  services.add(ClassLoaderScope.class,targetScope);
  services.add(LoggingManagerInternal.class,loggingManagerFactory.create());
  services.add(Instantiator.class,instantiator);
  services.add(ScriptHandler.class,scriptHandler);
  services.add(FileLookup.class,fileLookup);
  services.add(ModelRuleSourceDetector.class,modelRuleSourceDetector);
  final ScriptCompiler compiler=scriptCompilerFactory.createCompiler(scriptSource);
  boolean supportsPluginsBlock=ProjectScript.class.isAssignableFrom(scriptType);
  String onPluginBlockError=supportsPluginsBlock ? null : "Only Project build scripts can contain plugins {} blocks";
  PluginsAndBuildscriptTransformer scriptBlockTransformer=new PluginsAndBuildscriptTransformer(classpathClosureName,onPluginBlockError,scriptSource,documentationRegistry);
  StatementFilteringScriptTransformer classpathScriptTransformer=new StatementFilteringScriptTransformer(classpathClosureName,scriptBlockTransformer);
  PluginsAndBuildscriptMetadataExtractingTransformer extractingTransformer=new PluginsAndBuildscriptMetadataExtractingTransformer(scriptBlockTransformer,classpathScriptTransformer);
  ScriptRunner<? extends BasicScript,PluginRequests> classPathScriptRunner=compiler.compile(scriptType,extractingTransformer,baseScope.getExportClassLoader(),classpathClosureName,Actions.doNothing());
  classPathScriptRunner.getScript().init(target,services);
  classPathScriptRunner.run();
  PluginRequests pluginRequests=classPathScriptRunner.getCompiledScript().getMetadata();
  PluginManagerInternal pluginManager=target instanceof PluginAwareInternal ? ((PluginAwareInternal)target).getPluginManager() : null;
  pluginRequestApplicator.applyPlugins(pluginRequests,scriptHandler,pluginManager,targetScope);
  BuildScriptMetadataExtractingTransformer transformer=new BuildScriptMetadataExtractingTransformer(classpathScriptTransformer.getId(),classpathScriptTransformer.invert(),classpathClosureName,scriptSource);
  final ScriptRunner<? extends BasicScript,Boolean> runner=compiler.compile(scriptType,transformer,targetScope.getLocalClassLoader(),classpathClosureName,ClosureCreationInterceptingVerifier.INSTANCE);
  Runnable buildScriptRunner=new Runnable(){
    public void run(){
      BasicScript script=runner.getScript();
      script.init(target,services);
      if (ownerScript && target instanceof ScriptAware) {
        ((ScriptAware)target).setScript(script);
      }
      runner.run();
    }
  }
;
  if (!runner.getCompiledScript().getMetadata() && target instanceof ProjectInternal) {
    ((ProjectInternal)target).addModelRulesBlockRunner(buildScriptRunner);
  }
 else {
    buildScriptRunner.run();
  }
}
