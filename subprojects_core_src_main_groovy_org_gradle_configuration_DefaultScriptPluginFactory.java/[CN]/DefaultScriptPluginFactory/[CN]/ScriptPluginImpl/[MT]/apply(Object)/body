{
  DefaultServiceRegistry services=new DefaultServiceRegistry();
  services.add(ScriptPluginFactory.class,DefaultScriptPluginFactory.this);
  services.add(LoggingManagerInternal.class,loggingManagerFactory.create());
  services.add(Instantiator.class,instantiator);
  ScriptAware scriptAware=null;
  if (target instanceof ScriptAware) {
    scriptAware=(ScriptAware)target;
    scriptAware.beforeCompile(this);
  }
  ScriptClassLoaderProvider classLoaderProvider=this.classLoaderProvider;
  ScriptSource withImports=importsReader.withImports(scriptSource);
  if (classLoaderProvider == null) {
    ScriptHandlerInternal defaultScriptHandler=scriptHandlerFactory.create(withImports,parentScope);
    services.add(ScriptHandlerInternal.class,defaultScriptHandler);
    classLoaderProvider=defaultScriptHandler;
  }
  List<PluginRequest> pluginRequests=new LinkedList<PluginRequest>();
  if (target instanceof PluginAware) {
    services.add(PluginHandler.class,new DefaultPluginHandler(pluginRequests));
  }
 else {
    services.add(PluginHandler.class,new NonPluggableTargetPluginHandler(target));
  }
  ScriptCompiler compiler=scriptCompilerFactory.createCompiler(withImports);
  compiler.setClassloader(classLoaderProvider.getBaseCompilationClassLoader());
  PluginsAndBuildscriptTransformer scriptBlockTransformer=new PluginsAndBuildscriptTransformer(classpathClosureName);
  StatementExtractingScriptTransformer classpathScriptTransformer=new StatementExtractingScriptTransformer(classpathClosureName,scriptBlockTransformer);
  compiler.setTransformer(classpathScriptTransformer);
  ScriptRunner<? extends BasicScript> classPathScriptRunner=compiler.compile(scriptType);
  classPathScriptRunner.getScript().init(target,services);
  classPathScriptRunner.run();
  if (!pluginRequests.isEmpty()) {
    @SuppressWarnings("ConstantConditions") PluginResolutionApplicator resolutionApplicator=new PluginResolutionApplicator((PluginAware)target,pluginParentClassLoader,classLoaderProvider);
    PluginRequestApplicator requestApplicator=new PluginRequestApplicator(pluginResolver,resolutionApplicator);
    requestApplicator.applyPlugin(pluginRequests);
  }
  classLoaderProvider.updateClassPath();
  compiler.setClassloader(classLoaderProvider.getScriptCompileClassLoader());
  compiler.setTransformer(new BuildScriptTransformer("no_" + classpathScriptTransformer.getId(),classpathScriptTransformer.invert()));
  ScriptRunner<? extends BasicScript> runner=compiler.compile(scriptType);
  runner.getScript().init(target,services);
  if (scriptAware != null) {
    scriptAware.afterCompile(this,runner.getScript());
  }
  runner.run();
}
