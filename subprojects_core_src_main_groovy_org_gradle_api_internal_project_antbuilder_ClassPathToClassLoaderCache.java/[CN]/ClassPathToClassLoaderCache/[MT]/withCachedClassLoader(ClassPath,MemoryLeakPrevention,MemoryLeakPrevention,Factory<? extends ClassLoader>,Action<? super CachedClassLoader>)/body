{
  String key=toCacheKey(libClasspath);
  lock.readLock().lock();
  CacheEntry cacheEntry=cacheEntries.get(key);
  CachedClassLoader cachedClassLoader=maybeGet(cacheEntry);
  if (cacheEntry == null || cachedClassLoader == null) {
    lock.readLock().unlock();
    lock.writeLock().lock();
    try {
      cacheEntry=cacheEntries.get(key);
      cachedClassLoader=maybeGet(cacheEntry);
      if (cacheEntry == null || cachedClassLoader == null) {
        ClassLoader classLoader=factory.create();
        cachedClassLoader=new CachedClassLoader(key,classLoader);
        cacheEntry=new CacheEntry(key,cachedClassLoader);
        Cleanup cleanup=new Cleanup(key,libClasspath,cachedClassLoader,finalizerThread.getReferenceQueue(),classLoader,gradleToIsolatedLeakPrevention,antToGradleLeakPrevention);
        finalizerThread.putCleanup(key,cleanup);
        cacheEntries.put(key,cacheEntry);
      }
      lock.readLock().lock();
    }
  finally {
      lock.writeLock().unlock();
    }
  }
  lock.readLock().unlock();
  action.execute(cachedClassLoader);
}
