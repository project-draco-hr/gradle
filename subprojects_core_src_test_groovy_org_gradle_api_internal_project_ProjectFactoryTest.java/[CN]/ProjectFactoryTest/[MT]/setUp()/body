{
  startParameterStub.setGradleUserHomeDir(testDir.createDir("home"));
  context.checking(new Expectations(){
{
      allowing(repositoryHandlerFactory).create();
      will(returnValue(repositoryHandler));
    }
  }
);
  final ServiceRegistryFactory gradleServices=serviceRegistryFactory.createFor(gradle);
  context.checking(new Expectations(){
{
      allowing(gradle).getServices();
      will(returnValue(gradleServices));
      allowing(gradle).getStartParameter();
      will(returnValue(startParameterStub));
      allowing(gradle).getProjectRegistry();
      will(returnValue(gradleServices.get(IProjectRegistry.class)));
      allowing(gradle).getScriptClassLoader();
      will(returnValue(buildScriptClassLoader));
      allowing(gradle).getGradleUserHomeDir();
      will(returnValue(new File("gradleUserHomeDir")));
      ignoring(gradle).getProjectEvaluationBroadcaster();
    }
  }
);
  projectFactory=new ProjectFactory(null,classGeneratorMock);
}
