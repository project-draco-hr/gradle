{
  if (fromCache) {
    TestDescriptor cachedTestDescriptor=this.testDescriptorCache.get(testDescriptor.getId());
    if (cachedTestDescriptor == null) {
      throw new IllegalStateException(String.format("Test descriptor %s not available.",testDescriptor.getId()));
    }
 else {
      return cachedTestDescriptor;
    }
  }
 else {
    TestDescriptor cachedTestDescriptor=this.testDescriptorCache.get(testDescriptor.getId());
    if (cachedTestDescriptor != null) {
      throw new IllegalStateException(String.format("Test descriptor %s already available.",testDescriptor.getId()));
    }
 else {
      final TestDescriptor parent=getParentTestDescriptor(testDescriptor);
      TestDescriptor newTestDescriptor=new TestDescriptor(){
        @Override public String getName(){
          return testDescriptor.getName();
        }
        @Override public String getClassName(){
          return testDescriptor.getClassName();
        }
        @Override public TestDescriptor getParent(){
          return parent;
        }
      }
;
      testDescriptorCache.put(testDescriptor.getId(),newTestDescriptor);
      return newTestDescriptor;
    }
  }
}
