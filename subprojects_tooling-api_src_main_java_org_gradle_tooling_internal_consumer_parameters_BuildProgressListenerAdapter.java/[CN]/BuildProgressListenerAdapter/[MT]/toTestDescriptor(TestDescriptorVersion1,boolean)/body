{
  if (fromCache) {
    TestDescriptor cachedTestDescriptor=this.testDescriptorCache.get(testDescriptor.getId());
    if (cachedTestDescriptor == null) {
      throw new IllegalStateException(String.format("%s not available.",toString(testDescriptor)));
    }
 else {
      this.testDescriptorCache.remove(testDescriptor.getId());
      return cachedTestDescriptor;
    }
  }
 else {
    TestDescriptor cachedTestDescriptor=this.testDescriptorCache.get(testDescriptor.getId());
    if (cachedTestDescriptor != null) {
      throw new IllegalStateException(String.format("%s already available.",toString(testDescriptor)));
    }
 else {
      final TestDescriptor parent=getParentTestDescriptor(testDescriptor);
      TestDescriptor newTestDescriptor=new TestDescriptor(){
        @Override public String getName(){
          return testDescriptor.getName();
        }
        @Override public String getClassName(){
          return testDescriptor.getClassName();
        }
        @Override public TestDescriptor getParent(){
          return parent;
        }
      }
;
      testDescriptorCache.put(testDescriptor.getId(),newTestDescriptor);
      return newTestDescriptor;
    }
  }
}
