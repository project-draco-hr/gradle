{
  LOGGER.debug("Resolving {}",resolveContext);
  ivyContextManager.withIvy(new Action<Ivy>(){
    public void execute(    Ivy ivy){
      ResolutionStrategyInternal resolutionStrategy;
      if (resolveContext instanceof ConfigurationInternal) {
        resolutionStrategy=((ConfigurationInternal)resolveContext).getResolutionStrategy();
      }
 else {
        resolutionStrategy=new DefaultResolutionStrategy();
      }
      ResolverProvider resolverProvider=ivyFactory.create(resolutionStrategy,repositories,metadataHandler.getComponentMetadataProcessor());
      List<LocalComponentFactory> localComponentFactories=allServices(LocalComponentFactory.class);
      List<DependencyToComponentIdResolver> componentIdResolvers=allServices(DependencyToComponentIdResolver.class);
      List<ComponentMetaDataResolver> metaDataResolvers=allServices(ComponentMetaDataResolver.class);
      componentIdResolvers.add(resolverProvider.getComponentIdResolver());
      metaDataResolvers.add(new ClientModuleResolver(resolverProvider.getComponentResolver(),dependencyDescriptorFactory));
      LocalComponentFactoryChain localComponentFactory=new LocalComponentFactoryChain(localComponentFactories);
      ComponentMetaDataResolverChain metaDataResolver=new ComponentMetaDataResolverChain(metaDataResolvers);
      DependencyToComponentIdResolverChain componentIdResolver=new DependencyToComponentIdResolverChain(componentIdResolvers);
      DependencyToComponentIdResolver idResolver=new DependencySubstitutionResolver(componentIdResolver,resolutionStrategy.getDependencySubstitutionRule());
      ArtifactResolver artifactResolver=createArtifactResolver(resolverProvider);
      ModuleConflictResolver conflictResolver;
      if (resolutionStrategy.getConflictResolution() instanceof StrictConflictResolution) {
        conflictResolver=new StrictConflictResolver();
      }
 else {
        conflictResolver=new LatestModuleConflictResolver(versionComparator);
      }
      conflictResolver=new VersionSelectionReasonResolver(conflictResolver);
      ConflictHandler conflictHandler=new DefaultConflictHandler(conflictResolver,metadataHandler.getModuleMetadataProcessor().getModuleReplacements());
      DefaultResolveContextToComponentResolver moduleResolver=new DefaultResolveContextToComponentResolver(localComponentFactory);
      DependencyGraphBuilder builder=new DependencyGraphBuilder(idResolver,metaDataResolver,moduleResolver,artifactResolver,conflictHandler,new DefaultDependencyToConfigurationResolver());
      StoreSet stores=storeFactory.createStoreSet();
      BinaryStore newModelStore=stores.nextBinaryStore();
      Store<ResolvedComponentResult> newModelCache=stores.oldModelStore();
      ResolutionResultBuilder newModelBuilder=new StreamingResolutionResultBuilder(newModelStore,newModelCache);
      BinaryStore oldModelStore=stores.nextBinaryStore();
      Store<TransientConfigurationResults> oldModelCache=stores.newModelStore();
      TransientConfigurationResultsBuilder oldTransientModelBuilder=new TransientConfigurationResultsBuilder(oldModelStore,oldModelCache);
      DefaultResolvedConfigurationBuilder oldModelBuilder=new DefaultResolvedConfigurationBuilder(oldTransientModelBuilder);
      DefaultResolvedArtifactsBuilder artifactsBuilder=new DefaultResolvedArtifactsBuilder();
      ResolvedProjectConfigurationResultBuilder projectModelBuilder=new DefaultResolvedProjectConfigurationResultBuilder(buildProjectDependencies);
      builder.resolve(resolveContext,newModelBuilder,oldModelBuilder,artifactsBuilder,projectModelBuilder);
      results.resolved(newModelBuilder.complete(),projectModelBuilder.complete());
      ResolvedGraphResults graphResults=oldModelBuilder.complete();
      results.retainState(graphResults,artifactsBuilder,oldTransientModelBuilder);
    }
  }
);
}
