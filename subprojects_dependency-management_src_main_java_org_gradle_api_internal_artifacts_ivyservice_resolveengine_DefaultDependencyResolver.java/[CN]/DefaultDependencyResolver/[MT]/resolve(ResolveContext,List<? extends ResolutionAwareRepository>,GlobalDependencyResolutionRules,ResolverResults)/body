{
  LOGGER.debug("Resolving {}",resolveContext);
  ivyContextManager.withIvy(new Action<Ivy>(){
    public void execute(    Ivy ivy){
      ResolutionStrategyInternal resolutionStrategy=(ResolutionStrategyInternal)resolveContext.getResolutionStrategy();
      List<LocalComponentFactory> localComponentFactories=allServices(LocalComponentFactory.class);
      List<ResolverProvider> resolvers=allServices(ResolverProvider.class,ivyFactory.create(resolutionStrategy,repositories,metadataHandler.getComponentMetadataProcessor()));
      ResolverProviderChain resolverProvider=new ResolverProviderChain(resolvers);
      WrappingResolverProvider wrappingProvider=new WrappingResolverProvider(new DependencySubstitutionResolver(resolverProvider.getComponentIdResolver(),resolutionStrategy.getDependencySubstitutionRule()),new ClientModuleResolver(resolverProvider.getComponentResolver(),dependencyDescriptorFactory),createArtifactResolver(resolverProvider.getArtifactResolver()));
      ModuleConflictResolver conflictResolver;
      if (resolutionStrategy.getConflictResolution() instanceof StrictConflictResolution) {
        conflictResolver=new StrictConflictResolver();
      }
 else {
        conflictResolver=new LatestModuleConflictResolver(versionComparator);
      }
      conflictResolver=new VersionSelectionReasonResolver(conflictResolver);
      ConflictHandler conflictHandler=new DefaultConflictHandler(conflictResolver,metadataHandler.getModuleMetadataProcessor().getModuleReplacements());
      DefaultResolveContextToComponentResolver moduleResolver=new DefaultResolveContextToComponentResolver(new LocalComponentFactoryChain(localComponentFactories));
      DependencyGraphBuilder builder=new DependencyGraphBuilder(wrappingProvider,moduleResolver,conflictHandler,new DefaultDependencyToConfigurationResolver());
      StoreSet stores=storeFactory.createStoreSet();
      BinaryStore newModelStore=stores.nextBinaryStore();
      Store<ResolvedComponentResult> newModelCache=stores.oldModelStore();
      ResolutionResultBuilder newModelBuilder=new StreamingResolutionResultBuilder(newModelStore,newModelCache);
      BinaryStore oldModelStore=stores.nextBinaryStore();
      Store<TransientConfigurationResults> oldModelCache=stores.newModelStore();
      TransientConfigurationResultsBuilder oldTransientModelBuilder=new TransientConfigurationResultsBuilder(oldModelStore,oldModelCache);
      DefaultResolvedConfigurationBuilder oldModelBuilder=new DefaultResolvedConfigurationBuilder(oldTransientModelBuilder);
      DefaultResolvedArtifactsBuilder artifactsBuilder=new DefaultResolvedArtifactsBuilder();
      ResolvedProjectConfigurationResultBuilder projectModelBuilder=new DefaultResolvedProjectConfigurationResultBuilder(buildProjectDependencies);
      builder.resolve(resolveContext,newModelBuilder,oldModelBuilder,artifactsBuilder,projectModelBuilder);
      results.resolved(newModelBuilder.complete(),projectModelBuilder.complete());
      ResolvedGraphResults graphResults=oldModelBuilder.complete();
      results.retainState(graphResults,artifactsBuilder,oldTransientModelBuilder);
    }
  }
);
}
