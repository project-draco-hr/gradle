{
  LOGGER.debug("Blocking {} until {}",Thread.currentThread(),tick);
  lock.lock();
  try {
    if (tick != currentTick + 1) {
      throw new RuntimeException(String.format("Cannot block until tick %d, as clock is currently at %s.",tick,currentTick));
    }
    Date expiry=new Date(System.currentTimeMillis() + MAX_WAIT_TIME);
    while (currentTick != tick) {
      try {
        boolean signalled=clockChanged.awaitUntil(expiry);
        if (!signalled) {
          throw new RuntimeException(String.format("Timeout waiting for all threads to reach tick %d. Currently at %d.",tick,currentTick));
        }
      }
 catch (      InterruptedException e) {
        throw new RuntimeException(e);
      }
    }
    clockChanged.signalAll();
  }
  finally {
    lock.unlock();
  }
  LOGGER.debug("Block {} done",Thread.currentThread());
}
