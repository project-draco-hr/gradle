{
  final Throwable failure=new RuntimeException("failure");
  context.checking(new Expectations(){
{
      allowing(task).getActions();
      will(returnValue(toList(action1,action2)));
      one(listener).beforeActions(task);
      inSequence(sequence);
      one(standardOutputCapture).start();
      inSequence(sequence);
      one(action1).execute(task);
      will(throwException(failure));
      inSequence(sequence);
      one(standardOutputCapture).stop();
      inSequence(sequence);
      one(listener).afterActions(task);
      inSequence(sequence);
    }
  }
);
  TaskExecutionResult result=executer.execute(task,state);
  assertThat(result.getFailure(),instanceOf(TaskExecutionException.class));
  TaskExecutionException exception=(TaskExecutionException)result.getFailure();
  assertThat(exception.getTask(),equalTo((Task)task));
  assertThat(exception.getMessage(),equalTo("Execution failed for <task>."));
  assertThat(exception.getCause(),sameInstance(failure));
  assertThat(result.getSkipMessage(),nullValue());
  assertFalse(state.isExecuting());
  assertTrue(state.isDidWork());
}
