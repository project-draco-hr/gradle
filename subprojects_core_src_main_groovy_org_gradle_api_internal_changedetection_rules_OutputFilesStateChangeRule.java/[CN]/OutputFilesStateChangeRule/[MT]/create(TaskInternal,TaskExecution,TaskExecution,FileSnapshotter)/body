{
  final FileCollectionSnapshot outputFilesBefore=outputFilesSnapshotter.snapshot(task.getOutputs().getFiles());
  return new TaskStateChanges(){
    public void findChanges(    final UpToDateChangeListener listener){
      if (previousExecution.getOutputFilesSnapshot() == null) {
        if (listener.isAccepting()) {
          listener.accept(new DescriptiveChange("Output file history is not available for %s.",task));
        }
        return;
      }
      outputFilesBefore.changesSince(previousExecution.getOutputFilesSnapshot(),new FileCollectionSnapshot.SnapshotChangeListener(){
        public void added(        String element){
          accept(new OutputFileChange(element,ChangeType.ADDED));
        }
        public void changed(        String element){
          accept(new OutputFileChange(element,ChangeType.MODIFIED));
        }
        public void removed(        String element){
          accept(new OutputFileChange(element,ChangeType.REMOVED));
        }
        public String getResumeAfter(){
          return null;
        }
        public boolean isStopped(){
          return !listener.isAccepting();
        }
        private void accept(        OutputFileChange change){
          listener.accept(change);
        }
      }
);
    }
    public void snapshotAfterTask(){
      FileCollectionSnapshot lastExecutionOutputFiles;
      if (previousExecution == null || previousExecution.getOutputFilesSnapshot() == null) {
        lastExecutionOutputFiles=outputFilesSnapshotter.emptySnapshot();
      }
 else {
        lastExecutionOutputFiles=previousExecution.getOutputFilesSnapshot();
      }
      FileCollectionSnapshot newOutputFiles=outputFilesBefore.changesSince(lastExecutionOutputFiles).applyTo(lastExecutionOutputFiles,new ChangeListener<FileCollectionSnapshot.Merge>(){
        public void added(        FileCollectionSnapshot.Merge element){
          element.ignore();
        }
        public void removed(        FileCollectionSnapshot.Merge element){
        }
        public void changed(        FileCollectionSnapshot.Merge element){
        }
      }
);
      FileCollectionSnapshot outputFilesAfter=outputFilesSnapshotter.snapshot(task.getOutputs().getFiles());
      currentExecution.setOutputFilesSnapshot(outputFilesAfter.changesSince(outputFilesBefore).applyTo(newOutputFiles));
    }
  }
;
}
