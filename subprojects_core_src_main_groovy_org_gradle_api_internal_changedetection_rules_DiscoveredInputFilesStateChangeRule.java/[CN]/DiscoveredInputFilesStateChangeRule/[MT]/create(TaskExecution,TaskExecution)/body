{
  return new DiscoveredTaskStateChanges(){
    private final Collection<File> discoveredFiles=Sets.newHashSet();
    public Iterator<TaskStateChange> iterator(){
      final FileCollectionSnapshot stateAfterPreviousExecution=previousExecution.getDiscoveredInputFilesSnapshot();
      if (stateAfterPreviousExecution == null) {
        return Collections.<TaskStateChange>singleton(new DescriptiveChange(DISCOVERED_INPUT_FILE_TYPE + " file history is not available.")).iterator();
      }
      final FileCollectionSnapshot stateBeforeCurrentExecution=inputFilesSnapshotter.snapshot(fileCollectionFactory.fixed("Discovered input files",stateAfterPreviousExecution.getFiles()));
      return new AbstractIterator<TaskStateChange>(){
        final FileCollectionSnapshot.ChangeIterator<String> changeIterator=stateBeforeCurrentExecution.iterateChangesSince(stateAfterPreviousExecution);
        final ChangeListenerAdapter listenerAdapter=new ChangeListenerAdapter();
        @Override protected TaskStateChange computeNext(){
          if (changeIterator.next(listenerAdapter)) {
            return listenerAdapter.lastChange;
          }
          return endOfData();
        }
      }
;
    }
    @Override public void newInputs(    Set<File> files){
      discoveredFiles.clear();
      discoveredFiles.addAll(files);
    }
    public void snapshotAfterTask(){
      currentExecution.setDiscoveredInputFilesSnapshot(inputFilesSnapshotter.snapshot(fileCollectionFactory.fixed("Discovered input files",discoveredFiles)));
    }
  }
;
}
