{
  String proxyScheme="https";
  HttpProxySettings.HttpProxy proxy=httpSettings.getSecureProxySettings().getProxy();
  if (proxy == null) {
    proxy=httpSettings.getProxySettings().getProxy();
    proxyScheme="http";
  }
  if (proxy != null) {
    if (proxy.credentials != null) {
      useCredentials(credentialsProvider,proxy.host,proxy.port,Collections.singleton(new AllSchemesAuthentication(proxy.credentials)));
    }
    builder.setProxy(new HttpHost(proxy.host,proxy.port,proxyScheme));
  }
}
