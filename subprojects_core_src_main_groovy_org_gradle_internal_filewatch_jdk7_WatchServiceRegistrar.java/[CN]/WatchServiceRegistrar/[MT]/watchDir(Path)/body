{
  LOG.debug("Registering watch for {}",dir);
  int retryCount=0;
  IOException lastException=null;
  while (retryCount++ < 2) {
    try {
      dir.register(watchService,WATCH_KINDS,WATCH_MODIFIERS);
      return;
    }
 catch (    IOException e) {
      LOG.debug("Exception in registering for watching of " + dir,e);
      lastException=e;
      if (e instanceof FileSystemException && e.getMessage() != null && e.getMessage().contains("Bad file descriptor")) {
        LOG.debug("Retrying after 'Bad file descriptor'");
        continue;
      }
      if (!Files.exists(dir)) {
        LOG.debug("Return silently since directory doesn't exist.");
        return;
      }
 else {
        throw e;
      }
    }
  }
  LOG.debug("Retry count exceeded, throwing last exception");
  throw lastException;
}
