{
  final ProjectInternal projectInternal=(ProjectInternal)project;
  project.getConvention().getPlugin(JavaPluginConvention.class).getSource().allObjects(new Action<SourceSet>(){
    public void execute(    SourceSet sourceSet){
      final DefaultGroovySourceSet groovySourceSet=new DefaultGroovySourceSet(((DefaultSourceSet)sourceSet).getDisplayName(),projectInternal.getFileResolver());
      ((DynamicObjectAware)sourceSet).getConvention().getPlugins().put("groovy",groovySourceSet);
      groovySourceSet.getGroovy().srcDir(String.format("src/%s/groovy",sourceSet.getName()));
      sourceSet.getResources().getFilter().exclude("**/*.groovy");
      sourceSet.getAllJava().add(groovySourceSet.getGroovy().matching(sourceSet.getJava().getFilter()));
      sourceSet.getAllSource().add(groovySourceSet.getGroovy());
      String compileTaskName=String.format("%sGroovy",sourceSet.getCompileTaskName());
      GroovyCompile compile=project.getTasks().add(compileTaskName,GroovyCompile.class);
      javaPlugin.configureForSourceSet(sourceSet,compile);
      compile.dependsOn(sourceSet.getCompileJavaTaskName());
      compile.setDescription(String.format("Compiles the %s Groovy source.",sourceSet.getName()));
      compile.conventionMapping("src",new ConventionValue(){
        public Object getValue(        Convention convention,        IConventionAware conventionAwareObject){
          return groovySourceSet.getGroovy();
        }
      }
);
      project.getTasks().getByName(sourceSet.getCompileTaskName()).dependsOn(compileTaskName);
    }
  }
);
}
