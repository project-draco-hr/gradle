{
  final ScriptSource expectedScriptSource=new ImportsScriptSource(scriptSource,importsReader,rootDir);
  context.checking(new Expectations(){
{
      one(scriptCompilerFactory).createCompiler(with(reflectionEquals(expectedScriptSource)));
      will(returnValue(compiler));
      one(classLoaderProvider).getClassLoader();
      will(returnValue(classLoader));
      one(compiler).setClassloader(classLoader);
      one(compiler).setTransformer(with(notNullValue(BuildScriptClasspathScriptTransformer.class)));
      one(compiler).compile(ProjectScript.class);
      will(returnValue(classpathScriptRunner));
      one(classpathScriptRunner).setDelegate(project);
      one(classpathScriptRunner).run();
      one(classLoaderProvider).updateClassPath();
      one(compiler).setTransformer(with(notNullValue(BuildScriptTransformer.class)));
      one(compiler).compile(ProjectScript.class);
      will(returnValue(buildScriptRunner));
      one(buildScriptRunner).setDelegate(project);
      one(buildScriptRunner).getScript();
      will(returnValue(buildScript));
      one(project).setScript(buildScript);
      one(buildScriptRunner).run();
    }
  }
);
  evaluator.evaluate(project);
}
