{
  VersionDetails version=new VersionDetails(connection.getMetaData().getVersion());
  if (type == InternalBuildEnvironment.class && !version.supportsCompleteBuildEnvironment()) {
    VersionOnlyBuildEnvironment out=new VersionOnlyBuildEnvironment(connection.getMetaData().getVersion());
    return type.cast(out);
  }
  if (version.clientHangsOnEarlyDaemonFailure()) {
    if (version.isPostM6Model(type)) {
      String message=String.format("I don't know how to build a model of type '%s'.",type.getSimpleName());
      throw new UnsupportedOperationException(message);
    }
  }
  return connection.getModel(type,operationParameters);
}
