{
  context.setImposteriser(ClassImposteriser.INSTANCE);
  HelperUtil.deleteTestDir();
  settingsHandlerMock=context.mock(SettingsHandler.class);
  gradlePropertiesLoaderMock=context.mock(IGradlePropertiesLoader.class);
  settingsMock=context.mock(SettingsInternal.class);
  taskExecuterMock=context.mock(TaskExecuter.class);
  buildLoaderMock=context.mock(BuildLoader.class);
  buildConfigurerMock=context.mock(BuildConfigurer.class);
  buildMock=context.mock(BuildInternal.class);
  buildBroadcaster=context.mock(BuildListener.class);
  testGradleProperties=WrapUtil.toMap("prop1","value1");
  boolean expectedSearchUpwards=false;
  expectedClassLoader=new URLClassLoader(new URL[0]);
  File expectedRootDir=new File("rootDir");
  File expectedCurrentDir=new File(expectedRootDir,"currentDir");
  expectedRootProjectDescriptor=new DefaultProjectDescriptor(null,"someName",new File("somedir"),new DefaultProjectDescriptorRegistry());
  expectedRootProject=HelperUtil.createRootProject(expectedRootDir);
  expectedCurrentProject=HelperUtil.createRootProject(expectedCurrentDir);
  expectTasks("a","b");
  expectedStartParams=new StartParameter();
  expectedStartParams.setTaskNames(expectedTaskNames);
  expectedStartParams.setCurrentDir(expectedCurrentDir);
  expectedStartParams.setSearchUpwards(expectedSearchUpwards);
  expectedStartParams.setGradleUserHomeDir(new File(HelperUtil.TMP_DIR_FOR_TEST,"gradleUserHomeDir"));
  gradle=new Gradle(buildMock,settingsHandlerMock,gradlePropertiesLoaderMock,buildLoaderMock,buildConfigurerMock);
  context.checking(new Expectations(){
{
      allowing(gradlePropertiesLoaderMock).getGradleProperties();
      will(returnValue(testGradleProperties));
      allowing(settingsMock).createClassLoader();
      will(returnValue(expectedClassLoader));
      allowing(settingsMock).getRootProject();
      will(returnValue(expectedRootProjectDescriptor));
      allowing(buildMock).getRootProject();
      will(returnValue(expectedRootProject));
      allowing(buildMock).getDefaultProject();
      will(returnValue(expectedCurrentProject));
      allowing(buildMock).getTaskGraph();
      will(returnValue(taskExecuterMock));
      allowing(buildMock).getStartParameter();
      will(returnValue(expectedStartParams));
      allowing(buildMock).getBuildListenerBroadcaster();
      will(returnValue(buildBroadcaster));
    }
  }
);
}
