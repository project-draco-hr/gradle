{
  if (commandLine.hasOption(HELP)) {
    return new ActionAdapter(new ShowUsageAction(parser));
  }
  if (commandLine.hasOption(VERSION)) {
    return new ActionAdapter(new ShowVersionAction());
  }
  if (commandLine.hasOption(GUI)) {
    return new ActionAdapter(new ShowGuiAction());
  }
  final StartParameter startParameter=new StartParameter();
  startParameterConverter.convert(commandLine,startParameter);
  int idleTimeout=new DaemonIdleTimeout(startParameter).getIdleTimeout();
  DaemonClientServices clientServices=new DaemonClientServices(loggingServices,startParameter.getDaemonRegistryDir(),idleTimeout);
  DaemonClient client=clientServices.get(DaemonClient.class);
  boolean useDaemon=System.getProperty("org.gradle.daemon","false").equals("true");
  useDaemon=useDaemon || commandLine.hasOption(DAEMON);
  useDaemon=useDaemon && !commandLine.hasOption(NO_DAEMON);
  long startTime=ManagementFactory.getRuntimeMXBean().getStartTime();
  if (commandLine.hasOption(FOREGROUND)) {
    return new ActionAdapter(new DaemonMain(startParameter,false));
  }
  if (commandLine.hasOption(STOP)) {
    return new ActionAdapter(new StopDaemonAction(client));
  }
  if (useDaemon) {
    return new ActionAdapter(new DaemonBuildAction(client,commandLine,new File(System.getProperty("user.dir")),clientMetaData(),startTime,System.getProperties(),System.getenv()));
  }
  return new RunBuildAction(startParameter,loggingServices,new DefaultBuildRequestMetaData(clientMetaData(),startTime));
}
