{
  Pattern collectionEventPattern=Pattern.compile("\\d+\\.\\d+: \\[(?:(?:Full GC(?: [^\\s]+)?)|GC) (\\d+\\.\\d+: )?\\[.*\\] (\\d+)K->(\\d+)K\\((\\d+)K\\)");
  Pattern memoryPoolPattern=Pattern.compile("([\\w\\s]+) total (\\d+)K, used (\\d+)K \\[.+");
  long totalHeapUsage=0;
  long maxUsage=0;
  long maxUncollectedUsage=0;
  long maxCommittedUsage=0;
  long usageAtPreviousCollection=0;
  int events=0;
  while (true) {
    String line=reader.readLine();
    if (line == null || line.equals("Heap")) {
      break;
    }
    Matcher matcher=collectionEventPattern.matcher(line);
    if (!matcher.lookingAt()) {
      throw new IllegalArgumentException("Unrecognized garbage collection event found in garbage collection log: " + line);
    }
    events++;
    long start=Long.parseLong(matcher.group(2));
    long end=Long.parseLong(matcher.group(3));
    long committed=Long.parseLong(matcher.group(4));
    if (start < usageAtPreviousCollection) {
      throw new IllegalArgumentException("Unexpected max heap size found in garbage collection event: " + line);
    }
    totalHeapUsage+=start - usageAtPreviousCollection;
    maxUsage=Math.max(maxUsage,start);
    maxUncollectedUsage=Math.max(maxUncollectedUsage,end);
    maxCommittedUsage=Math.max(maxCommittedUsage,committed);
    usageAtPreviousCollection=end;
  }
  if (events == 0) {
    throw new IllegalArgumentException("Did not find any garbage collection events in garbage collection log.");
  }
  long finalHeapUsage=0;
  long finalCommittedHeap=0;
  while (true) {
    String line=reader.readLine();
    if (line == null) {
      break;
    }
    Matcher matcher=memoryPoolPattern.matcher(line);
    if (!matcher.lookingAt()) {
      continue;
    }
    String pool=matcher.group(1).trim();
    if (pool.toLowerCase().contains("perm gen") || pool.toLowerCase().contains("permgen")) {
      continue;
    }
    long committed=Long.parseLong(matcher.group(2));
    long usage=Long.parseLong(matcher.group(3));
    finalHeapUsage+=usage;
    finalCommittedHeap+=committed;
  }
  if (finalHeapUsage == 0) {
    throw new IllegalArgumentException("Did not find any memory pool usage details in garbage collection log.");
  }
  if (finalHeapUsage < usageAtPreviousCollection) {
    throw new IllegalArgumentException("Unexpected max heap size found in memory pool usage.");
  }
  totalHeapUsage+=finalHeapUsage - usageAtPreviousCollection;
  maxUsage=Math.max(maxUsage,finalHeapUsage);
  maxCommittedUsage=Math.max(maxCommittedUsage,finalCommittedHeap);
  operation.setTotalHeapUsage(DataAmount.kbytes(BigDecimal.valueOf(totalHeapUsage)));
  operation.setMaxHeapUsage(DataAmount.kbytes(BigDecimal.valueOf(maxUsage)));
  operation.setMaxUncollectedHeap(DataAmount.kbytes(BigDecimal.valueOf(maxUncollectedUsage)));
  operation.setMaxCommittedHeap(DataAmount.kbytes(BigDecimal.valueOf(maxCommittedUsage)));
}
