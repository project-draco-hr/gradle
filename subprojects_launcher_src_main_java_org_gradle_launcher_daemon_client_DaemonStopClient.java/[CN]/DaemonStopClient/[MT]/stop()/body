{
  long start=System.currentTimeMillis();
  long expiry=start + STOP_TIMEOUT_SECONDS * 1000;
  Set<String> stopped=new HashSet<String>();
  DaemonClientConnection connection=connector.maybeConnect(compatibilitySpec);
  if (connection == null) {
    LOGGER.lifecycle(DaemonMessages.NO_DAEMONS_RUNNING);
    return;
  }
  LOGGER.lifecycle("Stopping daemon(s).");
  while (connection != null && System.currentTimeMillis() < expiry) {
    try {
      if (stopped.add(connection.getDaemon().getUid())) {
        LOGGER.debug("Requesting daemon {} stop now",connection.getDaemon());
        stopDispatcher.dispatch(connection,new Stop(idGenerator.generateId(),connection.getDaemon().getToken()));
        LOGGER.lifecycle("Gradle daemon stopped.");
      }
    }
  finally {
      connection.stop();
    }
    connection=connector.maybeConnect(compatibilitySpec);
  }
  if (connection != null) {
    throw new GradleException(String.format("Timeout waiting for all daemons to stop. Waited %s seconds.",(System.currentTimeMillis() - start) / 1000));
  }
}
