{
  String taskName=binary.getName() + "Test";
  tasks.create(taskName,Test.class,new Action<Test>(){
    @Override public void execute(    final Test test){
      test.setTestClassesDir(binary.getClassesDir());
      configureReports(test);
      configureTaskDependencies(test);
    }
    private void configureTaskDependencies(    final Test test){
      binary.getTasks().withType(PlatformJavaCompile.class).all(new Action<PlatformJavaCompile>(){
        @Override public void execute(        PlatformJavaCompile platformJavaCompile){
          test.dependsOn(platformJavaCompile);
        }
      }
);
    }
    private File configureReports(    Test test){
      TestTaskReports reports=test.getReports();
      File reportsDirectory=new File(buildDir,"reports");
      File htmlDir=new File(reportsDirectory,"tests");
      File xmlDir=new File(buildDir,"test-results");
      File binDir=new File(xmlDir,"binary");
      reports.getHtml().setDestination(htmlDir);
      reports.getJunitXml().setDestination(xmlDir);
      test.setBinResultsDir(binDir);
      return reportsDirectory;
    }
  }
);
}
