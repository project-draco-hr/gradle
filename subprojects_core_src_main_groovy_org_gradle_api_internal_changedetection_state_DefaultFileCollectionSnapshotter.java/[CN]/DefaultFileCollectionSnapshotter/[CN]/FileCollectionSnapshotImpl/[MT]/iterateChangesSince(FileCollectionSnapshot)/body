{
  FileCollectionSnapshotImpl other=(FileCollectionSnapshotImpl)oldSnapshot;
  final Map<String,IncrementalFileSnapshot> otherSnapshots=new HashMap<String,IncrementalFileSnapshot>(other.snapshots);
  final Iterator<String> currentFiles=snapshots.keySet().iterator();
  return new ChangeIterator<String>(){
    private Iterator<String> removedFiles;
    public boolean next(    ChangeListener<String> listener){
      while (currentFiles.hasNext()) {
        String currentFile=currentFiles.next();
        IncrementalFileSnapshot otherFile=otherSnapshots.remove(currentFile);
        if (otherFile == null) {
          listener.added(currentFile);
          return true;
        }
 else         if (!snapshots.get(currentFile).isContentUpToDate(otherFile)) {
          listener.changed(currentFile);
          return true;
        }
      }
      if (removedFiles == null) {
        removedFiles=otherSnapshots.keySet().iterator();
      }
      if (removedFiles.hasNext()) {
        listener.removed(removedFiles.next());
        return true;
      }
      return false;
    }
  }
;
}
