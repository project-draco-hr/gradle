{
  final FileCollectionSnapshotImpl other=(FileCollectionSnapshotImpl)oldSnapshot;
  return new Diff(){
    public FileCollectionSnapshot applyTo(    FileCollectionSnapshot snapshot){
      FileCollectionSnapshotImpl target=(FileCollectionSnapshotImpl)snapshot;
      final Map<String,IncrementalFileSnapshot> newSnapshots=new HashMap<String,IncrementalFileSnapshot>(target.snapshots);
      diff(snapshots,other.snapshots,new MapMergeChangeListener<String,IncrementalFileSnapshot>(newSnapshots));
      return new FileCollectionSnapshotImpl(newSnapshots);
    }
  }
;
}
