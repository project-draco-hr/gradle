{
  final FileCollectionSnapshotImpl other=(FileCollectionSnapshotImpl)oldSnapshot;
  return new Diff(){
    public FileCollectionSnapshot applyTo(    FileCollectionSnapshot snapshot){
      return applyTo(snapshot,new NoOpChangeListener<Merge>());
    }
    public FileCollectionSnapshot applyTo(    FileCollectionSnapshot snapshot,    final ChangeListener<Merge> listener){
      FileCollectionSnapshotImpl target=(FileCollectionSnapshotImpl)snapshot;
      final Map<String,IncrementalFileSnapshot> newSnapshots=new HashMap<String,IncrementalFileSnapshot>(target.snapshots);
      diff(snapshots,other.snapshots,new MapMergeChangeListener<String,IncrementalFileSnapshot>(listener,newSnapshots));
      return new FileCollectionSnapshotImpl(newSnapshots);
    }
  }
;
}
