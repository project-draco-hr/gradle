{
  final List<FileVisitDetails> allFileVisitDetails=visitFiles(input);
  if (allFileVisitDetails.isEmpty()) {
    return new FileCollectionSnapshotImpl(Collections.<String,IncrementalFileSnapshot>emptyMap());
  }
  final Map<String,IncrementalFileSnapshot> snapshots=new HashMap<String,IncrementalFileSnapshot>();
  cacheAccess.useCache("Create file snapshot",new Runnable(){
    public void run(){
      for (      FileVisitDetails fileDetails : allFileVisitDetails) {
        final String absolutePath=stringInterner.intern(fileDetails.getFile().getAbsolutePath());
        if (!snapshots.containsKey(absolutePath)) {
          if (fileDetails.isDirectory()) {
            snapshots.put(absolutePath,new DirSnapshot());
          }
 else {
            snapshots.put(absolutePath,new FileHashSnapshot(snapshotter.snapshot(fileDetails).getHash()));
          }
        }
      }
    }
  }
);
  return new FileCollectionSnapshotImpl(snapshots);
}
