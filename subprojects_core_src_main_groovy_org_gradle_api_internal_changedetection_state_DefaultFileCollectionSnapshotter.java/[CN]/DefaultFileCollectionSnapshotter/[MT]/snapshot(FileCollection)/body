{
  final Set<File> files=input.getAsFileTree().getFiles();
  if (files.isEmpty()) {
    return new FileCollectionSnapshotImpl(Collections.<String,IncrementalFileSnapshot>emptyMap());
  }
  final Map<String,IncrementalFileSnapshot> snapshots=new HashMap<String,IncrementalFileSnapshot>();
  cacheAccess.useCache("Create file snapshot",new Runnable(){
    public void run(){
      for (      File file : files) {
        if (file.isFile()) {
          snapshots.put(file.getAbsolutePath(),new FileHashSnapshot(snapshotter.snapshot(file).getHash()));
        }
 else         if (file.isDirectory()) {
          snapshots.put(file.getAbsolutePath(),new DirSnapshot());
        }
 else {
          snapshots.put(file.getAbsolutePath(),new MissingFileSnapshot());
        }
      }
    }
  }
);
  return new FileCollectionSnapshotImpl(snapshots);
}
