{
  EnhancedArtifactDownloadReport adr=new EnhancedArtifactDownloadReport(artifact);
  DownloadListener listener=options.getListener();
  if (listener != null) {
    listener.needArtifact(this,artifact);
  }
  long start=System.currentTimeMillis();
  try {
    ResolvedResource artifactRef=resourceResolver.resolve(artifact);
    if (artifactRef != null) {
      final Resource resource=artifactRef.getResource();
      ArtifactOrigin origin=new ArtifactOrigin(artifact,resource.isLocal(),resource.getName());
      if (listener != null) {
        listener.startArtifactDownload(this,artifactRef,artifact,origin);
      }
      ModuleVersionIdentifier moduleVersionId=DefaultModuleVersionIdentifier.newId(artifact.getModuleRevisionId());
      ModuleComponentIdentifier componentIdentifier=DefaultModuleComponentIdentifier.newId(moduleVersionId);
      ModuleVersionArtifactIdentifier artifactId=new DefaultModuleVersionArtifactIdentifier(componentIdentifier,moduleVersionId,artifact);
      File artifactFile=downloadAndCacheArtifactFile(new DefaultModuleVersionArtifactMetaData(artifactId),artifact,resourceDownloader,artifactRef.getResource());
      adr.setDownloadTimeMillis(System.currentTimeMillis() - start);
      adr.setSize(artifactFile.length());
      adr.setDownloadStatus(DownloadStatus.SUCCESSFUL);
      adr.setArtifactOrigin(origin);
      adr.setLocalFile(artifactFile);
    }
 else {
      adr.setDownloadTimeMillis(System.currentTimeMillis() - start);
      adr.setDownloadStatus(DownloadStatus.FAILED);
      adr.setDownloadDetails(ArtifactDownloadReport.MISSING_ARTIFACT);
    }
  }
 catch (  Throwable throwable) {
    adr.setDownloadTimeMillis(System.currentTimeMillis() - start);
    adr.failed(throwable);
  }
  if (listener != null) {
    listener.endArtifactDownload(this,artifact,adr,adr.getLocalFile());
  }
  return adr;
}
