{
  lifecycleLock.lock();
  try {
    if (started) {
      throw new IllegalStateException("cannot start daemon as it is already running");
    }
    connectorAddress=connector.start(new IncomingConnectionHandler(){
      public void handle(      final Connection<Object> connection){
        handlersExecutor.execute(new Runnable(){
          public void run(){
            try {
              handleIncoming(connection);
            }
 catch (            RuntimeException e) {
              LOGGER.error("Error processing the incoming command.",e);
              throw e;
            }
          }
        }
);
      }
    }
);
    control.setActivityListener(new DomainRegistryUpdater(daemonRegistry,connectorAddress));
    stopperExecutor.execute(new Runnable(){
      public void run(){
        try {
          stopLatch.await();
        }
 catch (        InterruptedException e) {
          return;
        }
        LOGGER.info("Stop requested. Daemon is stopping accepting new connections...");
        connector.stop();
        LOGGER.info("Waking and signalling stop to the main daemon thread...");
        control.stop();
      }
    }
);
    control.start();
    started=true;
    LOGGER.lifecycle("Daemon started at: " + new Date() + ", with address: "+ connectorAddress);
  }
 catch (  Exception e) {
    LOGGER.warn("exception starting daemon",e);
    stopLatch.countDown();
  }
 finally {
    lifecycleLock.unlock();
  }
}
