{
  LOGGER.info("start() called on daemon - {}",daemonContext);
  lifecyleLock.lock();
  try {
    if (stateCoordinator != null) {
      throw new IllegalStateException("cannot start daemon as it is already running");
    }
    registryUpdater=new DomainRegistryUpdater(daemonRegistry,daemonContext,password);
    Runtime.getRuntime().addShutdownHook(new Thread(){
      public void run(){
        try {
          daemonRegistry.remove(connectorAddress);
        }
 catch (        Exception e) {
          LOGGER.debug("VM shutdown hook was unable to remove the daemon address from the registry. It will be cleaned up later.",e);
        }
      }
    }
);
    Runnable onStartCommand=new Runnable(){
      public void run(){
        registryUpdater.onStartActivity();
      }
    }
;
    Runnable onFinishCommand=new Runnable(){
      public void run(){
        registryUpdater.onCompleteActivity();
      }
    }
;
    stateCoordinator=new DaemonStateCoordinator(onStartCommand,onFinishCommand);
    connectionHandler=new DefaultIncomingConnectionHandler(commandExecuter,daemonContext,stateCoordinator,executorFactory);
    connectorAddress=connector.start(connectionHandler);
    LOGGER.debug("Daemon starting at: " + new Date() + ", with address: "+ connectorAddress);
    registryUpdater.onStart(connectorAddress);
  }
  finally {
    lifecyleLock.unlock();
  }
}
