{
  if (!(action instanceof BuildModelAction)) {
    return;
  }
  BuildModelAction buildModelAction=(BuildModelAction)action;
  GradleInternal gradle=buildController.getGradle();
  if (buildModelAction.isSendTestProgressEvents()) {
    BuildEventConsumer eventConsumer=gradle.getServices().get(BuildEventConsumer.class);
    gradle.addListener(new ClientForwardingTestListener(eventConsumer));
  }
  if (buildModelAction.isSendTaskProgressEvents()) {
    BuildEventConsumer eventConsumer=gradle.getServices().get(BuildEventConsumer.class);
    gradle.addListener(new ClientForwardingTaskListener(eventConsumer));
  }
  if (buildModelAction.isRunTasks()) {
    buildController.run();
  }
 else {
    buildController.configure();
    gradle.getServices().get(ProjectConfigurer.class).configureHierarchy(gradle.getRootProject());
    for (    Project project : gradle.getRootProject().getAllprojects()) {
      ProjectInternal projectInternal=(ProjectInternal)project;
      projectInternal.getTasks().discoverTasks();
      projectInternal.bindAllModelRules();
    }
  }
  String modelName=buildModelAction.getModelName();
  ToolingModelBuilderRegistry builderRegistry=getToolingModelBuilderRegistry(gradle);
  ToolingModelBuilder builder;
  try {
    builder=builderRegistry.getBuilder(modelName);
  }
 catch (  UnknownModelException e) {
    throw (InternalUnsupportedModelException)new InternalUnsupportedModelException().initCause(e);
  }
  Object result;
  if (builder instanceof ProjectSensitiveToolingModelBuilder) {
    result=((ProjectSensitiveToolingModelBuilder)builder).buildAll(modelName,gradle.getDefaultProject(),true);
  }
 else {
    result=builder.buildAll(modelName,gradle.getDefaultProject());
  }
  PayloadSerializer payloadSerializer=gradle.getServices().get(PayloadSerializer.class);
  BuildActionResult buildActionResult=new BuildActionResult(payloadSerializer.serialize(result),null);
  buildController.setResult(buildActionResult);
}
