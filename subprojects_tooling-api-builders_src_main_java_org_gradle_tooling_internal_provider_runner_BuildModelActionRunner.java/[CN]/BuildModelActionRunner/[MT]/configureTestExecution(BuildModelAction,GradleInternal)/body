{
  final TestConfiguration testConfiguration=buildModelAction.getTestConfiguration();
  final List<String> taskNames=new ArrayList<String>();
  if (testConfiguration != null) {
    gradle.addProjectEvaluationListener(new ProjectEvaluationListener(){
      @Override public void beforeEvaluate(      Project project){
      }
      @Override public void afterEvaluate(      Project project,      ProjectState state){
        TaskCollection<Test> testTaskCollection=project.getTasks().withType(Test.class);
        String[] includePatterns=testConfiguration.getIncludePatterns();
        String[] excludePatterns=testConfiguration.getExcludePatterns();
        for (        Test test : testTaskCollection) {
          if (testConfiguration.isAlwaysRunTests()) {
            test.getOutputs().upToDateWhen(FORCE_EXECUTION);
          }
          taskNames.add(test.getName());
          gradle.getStartParameter().setTaskNames(taskNames);
          TestFilter filter=test.getFilter();
          filter.setIncludePatterns(includePatterns);
          filter.setExcludePatterns(excludePatterns);
          filter.setFailIfNoMatchingTestFound(false);
        }
      }
    }
);
  }
}
