{
  DefaultExecutorFactory executorFactory=new DefaultExecutorFactory();
  TcpIncomingConnector<Object> incomingConnector=new TcpIncomingConnector<Object>(executorFactory,new DefaultMessageSerializer<Object>(getClass().getClassLoader()),new InetAddressFactory(),new UUIDGenerator());
  final CompletionHandler finished=new CompletionHandler();
  LOGGER.lifecycle("Awaiting requests.");
  Action<ConnectEvent<Connection<Object>>> connectEvent=new Action<ConnectEvent<Connection<Object>>>(){
    public void execute(    ConnectEvent<Connection<Object>> connectionConnectEvent){
      try {
        finished.onStartActivity();
        handler.handle(connectionConnectEvent.getConnection(),finished);
      }
  finally {
        finished.onActivityComplete();
        connectionConnectEvent.getConnection().stop();
      }
    }
  }
;
  Address address=incomingConnector.accept(connectEvent,false);
  storeDaemonAddress(address);
  boolean stopped=finished.awaitStop();
  if (!stopped) {
    LOGGER.lifecycle("Time-out waiting for requests. Stopping.");
  }
  new CompositeStoppable(incomingConnector,executorFactory).stop();
  getRegistryFile().delete();
}
