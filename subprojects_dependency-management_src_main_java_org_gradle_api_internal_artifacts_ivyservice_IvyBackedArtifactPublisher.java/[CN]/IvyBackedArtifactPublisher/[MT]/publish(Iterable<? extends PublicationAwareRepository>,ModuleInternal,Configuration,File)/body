{
  ivyContextManager.withIvy(new Action<Ivy>(){
    public void execute(    Ivy ivy){
      Set<Configuration> allConfigurations=configuration.getAll();
      Set<Configuration> configurationsToPublish=configuration.getHierarchy();
      MutableLocalComponentMetaData allConfigurationsComponentMetaData=publishLocalComponentFactory.convert(new ComponentConverterSource(allConfigurations,module));
      if (descriptor != null) {
        IvyModulePublishMetaData publishMetaData=allConfigurationsComponentMetaData.toPublishMetaData();
        ivyModuleDescriptorWriter.write(publishMetaData.getModuleDescriptor(),publishMetaData.getArtifacts(),descriptor);
      }
      MutableLocalComponentMetaData componentMetaData=publishLocalComponentFactory.convert(new ComponentConverterSource(configurationsToPublish,module));
      BuildableIvyModulePublishMetaData publishMetaData=componentMetaData.toPublishMetaData();
      if (descriptor != null) {
        Artifact artifact=MDArtifact.newIvyArtifact(publishMetaData.getModuleDescriptor());
        publishMetaData.addArtifact(artifact,descriptor);
      }
      List<ModuleVersionPublisher> publishResolvers=new ArrayList<ModuleVersionPublisher>();
      for (      PublicationAwareRepository repository : repositories) {
        ModuleVersionPublisher publisher=repository.createPublisher();
        publishResolvers.add(publisher);
      }
      dependencyPublisher.publish(publishResolvers,publishMetaData);
    }
  }
);
}
