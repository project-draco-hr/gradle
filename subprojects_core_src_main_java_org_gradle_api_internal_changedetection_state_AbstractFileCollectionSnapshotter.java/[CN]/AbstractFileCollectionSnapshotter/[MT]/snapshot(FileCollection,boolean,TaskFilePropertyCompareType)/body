{
  final List<VisitedTree> fileTreeElements=Lists.newLinkedList();
  final List<File> missingFiles=Lists.newArrayList();
  visitFiles(input,fileTreeElements,missingFiles,allowReuse);
  if (fileTreeElements.isEmpty() && missingFiles.isEmpty()) {
    return emptySnapshot();
  }
  final List<TreeSnapshot> treeSnapshots=new ArrayList<TreeSnapshot>();
  cacheAccess.useCache("Create file snapshot",new Runnable(){
    public void run(){
      final List<VisitedTree> nonShareableTrees=new ArrayList<VisitedTree>();
      for (      VisitedTree tree : fileTreeElements) {
        if (tree.isShareable()) {
          treeSnapshots.add(tree.maybeCreateSnapshot(snapshotter,stringInterner));
        }
 else {
          nonShareableTrees.add(tree);
        }
      }
      if (!nonShareableTrees.isEmpty() || !missingFiles.isEmpty()) {
        VisitedTree nonShareableTree=createJoinedTree(nonShareableTrees,missingFiles);
        treeSnapshots.add(nonShareableTree.maybeCreateSnapshot(snapshotter,stringInterner));
      }
    }
  }
);
  return new FileCollectionSnapshotImpl(treeSnapshots,compareType);
}
