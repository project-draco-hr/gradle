{
  ModuleRevisionId moduleRevisionId=createModuleRevisionId(dependency);
  EnhancedDependencyDescriptor newDescriptor=createDependencyDescriptor(dependency,configuration,moduleDescriptor,moduleRevisionId);
  EnhancedDependencyDescriptor matchingDependencyDescriptor=findMatchingDescriptorForSameConfiguration(moduleDescriptor,newDescriptor);
  if (matchingDependencyDescriptor != null) {
    mergeDescriptors(configuration,matchingDependencyDescriptor,newDescriptor,dependency);
    return matchingDependencyDescriptor;
  }
  moduleDescriptor.addDependency(newDescriptor);
  return newDescriptor;
}
