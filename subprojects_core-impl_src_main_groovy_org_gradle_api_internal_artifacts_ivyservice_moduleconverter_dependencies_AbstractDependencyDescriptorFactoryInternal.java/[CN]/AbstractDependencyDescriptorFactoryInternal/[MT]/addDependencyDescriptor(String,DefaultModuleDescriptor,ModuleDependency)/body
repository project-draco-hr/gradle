{
  ModuleRevisionId moduleRevisionId=createModuleRevisionId(dependency);
  DependencyDescriptor newDescriptor=createDependencyDescriptor(dependency,configuration,moduleDescriptor,moduleRevisionId);
  DefaultDependencyDescriptor matchingDependencyDescriptor=findMatchingDescriptorForSameConfiguration(moduleDescriptor,newDescriptor);
  if (matchingDependencyDescriptor != null) {
    mergeDescriptors(matchingDependencyDescriptor,newDescriptor);
    return;
  }
  DefaultDependencyDescriptor existingDependencyDescriptor=findExistingDescriptor(moduleDescriptor,newDescriptor);
  if (existingDependencyDescriptor != null) {
    existingDependencyDescriptor.addDependencyConfiguration(configuration,dependency.getConfiguration());
    return;
  }
  moduleDescriptor.addDependency(newDescriptor);
}
