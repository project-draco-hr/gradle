{
  LOGGER.debug("Determining if {} is up-to-date",task);
  TaskArtifactState taskArtifactState=repository.getStateFor(task);
  try {
    taskArtifactState.beforeTask();
    task.getOutputs().setHistory(taskArtifactState.getExecutionHistory());
    task.getOutputs().setExecutionContext(taskArtifactState.getExecutionContext());
    try {
      executer.execute(task,state);
      if (state.getFailure() == null) {
        taskArtifactState.afterTask();
      }
    }
  finally {
      task.getOutputs().setHistory(null);
    }
  }
  finally {
    taskArtifactState.finished();
  }
}
