{
  final FileResolver fileResolver=serviceRegistry.get(FileResolver.class);
  final ConfigurationContainer configurationContainer=serviceRegistry.get(ConfigurationContainer.class);
  final DependencyHandler dependencyHandler=serviceRegistry.get(DependencyHandler.class);
  final PlayToolChain playToolChain=serviceRegistry.get(PlayToolChain.class);
  for (  final PlayApplicationBinarySpec binary : binaryContainer.withType(PlayApplicationBinarySpec.class)) {
    final PlayPlatform targetPlatform=binary.getTargetPlatform();
    Dependency playTestDependency=dependencyHandler.create(String.format("com.typesafe.play:play-test_%s:%s",targetPlatform.getScalaMainVersion(),targetPlatform.getPlayVersion()));
    final Configuration testCompileConfiguration=configurationContainer.detachedConfiguration(playTestDependency);
    final FileCollection testCompileClasspath=fileResolver.resolveFiles(binary.getJarFile()).plus(testCompileConfiguration);
    final String testCompileTaskName=String.format("compile%sTests",StringUtils.capitalize(binary.getName()));
    final File testSourceDir=fileResolver.resolve("test");
    final File testClassesDir=new File(buildDir,String.format("testClasses/%s",binary.getName()));
    tasks.create(testCompileTaskName,PlatformScalaCompile.class,new Action<PlatformScalaCompile>(){
      public void execute(      PlatformScalaCompile scalaCompile){
        scalaCompile.dependsOn(binary.getBuildTask());
        scalaCompile.setClasspath(testCompileClasspath);
        scalaCompile.setPlatform(new DefaultScalaPlatform(binary.getTargetPlatform().getScalaVersion()));
        scalaCompile.setDestinationDir(testClassesDir);
        scalaCompile.setSource(testSourceDir);
        scalaCompile.setSourceCompatibility(binary.getTargetPlatform().getJavaVersion().getMajorVersion());
        scalaCompile.setTargetCompatibility(binary.getTargetPlatform().getJavaVersion().getMajorVersion());
        IncrementalCompileOptions incrementalOptions=scalaCompile.getScalaCompileOptions().getIncrementalOptions();
        incrementalOptions.setAnalysisFile(new File(buildDir,String.format("tmp/scala/compilerAnalysis/%s.analysis",testCompileTaskName)));
        scalaCompile.getScalaCompileOptions().setFork(true);
        scalaCompile.getScalaCompileOptions().setUseAnt(false);
      }
    }
);
    String testTaskName=String.format("test%s",StringUtils.capitalize(binary.getName()));
    tasks.create(testTaskName,Test.class,new Action<Test>(){
      public void execute(      Test test){
        test.setTestClassesDir(testClassesDir);
        test.setBinResultsDir(new File(buildDir,String.format("tmp/testResults/%s",test.getName())));
        test.getReports().getJunitXml().setDestination(new File(buildDir,String.format("reports/test/%s/junit",binary.getName())));
        test.getReports().getHtml().setDestination(new File(buildDir,String.format("reports/test/%s",binary.getName())));
        test.dependsOn(testCompileTaskName);
        test.setTestSrcDirs(Arrays.asList(testSourceDir));
        test.setWorkingDir(projectIdentifier.getProjectDir());
        test.setClasspath(testCompileClasspath.plus(fileResolver.resolveFiles(testClassesDir)));
      }
    }
);
  }
}
