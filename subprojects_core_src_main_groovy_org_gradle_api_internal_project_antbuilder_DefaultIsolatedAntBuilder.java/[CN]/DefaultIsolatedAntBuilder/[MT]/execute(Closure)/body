{
  classLoaderCache.withCachedClassLoader(libClasspath,gradleToIsolatedLeakPrevention,antToGradleLeakPrevention,new Factory<ClassLoader>(){
    @Override public ClassLoader create(){
      return new URLClassLoader(libClasspath.getAsURLArray(),baseAntLoader);
    }
  }
,new Action<CachedClassLoader>(){
    @Override public void execute(    CachedClassLoader cachedClassLoader){
      ClassLoader classLoader=cachedClassLoader.getClassLoader();
      Object antBuilder=newInstanceOf("org.gradle.api.internal.project.ant.BasicAntBuilder");
      Object antLogger=newInstanceOf("org.gradle.api.internal.project.ant.AntLoggingAdapter");
      ClassLoader originalLoader=Thread.currentThread().getContextClassLoader();
      Thread.currentThread().setContextClassLoader(classLoader);
      try {
        configureAntBuilder(antBuilder,antLogger);
        Object delegate=new AntBuilderDelegate(antBuilder,classLoader);
        ConfigureUtil.configure(antClosure,delegate);
      }
  finally {
        Thread.currentThread().setContextClassLoader(originalLoader);
        disposeBuilder(antBuilder,antLogger);
      }
    }
  }
);
}
