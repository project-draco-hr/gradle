{
  if (projectDir == null) {
    try {
      projectDir=File.createTempFile("gradle","projectDir");
      projectDir.delete();
      projectDir.mkdir();
      projectDir.deleteOnExit();
    }
 catch (    IOException e) {
      throw new UncheckedIOException(e);
    }
  }
  File homeDir=new File(projectDir,"gradleHome");
  GFileUtils.touch(new File(homeDir,"gradle-imports"));
  StartParameter startParameter=new StartParameter();
  startParameter.setGradleHomeDir(homeDir);
  startParameter.setGradleUserHomeDir(new File(projectDir,"userHome"));
  TopLevelBuildServiceRegistry topLevelRegistry=new TopLevelBuildServiceRegistry(GLOBAL_SERVICES,startParameter);
  GradleInternal gradle=new DefaultGradle(null,startParameter,topLevelRegistry);
  DefaultProjectDescriptor projectDescriptor=new DefaultProjectDescriptor(null,"test",projectDir,new DefaultProjectDescriptorRegistry());
  ProjectInternal project=topLevelRegistry.get(IProjectFactory.class).createProject(projectDescriptor,null,gradle);
  gradle.setRootProject(project);
  gradle.setDefaultProject(project);
  return project;
}
