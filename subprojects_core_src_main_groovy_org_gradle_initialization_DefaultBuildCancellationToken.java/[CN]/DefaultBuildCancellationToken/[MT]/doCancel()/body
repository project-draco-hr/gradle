{
  List<Runnable> toCall=new ArrayList<Runnable>();
synchronized (lock) {
    if (cancelled) {
      return;
    }
    cancelled=true;
    Runnable runnable=callbacks.poll();
    while (runnable != null) {
      toCall.add(runnable);
      runnable=callbacks.poll();
    }
  }
  Exception failure=null;
  for (  Runnable callback : toCall) {
    try {
      callback.run();
    }
 catch (    Exception ex) {
      if (failure != null) {
        Throwable lastEx=ex;
        while (lastEx.getCause() != null) {
          lastEx=lastEx.getCause();
        }
        lastEx.initCause(failure);
      }
      failure=ex;
    }
  }
  if (failure != null) {
    throw new RuntimeException(failure);
  }
}
