{
  if (inputs == null) {
    inputs=new InputReferences();
    try {
      inputsVariable=new VariableExpression(ACCESS_HOLDER_FIELD,POTENTIAL_INPUTS);
      super.visitClosureExpression(expression);
      BlockStatement code=(BlockStatement)expression.getCode();
      code.setNodeMetaData(AST_NODE_METADATA_INPUTS_KEY,inputs);
      inputsVariable.setClosureSharedVariable(true);
      StaticMethodCallExpression getAccessCall=new StaticMethodCallExpression(POTENTIAL_INPUTS_ACCESS,GET,ArgumentListExpression.EMPTY_ARGUMENTS);
      DeclarationExpression variableDeclaration=new DeclarationExpression(inputsVariable,new Token(Types.ASSIGN,"=",-1,-1),getAccessCall);
      code.getStatements().add(0,new ExpressionStatement(variableDeclaration));
      code.getVariableScope().putDeclaredVariable(inputsVariable);
    }
  finally {
      inputs=null;
    }
  }
 else {
    ++closureDepth;
    try {
      expression.getVariableScope().putReferencedLocalVariable(inputsVariable);
      super.visitClosureExpression(expression);
    }
  finally {
      --closureDepth;
    }
  }
}
