{
switch (state) {
case Running:
case Broken:
    try {
      onStopRequested.run();
    }
  finally {
      setState(State.StopRequested);
    }
  break;
case StopRequested:
case Stopped:
break;
default :
throw new IllegalStateException("Daemon is in unexpected state: " + state);
}
}
