{
switch (state) {
case Running:
case Broken:
    throw new IllegalStateException("This daemon has not been stopped.");
case StopRequested:
  try {
    onStop.run();
  }
  finally {
    setState(State.Stopped);
  }
break;
case Stopped:
break;
default :
throw new IllegalStateException("Daemon is in unexpected state: " + state);
}
}
