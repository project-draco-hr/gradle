{
  File canonicalDir=GFileUtils.canonicalise(cacheDir);
  CacheInfo cacheInfo=openCaches.get(canonicalDir);
  if (cacheInfo == null) {
    PersistentCache cache=cacheFactory.open(cacheDir,usage,properties);
    cacheInfo=new CacheInfo(cache,properties);
    openCaches.put(canonicalDir,cacheInfo);
  }
 else {
    if (!properties.equals(cacheInfo.properties)) {
      throw new UnsupportedOperationException(String.format("Cache '%s' is already open with different state.",cacheDir));
    }
  }
  cacheInfo.addReference();
  return cacheInfo.cache;
}
