{
  final URI serverAddress=new URI("test:somestuff");
  final OutgoingConnection<Message> connection=context.mock(OutgoingConnection.class);
  context.checking(new Expectations(){
{
      one(factory).connect(with(equalTo(serverAddress)),with(notNullValue(Dispatch.class)));
      will(returnValue(connection));
    }
  }
);
  DefaultMessagingClient client=new DefaultMessagingClient(factory,getClass().getClassLoader(),serverAddress);
  context.checking(new Expectations(){
{
      one(connection).stop();
    }
  }
);
  client.stop();
}
