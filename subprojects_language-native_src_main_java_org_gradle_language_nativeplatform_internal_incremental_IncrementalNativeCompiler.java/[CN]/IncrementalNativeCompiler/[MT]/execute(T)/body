{
  IncrementalCompilation compilation=cacheAccess.useCache("process source files",new Factory<IncrementalCompilation>(){
    public IncrementalCompilation create(){
      DefaultSourceIncludesParser sourceIncludesParser=new DefaultSourceIncludesParser(sourceParser,importsAreIncludes);
      IncrementalCompileProcessor processor=createProcessor(sourceIncludesParser,spec.getIncludeRoots());
      return processor.processSourceFiles(spec.getSourceFiles());
    }
  }
);
  spec.setSourceFileIncludes(mapIncludes(spec.getSourceFiles(),compilationStateCacheFactory.create(task.getPath()).get()));
  if (spec.isIncrementalCompile()) {
    return doIncrementalCompile(compilation,spec);
  }
  return doCleanIncrementalCompile(spec);
}
