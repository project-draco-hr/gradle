{
  Class<?> targetType=value instanceof Throwable ? Throwable.class : value.getClass();
  TypeInfo typeInfo=serializersByType.get(targetType);
  if (typeInfo == null) {
    throw new IllegalArgumentException(String.format("Don't know how to serialize an object of type %s.",value.getClass().getName()));
  }
  encoder.writeByte(typeInfo.tag);
  typeInfo.serializer.write(encoder,value);
}
