{
  project.getTasks().withType(Upload.class).matching(new Spec<Upload>(){
    public boolean isSatisfiedBy(    Upload element){
      return element.getName().equals(UPLOAD_ARCHIVES_TASK_NAME);
    }
  }
).all(new Action<Upload>(){
    public void execute(    final Upload upload){
      upload.getRepositories().matching(new Spec<ArtifactRepository>(){
        public boolean isSatisfiedBy(        ArtifactRepository repository){
          return repository instanceof IvyArtifactRepository;
        }
      }
).all(new Action<ArtifactRepository>(){
        public void execute(        ArtifactRepository artifactRepository){
          ConfigurationInternal internalConfig=(ConfigurationInternal)upload.getConfiguration();
          ModuleInternal module=internalConfig.getModule();
          ModuleVersionIdentifier publicationId=new DefaultModuleVersionIdentifier(module.getGroup(),module.getName(),module.getVersion());
          publicationRegistry.registerPublication(module.getProjectPath(),new DefaultProjectPublication(publicationId));
        }
      }
);
    }
  }
);
}
