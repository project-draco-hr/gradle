{
  final CopySpecContentVisitor effectiveVisitor=new DuplicateHandlingCopySpecContentVisitor(new NormalizingCopySpecContentVisitor(visitor),true);
  effectiveVisitor.startVisit();
  new CopySpecWalker().visit(toVisit,new Action<CopySpecInternal>(){
    public void execute(    final CopySpecInternal spec){
      effectiveVisitor.visitSpec(spec);
      FileTree source=spec.getSource();
      source.visit(new FileVisitor(){
        public void visitDir(        FileVisitDetails dirDetails){
          visit(dirDetails);
        }
        public void visitFile(        FileVisitDetails fileDetails){
          visit(fileDetails);
        }
        private void visit(        FileVisitDetails visitDetails){
          DefaultFileCopyDetails details=instantiator.newInstance(DefaultFileCopyDetails.class,visitDetails,spec,fileSystem);
          for (          Action<? super FileCopyDetails> action : spec.getAllCopyActions()) {
            action.execute(details);
            if (details.isExcluded()) {
              return;
            }
          }
          effectiveVisitor.visit(details);
        }
      }
);
    }
  }
);
  effectiveVisitor.endVisit();
}
