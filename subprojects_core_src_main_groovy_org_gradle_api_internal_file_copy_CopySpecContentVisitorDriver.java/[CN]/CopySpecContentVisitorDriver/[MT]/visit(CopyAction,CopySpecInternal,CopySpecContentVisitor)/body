{
  visitor.startVisit(copyAction);
  new CopySpecWalker().visit(toVisit,new Action<CopySpecInternal>(){
    public void execute(    final CopySpecInternal spec){
      visitor.visitSpec(spec);
      FileTree source=spec.getSource();
      source.visit(new FileVisitor(){
        public void visitDir(        FileVisitDetails dirDetails){
          visitor.visitDir(new DefaultFileCopyDetails(dirDetails,spec,fileSystem));
        }
        public void visitFile(        FileVisitDetails fileDetails){
          DefaultFileCopyDetails details=instantiator.newInstance(DefaultFileCopyDetails.class,fileDetails,spec,fileSystem);
          for (          Action<? super FileCopyDetails> action : spec.getAllCopyActions()) {
            action.execute(details);
            if (details.isExcluded()) {
              return;
            }
          }
          visitor.visitFile(details);
        }
      }
);
    }
  }
);
  visitor.endVisit();
}
