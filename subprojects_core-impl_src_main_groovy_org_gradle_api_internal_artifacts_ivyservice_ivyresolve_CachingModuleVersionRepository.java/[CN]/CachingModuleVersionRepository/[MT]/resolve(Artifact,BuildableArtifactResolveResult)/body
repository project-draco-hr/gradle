{
  ArtifactAtRepositoryKey resolutionCacheIndexKey=new ArtifactAtRepositoryKey(delegate,artifact.getId());
  CachedExternalResource cached=artifactAtRepositoryCachedResolutionIndex.lookup(resolutionCacheIndexKey);
  if (cached != null) {
    ArtifactIdentifier artifactIdentifier=createArtifactIdentifier(artifact);
    long age=timeProvider.getCurrentTime() - cached.getCachedAt();
    if (cached.isMissing()) {
      if (!cachePolicy.mustRefreshArtifact(artifactIdentifier,null,age)) {
        LOGGER.debug("Detected non-existence of artifact '{}' in resolver cache",artifact.getId());
        result.notFound(artifact);
        return;
      }
    }
 else {
      File cachedArtifactFile=cached.getCachedFile();
      if (!cachePolicy.mustRefreshArtifact(artifactIdentifier,cachedArtifactFile,age)) {
        LOGGER.debug("Found artifact '{}' in resolver cache: {}",artifact.getId(),cachedArtifactFile);
        result.resolved(cachedArtifactFile,cached.getExternalResourceMetaData());
        return;
      }
    }
  }
  delegate.resolve(artifact,result);
  LOGGER.debug("Downloaded artifact '{}' from resolver: {}",artifact.getId(),delegate);
  if (result.getFailure() instanceof ArtifactNotFoundException) {
    artifactAtRepositoryCachedResolutionIndex.storeMissing(resolutionCacheIndexKey);
  }
 else {
    artifactAtRepositoryCachedResolutionIndex.store(resolutionCacheIndexKey,result.getFile(),result.getExternalResourceMetaData());
  }
}
