{
  DependencyMetaData forced=dependency.withChanging();
  delegate.getDependency(forced,result);
switch (result.getState()) {
case Missing:
    ModuleRevisionId dependencyRevisionId=dependency.getDescriptor().getDependencyRevisionId();
  ModuleVersionIdentifier moduleVersionIdentifier=DefaultModuleVersionIdentifier.newId(dependencyRevisionId);
moduleDescriptorCache.cacheMissing(delegate,moduleVersionIdentifier,dependency.isChanging());
break;
case Resolved:
MutableModuleVersionMetaData metaData=result.getMetaData();
if (dependency.isChanging()) {
metaData.setChanging(true);
}
moduleResolutionCache.cacheModuleResolution(delegate,dependency.getRequested(),metaData.getId());
ModuleSource moduleSource=result.getModuleSource();
ModuleDescriptorCache.CachedModuleDescriptor cachedModuleDescriptor=moduleDescriptorCache.cacheMetaData(delegate,metaData,moduleSource);
result.setModuleSource(new CachingModuleSource(cachedModuleDescriptor.getDescriptorHash(),cachedModuleDescriptor.isChangingModule(),moduleSource));
break;
case Failed:
break;
default :
throw new IllegalStateException("Unexpected resolve state: " + result.getState());
}
}
