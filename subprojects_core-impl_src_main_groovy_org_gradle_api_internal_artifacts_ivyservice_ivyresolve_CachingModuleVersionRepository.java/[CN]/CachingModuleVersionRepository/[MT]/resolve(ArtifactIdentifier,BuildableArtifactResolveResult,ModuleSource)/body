{
  ArtifactAtRepositoryKey resolutionCacheIndexKey=new ArtifactAtRepositoryKey(delegate.getId(),artifact);
  CachedArtifact cached=artifactAtRepositoryCachedResolutionIndex.lookup(resolutionCacheIndexKey);
  final CachingModuleSource cachedModuleSource=(CachingModuleSource)moduleSource;
  final BigInteger descriptorHash=cachedModuleSource.getDescriptorHash();
  if (cached != null) {
    long age=timeProvider.getCurrentTime() - cached.getCachedAt();
    final boolean isChangingModule=cachedModuleSource.isChangingModule();
    if (cached.isMissing()) {
      if (!cachePolicy.mustRefreshArtifact(artifact,null,age,isChangingModule,descriptorHash.equals(cached.getDescriptorHash()))) {
        LOGGER.debug("Detected non-existence of artifact '{}' in resolver cache",artifact);
        result.notFound(artifact);
        return;
      }
    }
 else {
      File cachedArtifactFile=cached.getCachedFile();
      if (!cachePolicy.mustRefreshArtifact(artifact,cachedArtifactFile,age,isChangingModule,descriptorHash.equals(cached.getDescriptorHash()))) {
        LOGGER.debug("Found artifact '{}' in resolver cache: {}",artifact,cachedArtifactFile);
        result.resolved(cachedArtifactFile);
        return;
      }
    }
  }
  delegate.resolve(artifact,result,cachedModuleSource.getDelegate());
  LOGGER.debug("Downloaded artifact '{}' from resolver: {}",artifact,delegate.getName());
  if (result.getFailure() instanceof ArtifactNotFoundException) {
    artifactAtRepositoryCachedResolutionIndex.storeMissing(resolutionCacheIndexKey,descriptorHash);
  }
 else {
    artifactAtRepositoryCachedResolutionIndex.store(resolutionCacheIndexKey,result.getFile(),descriptorHash);
  }
}
