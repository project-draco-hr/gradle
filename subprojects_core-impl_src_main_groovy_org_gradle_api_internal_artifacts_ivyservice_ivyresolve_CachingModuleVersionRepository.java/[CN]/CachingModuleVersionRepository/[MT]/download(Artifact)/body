{
  if (isLocal()) {
    return delegate.download(artifact);
  }
  ArtifactAtRepositoryKey resolutionCacheIndexKey=new ArtifactAtRepositoryKey(delegate,artifact.getId());
  CachedExternalResource cached=artifactAtRepositoryCachedResolutionIndex.lookup(resolutionCacheIndexKey);
  if (cached != null) {
    ArtifactIdentifier artifactIdentifier=createArtifactIdentifier(artifact);
    if (cached.isMissing()) {
      if (!cachePolicy.mustRefreshArtifact(artifactIdentifier,null,cached.getCachedAt())) {
        LOGGER.debug("Detected non-existence of artifact '{}' in resolver cache",artifact.getId());
        return null;
      }
    }
 else {
      File cachedArtifactFile=cached.getCachedFile();
      if (!cachePolicy.mustRefreshArtifact(artifactIdentifier,cachedArtifactFile,cached.getCachedAt())) {
        LOGGER.debug("Found artifact '{}' in resolver cache: {}",artifact.getId(),cachedArtifactFile);
        ExternalResourceMetaData metaData=cached.getExternalResourceMetaData();
        return new DownloadedArtifact(cachedArtifactFile,metaData.getLastModified(),metaData.getLocation());
      }
    }
  }
  DownloadedArtifact downloadedArtifact=delegate.download(artifact);
  LOGGER.debug("Downloaded artifact '{}' from resolver: {}",artifact.getId(),delegate);
  if (downloadedArtifact == null) {
    artifactAtRepositoryCachedResolutionIndex.storeMissing(resolutionCacheIndexKey);
  }
 else {
    String artifactUrl=downloadedArtifact.getSource();
    File artifactFile=downloadedArtifact.getLocalFile();
    Date artifactLastModified=downloadedArtifact.getLastModified();
    artifactAtRepositoryCachedResolutionIndex.store(resolutionCacheIndexKey,artifactFile,new DefaultExternalResourceMetaData(artifactUrl,artifactLastModified,-1));
  }
  return downloadedArtifact;
}
