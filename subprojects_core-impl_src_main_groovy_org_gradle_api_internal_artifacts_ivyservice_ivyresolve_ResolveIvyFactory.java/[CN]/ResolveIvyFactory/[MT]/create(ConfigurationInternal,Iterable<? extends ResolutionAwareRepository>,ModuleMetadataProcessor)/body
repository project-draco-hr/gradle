{
  ResolutionRules resolutionRules=configuration.getResolutionStrategy().getResolutionRules();
  CachePolicy cachePolicy=configuration.getResolutionStrategy().getCachePolicy();
  startParameterResolutionOverride.addResolutionRules(resolutionRules);
  UserResolverChain userResolverChain=new UserResolverChain(versionMatcher,latestStrategy);
  RepositoryChain parentLookupResolver=new ParentModuleLookupResolver(userResolverChain,cacheLockingManager);
  for (  ResolutionAwareRepository repository : repositories) {
    ConfiguredModuleVersionRepository baseRepository=repository.createResolver();
    if (baseRepository instanceof IvyAwareModuleVersionRepository) {
      ivyContextualize((IvyAwareModuleVersionRepository)baseRepository,userResolverChain,configuration.getName());
    }
    if (baseRepository instanceof ExternalResourceResolver) {
      ((ExternalResourceResolver)baseRepository).setRepositoryChain(parentLookupResolver);
    }
    ModuleComponentRepository moduleComponentRepository;
    if (baseRepository.isLocal()) {
      moduleComponentRepository=new LocalFilesystemModuleComponentRepository(baseRepository,metadataProcessor);
    }
 else {
      ModuleComponentRepository wrapperRepository=new CacheLockReleasingModuleComponentsRepository(baseRepository,cacheLockingManager);
      wrapperRepository=startParameterResolutionOverride.overrideModuleVersionRepository(wrapperRepository);
      moduleComponentRepository=new CachingModuleComponentRepository(wrapperRepository,moduleVersionsCache,moduleMetaDataCache,moduleArtifactsCache,artifactAtRepositoryCachedResolutionIndex,cachePolicy,timeProvider,metadataProcessor,getModuleExtractor(baseRepository));
    }
    if (baseRepository.isDynamicResolveMode()) {
      moduleComponentRepository=IvyDynamicResolveModuleComponentRepositoryAccess.wrap(moduleComponentRepository);
    }
    moduleComponentRepository=inMemoryCache.cached(moduleComponentRepository);
    userResolverChain.add(moduleComponentRepository);
  }
  return userResolverChain;
}
