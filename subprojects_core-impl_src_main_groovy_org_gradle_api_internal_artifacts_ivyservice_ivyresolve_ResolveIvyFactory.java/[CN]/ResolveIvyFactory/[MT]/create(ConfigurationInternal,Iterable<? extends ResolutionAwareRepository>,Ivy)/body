{
  ResolutionRules resolutionRules=configuration.getResolutionStrategy().getResolutionRules();
  startParameterResolutionOverride.addResolutionRules(resolutionRules);
  IvySettings ivySettings=ivy.getSettings();
  VersionMatcher versionMatcher=ivySettings.getVersionMatcher();
  ComparatorLatestStrategy comparatorLatestStrategy=(ComparatorLatestStrategy)ivySettings.getDefaultLatestStrategy();
  UserResolverChain userResolverChain=new UserResolverChain(versionMatcher,comparatorLatestStrategy);
  LoopbackDependencyResolver loopbackDependencyResolver=new LoopbackDependencyResolver("main",userResolverChain,cacheLockingManager);
  ivySettings.addResolver(loopbackDependencyResolver);
  ivySettings.setDefaultResolver(loopbackDependencyResolver.getName());
  ResolveData resolveData=createResolveData(ivy,configuration.getName());
  IvyContext.getContext().setResolveData(resolveData);
  for (  ResolutionAwareRepository repository : repositories) {
    IvyAwareModuleVersionRepository moduleVersionRepository=repository.createResolver();
    moduleVersionRepository.setSettings(ivySettings);
    LocalAwareModuleVersionRepository localAwareRepository;
    if (moduleVersionRepository.isLocal()) {
      localAwareRepository=new LocalModuleVersionRepository(moduleVersionRepository);
    }
 else {
      ModuleVersionRepository wrapperRepository=new CacheLockingModuleVersionRepository(moduleVersionRepository,cacheLockingManager);
      wrapperRepository=startParameterResolutionOverride.overrideModuleVersionRepository(wrapperRepository);
      localAwareRepository=new CachingModuleVersionRepository(wrapperRepository,moduleResolutionCache,moduleDescriptorCache,artifactAtRepositoryCachedResolutionIndex,configuration.getResolutionStrategy().getCachePolicy(),timeProvider);
    }
    if (moduleVersionRepository.isDynamicResolveMode()) {
      localAwareRepository=new IvyDynamicResolveModuleVersionRepository(localAwareRepository);
    }
    localAwareRepository=inMemoryCache.cached(localAwareRepository);
    userResolverChain.add(localAwareRepository);
  }
  return new DefaultIvyAdapter(versionMatcher,userResolverChain);
}
