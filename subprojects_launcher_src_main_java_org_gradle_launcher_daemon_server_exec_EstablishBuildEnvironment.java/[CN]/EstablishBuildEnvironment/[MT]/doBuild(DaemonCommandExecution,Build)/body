{
  Properties originalSystemProperties=new Properties();
  originalSystemProperties.putAll(System.getProperties());
  File currentDir=GFileUtils.canonicalise(new File("."));
  Properties clientSystemProperties=new Properties();
  clientSystemProperties.putAll(build.getParameters().getSystemProperties());
  clientSystemProperties.put("java.home",originalSystemProperties.get("java.home"));
  System.setProperties(clientSystemProperties);
  Map<String,String> originalEnv=System.getenv();
  processEnvironment.maybeSetEnvironment(build.getParameters().getEnvVariables());
  processEnvironment.maybeSetProcessDir(build.getParameters().getCurrentDir());
  try {
    execution.proceed();
  }
  finally {
    System.setProperties(originalSystemProperties);
    processEnvironment.maybeSetEnvironment(originalEnv);
    processEnvironment.maybeSetProcessDir(currentDir);
  }
}
