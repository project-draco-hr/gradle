{
  if (needsCDATAEscaping(ch)) {
    writeRaw("]]><![CDATA[>");
  }
 else   if (!isLegalCharacter(ch)) {
    writeRaw('?');
  }
 else   if (isRestrictedCharacter(ch)) {
    writeRaw("]]>");
    writeCharacterReference(ch);
    writeRaw("<![CDATA[");
  }
 else {
    writeRaw(ch);
  }
}
