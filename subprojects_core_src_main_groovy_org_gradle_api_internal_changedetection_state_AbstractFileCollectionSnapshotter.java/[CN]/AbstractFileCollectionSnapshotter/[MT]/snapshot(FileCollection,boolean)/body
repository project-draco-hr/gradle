{
  final List<FileTreeElement> fileTreeElements=Lists.newLinkedList();
  final List<File> missingFiles=Lists.newArrayList();
  visitFiles(input,fileTreeElements,missingFiles,allowReuse);
  if (fileTreeElements.isEmpty() && missingFiles.isEmpty()) {
    return emptySnapshot();
  }
  final Map<String,IncrementalFileSnapshot> snapshots=new HashMap<String,IncrementalFileSnapshot>();
  cacheAccess.useCache("Create file snapshot",new Runnable(){
    public void run(){
      for (      FileTreeElement fileDetails : fileTreeElements) {
        String absolutePath=getInternedAbsolutePath(fileDetails.getFile());
        if (!snapshots.containsKey(absolutePath)) {
          if (fileDetails.isDirectory()) {
            snapshots.put(absolutePath,DirSnapshot.getInstance());
          }
 else {
            snapshots.put(absolutePath,new FileHashSnapshot(snapshotter.snapshot(fileDetails).getHash(),fileDetails.getLastModified()));
          }
        }
      }
      for (      File missingFile : missingFiles) {
        String absolutePath=getInternedAbsolutePath(missingFile);
        if (!snapshots.containsKey(absolutePath)) {
          snapshots.put(absolutePath,MissingFileSnapshot.getInstance());
        }
      }
    }
  }
);
  return new FileCollectionSnapshotImpl(snapshots);
}
