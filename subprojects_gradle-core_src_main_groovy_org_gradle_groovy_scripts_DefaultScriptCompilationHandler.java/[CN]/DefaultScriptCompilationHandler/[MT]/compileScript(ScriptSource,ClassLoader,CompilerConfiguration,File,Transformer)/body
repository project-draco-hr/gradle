{
  logger.info("Compiling {} using {}.",source.getDisplayName(),transformer != null ? transformer.getClass().getSimpleName() : "no transformer");
  final EmptyScriptDetector emptyScriptDetector=new EmptyScriptDetector();
  final PackageStatementDetector packageDetector=new PackageStatementDetector();
  GroovyClassLoader groovyClassLoader=new GroovyClassLoader(classLoader,configuration,false){
    @Override protected CompilationUnit createCompilationUnit(    CompilerConfiguration compilerConfiguration,    CodeSource codeSource){
      CompilationUnit compilationUnit=new CompilationUnit(compilerConfiguration,codeSource,this){
        @Override protected groovyjarjarasm.asm.ClassVisitor createClassVisitor(){
          return new ClassWriter(ClassWriter.COMPUTE_MAXS){
            @Override public void visitSource(            String sourcePath,            String debugInfo){
              super.visitSource(source.getFileName(),debugInfo);
            }
          }
;
        }
      }
;
      if (transformer != null) {
        transformer.register(compilationUnit);
      }
      compilationUnit.addPhaseOperation(packageDetector,Phases.CANONICALIZATION);
      compilationUnit.addPhaseOperation(emptyScriptDetector,Phases.CANONICALIZATION);
      return compilationUnit;
    }
  }
;
  String scriptText=source.getResource().getText();
  String scriptName=source.getClassName();
  GroovyCodeSource codeSource=new GroovyCodeSource(scriptText == null ? "" : scriptText,scriptName,"/groovy/script");
  try {
    groovyClassLoader.parseClass(codeSource,false);
  }
 catch (  MultipleCompilationErrorsException e) {
    SyntaxException syntaxError=e.getErrorCollector().getSyntaxError(0);
    Integer lineNumber=syntaxError == null ? null : syntaxError.getLine();
    throw new ScriptCompilationException(String.format("Could not compile %s.",source.getDisplayName()),e,source,lineNumber);
  }
catch (  CompilationFailedException e) {
    throw new GradleException(String.format("Could not compile %s.",source.getDisplayName()),e);
  }
  if (packageDetector.hasPackageStatement) {
    throw new UnsupportedOperationException(String.format("%s should not contain a package statement.",StringUtils.capitalize(source.getDisplayName())));
  }
  if (emptyScriptDetector.isEmptyScript()) {
    GFileUtils.touch(new File(classesDir,EMPTY_SCRIPT_MARKER_FILE_NAME));
  }
}
