{
  LOGGER.debug("Connecting from tooling API consumer version {}",GradleVersion.current().getVersion());
  if (projectDir == null) {
    throw new IllegalStateException("A project directory must be specified before creating a connection.");
  }
  if (distribution == null) {
    distribution=distributionFactory.getDefaultDistribution(projectDir,searchUpwards != null ? searchUpwards : true);
  }
  DefaultConnectionParameters params=new DefaultConnectionParameters(projectDir,gradleUserHomeDir,searchUpwards,embedded,daemonMaxIdleTimeValue,daemonMaxIdleTimeUnits,verboseLogging);
  return connectionFactory.create(distribution,params);
}
