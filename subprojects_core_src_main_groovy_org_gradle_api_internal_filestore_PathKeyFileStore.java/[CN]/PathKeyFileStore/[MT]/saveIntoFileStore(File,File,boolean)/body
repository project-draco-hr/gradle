{
  if (!source.exists()) {
    throw new GradleException(String.format("Cannot copy '%s' into filestore @ '%s' as it does not exist",source,destination));
  }
  File parentDir=destination.getParentFile();
  if (!parentDir.mkdirs() && !parentDir.exists()) {
    throw new GradleException(String.format("Unable to create filestore directory %s",parentDir));
  }
  File markerFile=getMarkerFile(destination);
  try {
    markerFile.createNewFile();
    deleteAction.delete(destination);
    if (isMove) {
      FileUtils.moveFile(source,destination);
    }
 else {
      FileUtils.copyFile(source,destination);
    }
    deleteAction.delete(markerFile);
  }
 catch (  Exception exception) {
    deleteAction.delete(destination);
    deleteAction.delete(markerFile);
    String verb=isMove ? "move" : "copy";
    throw new GradleException(String.format("Failed to %s file '%s' into filestore at '%s' ",verb,source,destination),exception);
  }
  return entryAt(destination);
}
