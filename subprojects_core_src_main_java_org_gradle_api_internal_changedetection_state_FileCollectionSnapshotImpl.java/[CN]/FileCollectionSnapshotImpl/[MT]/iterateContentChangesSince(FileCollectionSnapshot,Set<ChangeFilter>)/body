{
  final Map<String,IncrementalFileSnapshot> otherSnapshots=new HashMap<String,IncrementalFileSnapshot>(oldSnapshot.getSnapshots());
  final Iterator<String> currentFiles=snapshots.keySet().iterator();
  final boolean includeAdded=!filters.contains(ChangeFilter.IgnoreAddedFiles);
  return new ChangeIterator<String>(){
    private Iterator<String> removedFiles;
    public boolean next(    ChangeListener<String> listener){
      while (currentFiles.hasNext()) {
        String currentFile=currentFiles.next();
        IncrementalFileSnapshot otherFile=otherSnapshots.remove(currentFile);
        if (otherFile == null) {
          if (includeAdded) {
            listener.added(currentFile);
            return true;
          }
        }
 else         if (!snapshots.get(currentFile).isContentUpToDate(otherFile)) {
          listener.changed(currentFile);
          return true;
        }
      }
      if (removedFiles == null) {
        removedFiles=otherSnapshots.keySet().iterator();
      }
      if (removedFiles.hasNext()) {
        listener.removed(removedFiles.next());
        return true;
      }
      return false;
    }
  }
;
}
