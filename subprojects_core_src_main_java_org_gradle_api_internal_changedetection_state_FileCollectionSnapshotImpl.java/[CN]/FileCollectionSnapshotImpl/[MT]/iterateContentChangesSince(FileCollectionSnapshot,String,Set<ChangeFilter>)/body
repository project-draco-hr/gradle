{
  final Map<String,IncrementalFileSnapshot> otherSnapshots=new HashMap<String,IncrementalFileSnapshot>(oldSnapshot.getSnapshots());
  final Iterator<String> currentFiles=snapshots.keySet().iterator();
  final boolean includeAdded=!filters.contains(ChangeFilter.IgnoreAddedFiles);
  return new AbstractIterator<TaskStateChange>(){
    private Iterator<String> removedFiles;
    @Override protected TaskStateChange computeNext(){
      while (currentFiles.hasNext()) {
        String currentFile=currentFiles.next();
        IncrementalFileSnapshot otherFile=otherSnapshots.remove(currentFile);
        if (otherFile == null) {
          if (includeAdded) {
            return new FileChange(currentFile,ChangeType.ADDED,fileType);
          }
        }
 else         if (!snapshots.get(currentFile).isContentUpToDate(otherFile)) {
          return new FileChange(currentFile,ChangeType.MODIFIED,fileType);
        }
      }
      if (removedFiles == null) {
        removedFiles=otherSnapshots.keySet().iterator();
      }
      if (removedFiles.hasNext()) {
        return new FileChange(removedFiles.next(),ChangeType.REMOVED,fileType);
      }
      return endOfData();
    }
  }
;
}
