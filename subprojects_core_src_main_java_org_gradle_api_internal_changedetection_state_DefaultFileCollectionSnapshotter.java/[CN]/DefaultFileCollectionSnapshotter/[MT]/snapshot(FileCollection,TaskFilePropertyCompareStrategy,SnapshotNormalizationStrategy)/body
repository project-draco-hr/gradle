{
  final List<FileSnapshotDetails> fileTreeElements=Lists.newLinkedList();
  final List<FileSnapshotDetails> missingFiles=Lists.newArrayList();
  FileCollectionInternal fileCollection=(FileCollectionInternal)input;
  FileCollectionVisitorImpl visitor=new FileCollectionVisitorImpl(fileTreeElements,missingFiles);
  fileCollection.visitRootElements(visitor);
  if (fileTreeElements.isEmpty() && missingFiles.isEmpty()) {
    return emptySnapshot();
  }
  final Map<String,NormalizedFileSnapshot> snapshots=Maps.newLinkedHashMap();
  cacheAccess.useCache("Create file snapshot",new Runnable(){
    public void run(){
      for (      FileSnapshotDetails fileDetails : fileTreeElements) {
        String absolutePath=fileDetails.path;
        if (!snapshots.containsKey(absolutePath)) {
          IncrementalFileSnapshot snapshot;
          if (fileDetails.type == FileType.Directory) {
            snapshot=DirSnapshot.getInstance();
          }
 else {
            snapshot=new FileHashSnapshot(snapshotter.snapshot(fileDetails.details).getHash(),fileDetails.details.getLastModified());
          }
          NormalizedFileSnapshot normalizedSnapshot=snapshotNormalizationStrategy.getNormalizedSnapshot(fileDetails.details,snapshot,stringInterner);
          if (normalizedSnapshot != null) {
            snapshots.put(absolutePath,normalizedSnapshot);
          }
        }
      }
      for (      FileSnapshotDetails missingFileDetails : missingFiles) {
        String absolutePath=missingFileDetails.path;
        if (!snapshots.containsKey(absolutePath)) {
          snapshots.put(absolutePath,snapshotNormalizationStrategy.getNormalizedSnapshot(missingFileDetails.details,MissingFileSnapshot.getInstance(),stringInterner));
        }
      }
    }
  }
);
  return new DefaultFileCollectionSnapshot(snapshots,compareStrategy);
}
