{
  DefaultModuleRegistry registry=new DefaultModuleRegistry();
  Set<File> bootstrapClasspath=new LinkedHashSet<File>();
  bootstrapClasspath.addAll(registry.getModule("gradle-launcher").getImplementationClasspath().getAsFiles());
  if (registry.getGradleHome() == null) {
    bootstrapClasspath.addAll(registry.getFullClasspath());
  }
  if (bootstrapClasspath.isEmpty()) {
    throw new IllegalStateException("Unable to construct a bootstrap classpath when starting the daemon");
  }
  versionValidator.validate(daemonParameters);
  List<String> daemonArgs=new ArrayList<String>();
  daemonArgs.add(daemonParameters.getEffectiveJavaExecutable().getAbsolutePath());
  List<String> daemonOpts=daemonParameters.getEffectiveJvmArgs();
  LOGGER.debug("Using daemon opts: {}",daemonOpts);
  daemonArgs.addAll(daemonOpts);
  daemonArgs.add("-cp");
  daemonArgs.add(CollectionUtils.join(File.pathSeparator,bootstrapClasspath));
  if (Boolean.getBoolean("org.gradle.daemon.debug")) {
    daemonArgs.add("-Xdebug");
    daemonArgs.add("-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005");
  }
  daemonArgs.add(GradleDaemon.class.getName());
  daemonArgs.add(GradleVersion.current().getVersion());
  ByteArrayOutputStream serializedConfig=new ByteArrayOutputStream();
  FlushableEncoder encoder=new KryoBackedEncoder(new EncodedStream.EncodedOutput(serializedConfig));
  try {
    encoder.writeString(daemonParameters.getGradleUserHomeDir().getAbsolutePath());
    encoder.writeString(daemonDir.getBaseDir().getAbsolutePath());
    encoder.writeSmallInt(daemonParameters.getIdleTimeout());
    encoder.writeString(daemonParameters.getUid());
    encoder.writeSmallInt(daemonOpts.size());
    for (    String daemonOpt : daemonOpts) {
      encoder.writeString(daemonOpt);
    }
    encoder.flush();
  }
 catch (  IOException e) {
    throw new UncheckedIOException(e);
  }
  ByteArrayInputStream stdInput=new ByteArrayInputStream(serializedConfig.toByteArray());
  DaemonStartupInfo daemonInfo=startProcess(daemonArgs,daemonDir.getVersionedDir(),stdInput);
  listener.daemonStarted(daemonInfo);
  return daemonInfo;
}
