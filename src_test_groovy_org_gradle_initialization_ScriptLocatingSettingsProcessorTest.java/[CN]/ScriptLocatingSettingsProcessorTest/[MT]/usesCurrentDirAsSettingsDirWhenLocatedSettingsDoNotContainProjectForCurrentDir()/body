{
  final StartParameter noSearchParameter=new StartParameter();
  final SettingsInternal currentDirSettings=context.mock(SettingsInternal.class,"currentDirSettings");
  context.checking(new Expectations(){
{
      one(finder).find(startParameter);
      one(finder).getSettingsDir();
      will(returnValue(settingsDir));
      one(propertiesLoader).loadProperties(settingsDir,startParameter);
      one(delegate).process(finder,startParameter,propertiesLoader);
      will(returnValue(settings));
      one(projectRegistry).findAll(defaultProjectSelector);
      will(returnValue(toSet()));
      one(startParameter).newInstance();
      will(returnValue(noSearchParameter));
      one(finder).find(noSearchParameter);
      one(finder).getSettingsDir();
      will(returnValue(currentDir));
      one(propertiesLoader).loadProperties(currentDir,noSearchParameter);
      one(delegate).process(finder,noSearchParameter,propertiesLoader);
      will(returnValue(currentDirSettings));
    }
  }
);
  assertThat(processor.process(finder,startParameter,propertiesLoader),sameInstance(currentDirSettings));
}
