{
  lock.lock();
  try {
    if (broadcastOutgoing == null) {
      Protocol<Message> broadcastSendProtocol=new InstancePerChannelProtocolAdapter<Object>(Object.class,new InstancePerChannelProtocolAdapter.ChannelProtocolFactory<Object>(){
        public Protocol<Object> newChannel(        Object channelKey){
          return new BroadcastSendProtocol();
        }
      }
);
      Protocol<Message> sendProtocol=new InstancePerChannelProtocolAdapter<Object>(Object.class,new InstancePerChannelProtocolAdapter.ChannelProtocolFactory<Object>(){
        public Protocol<Object> newChannel(        Object channelKey){
          return new SendProtocol(idGenerator.generateId(),nodeName);
        }
      }
);
      StoppableExecutor executor=executorFactory.create(displayName + " outgoing broadcast");
      executors.add(executor);
      broadcastOutgoing=new ProtocolStack<Message>(executor,failureHandler,failureHandler,broadcastSendProtocol,sendProtocol,new ConnectionDisconnectProtocol());
      AsyncConnection<Message> outgoingEndpoint=router.createLocalConnection();
      broadcastOutgoing.getBottom().dispatchTo(outgoingEndpoint);
      outgoingEndpoint.dispatchTo(broadcastOutgoing.getBottom());
    }
    return broadcastOutgoing.getTop();
  }
  finally {
    lock.unlock();
  }
}
