{
  CompositeStoppable stoppable=new CompositeStoppable();
  lock.lock();
  try {
    stoppable.add(protocolStack,hub,executor);
  }
  finally {
    channels.clear();
    lock.unlock();
  }
  stoppable.stop();
}
