{
  if (!(action instanceof TestExecutionRequestAction)) {
    return;
  }
  final GradleInternal gradle=buildController.getGradle();
  TestExecutionRequestAction testExecutionRequestAction=(TestExecutionRequestAction)action;
  final Collection<InternalJvmTestExecutionDescriptor> testDescriptors=testExecutionRequestAction.getTestExecutionDescriptors();
  final List<String> testTaskPaths=org.gradle.util.CollectionUtils.collect(testDescriptors,new Transformer<String,InternalJvmTestExecutionDescriptor>(){
    @Override public String transform(    InternalJvmTestExecutionDescriptor internalJvmTestDescriptor){
      return internalJvmTestDescriptor.getTaskPath();
    }
  }
);
  testExecutionRequestAction.getStartParameter().setTaskNames(testTaskPaths);
  for (  final String testTaskPath : testTaskPaths) {
    gradle.addProjectEvaluationListener(new ProjectEvaluationListener(){
      @Override public void beforeEvaluate(      Project project){
      }
      @Override public void afterEvaluate(      Project project,      ProjectState state){
        final Task task=project.getTasks().findByPath(testTaskPath);
        if (task == null) {
          throw new TestExecutionException(String.format("Requested test task with path '%s' cannot be found in project '%s'.",testTaskPath,project.getName()));
        }
 else         if (!(task instanceof Test)) {
          throw new TestExecutionException(String.format("Task '%s' of type '%s' not supported for executing tests via TestLauncher API.",testTaskPath,task.getClass().getName()));
        }
 else {
          Test testTask=(Test)task;
          for (          InternalJvmTestExecutionDescriptor testDescriptor : testDescriptors) {
            if (testDescriptor.getTaskPath().equals(testTaskPath)) {
              final String className=testDescriptor.getClassName();
              final String methodName=testDescriptor.getMethodName();
              if (className == null && methodName == null) {
                testTask.getFilter().includeTestsMatching("*");
              }
 else {
                testTask.getFilter().includeTest(className,methodName);
              }
            }
          }
        }
      }
    }
);
  }
  PayloadSerializer payloadSerializer=gradle.getServices().get(PayloadSerializer.class);
  Throwable failure=null;
  try {
    buildController.run();
  }
 catch (  RuntimeException rex) {
    Throwable throwable=findRootCause(rex);
    if (throwable instanceof InternalTestExecutionException) {
      failure=throwable;
    }
 else     if (throwable instanceof TestExecutionException) {
      failure=new InternalTestExecutionException("Error while running test(s)",throwable);
    }
 else {
      throw rex;
    }
  }
  BuildActionResult buildActionResult;
  if (failure != null) {
    buildActionResult=new BuildActionResult(null,payloadSerializer.serialize(failure));
  }
 else {
    buildActionResult=new BuildActionResult(payloadSerializer.serialize(null),null);
  }
  buildController.setResult(buildActionResult);
}
