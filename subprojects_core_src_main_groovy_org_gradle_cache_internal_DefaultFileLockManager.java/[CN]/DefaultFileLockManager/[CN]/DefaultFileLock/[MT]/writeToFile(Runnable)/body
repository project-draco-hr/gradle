{
  try {
    java.nio.channels.FileLock updateLock=null;
    if (mode != LockMode.Exclusive) {
      lock.release();
      lock=null;
      updateLock=lock(LockMode.Exclusive);
    }
    try {
      markDirty();
      action.run();
      markClean();
    }
  finally {
      if (mode != LockMode.Exclusive) {
        updateLock.release();
        lock=lock(mode);
      }
    }
  }
 catch (  IOException e) {
    throw UncheckedException.asUncheckedException(e);
  }
catch (  InterruptedException e) {
    throw UncheckedException.asUncheckedException(e);
  }
}
