{
  if (mode != LockMode.Exclusive) {
    throw new InsufficientLockModeException("An exclusive lock is required for this operation");
  }
  try {
    integrityViolated=true;
    fileLockAccess.markDirty();
    action.run();
    fileLockAccess.markClean(ownerId);
    integrityViolated=false;
  }
 catch (  Throwable t) {
    throw throwAsUncheckedException(t);
  }
}
