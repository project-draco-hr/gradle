{
  try {
    java.nio.channels.FileLock updateLock=null;
    if (mode != LockMode.Exclusive) {
      lock.release();
      lock=null;
      updateLock=lock(LockMode.Exclusive);
    }
    try {
      integrityViolated=true;
      markDirty();
      action.run();
      markClean();
      integrityViolated=false;
    }
  finally {
      if (mode != LockMode.Exclusive) {
        updateLock.release();
        lock=lock(mode);
      }
    }
  }
 catch (  Throwable t) {
    throw UncheckedException.throwAsUncheckedException(t);
  }
}
