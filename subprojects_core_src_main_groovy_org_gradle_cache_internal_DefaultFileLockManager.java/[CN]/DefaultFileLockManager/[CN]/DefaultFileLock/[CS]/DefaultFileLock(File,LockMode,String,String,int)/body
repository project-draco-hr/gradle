{
  this.port=port;
  this.lockId=generator.generateId();
  if (mode == LockMode.None) {
    throw new UnsupportedOperationException("Locking mode None is not supported.");
  }
  this.target=target;
  this.displayName=displayName;
  this.operationDisplayName=operationDisplayName;
  if (target.isDirectory()) {
    lockFile=new File(target,target.getName() + ".lock");
  }
 else {
    lockFile=new File(target.getParentFile(),target.getName() + ".lock");
  }
  GFileUtils.mkdirs(lockFile.getParentFile());
  lockFile.createNewFile();
  fileLockAccess=new FileLockAccess(lockFile,displayName);
  try {
    lock=lock(mode);
    int previousOwnerId=getPreviousOwnerId();
    hasNewOwner=previousOwnerId != ownerId;
    integrityViolated=previousOwnerId == FileLockAccess.UNKNOWN_PREVIOUS_OWNER;
  }
 catch (  Throwable t) {
    fileLockAccess.close();
    throw t;
  }
  this.mode=lock.isShared() ? LockMode.Shared : LockMode.Exclusive;
}
