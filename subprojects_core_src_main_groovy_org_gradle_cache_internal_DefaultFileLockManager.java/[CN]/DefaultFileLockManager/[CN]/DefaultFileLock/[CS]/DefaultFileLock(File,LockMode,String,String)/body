{
  if (mode == LockMode.None) {
    throw new UnsupportedOperationException("Locking mode None is not supported.");
  }
  this.target=target;
  this.mode=mode;
  this.displayName=displayName;
  this.operationDisplayName=operationDisplayName;
  if (target.isDirectory()) {
    lockFile=new File(target,target.getName() + ".lock");
  }
 else {
    lockFile=new File(target.getParentFile(),target.getName() + ".lock");
  }
  lockFile.getParentFile().mkdirs();
  lockFile.createNewFile();
  lockFileAccess=new RandomAccessFile(lockFile,"rw");
  try {
    lock=lock(mode);
    integrityViolated=!getUnlockedCleanly();
  }
 catch (  Throwable t) {
    lockFileAccess.close();
    throw t;
  }
}
