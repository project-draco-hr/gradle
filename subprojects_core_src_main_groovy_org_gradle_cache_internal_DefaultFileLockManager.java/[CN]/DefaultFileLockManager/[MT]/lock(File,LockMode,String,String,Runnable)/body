{
  if (mode == LockMode.None) {
    throw new UnsupportedOperationException(String.format("No %s mode lock implementation available.",mode));
  }
  File canonicalTarget=GFileUtils.canonicalise(target);
  if (!lockedFiles.add(canonicalTarget)) {
    throw new IllegalStateException(String.format("Cannot lock %s as it has already been locked by this process.",targetDisplayName));
  }
  try {
    int port=fileLockListener.reservePort();
    DefaultFileLock newLock=new DefaultFileLock(canonicalTarget,mode,targetDisplayName,operationDisplayName,port);
    fileLockListener.lockCreated(canonicalTarget,whenContended);
    return newLock;
  }
 catch (  Throwable t) {
    lockedFiles.remove(canonicalTarget);
    throw throwAsUncheckedException(t);
  }
}
