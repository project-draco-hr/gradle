{
  final M metadata=deserializeMetadata(source,transformer,metadataCacheDir);
  final boolean isEmpty=new File(scriptCacheDir,EMPTY_SCRIPT_MARKER_FILE_NAME).isFile();
  return new ClassCachingCompiledScript<T,M>(new CompiledScript<T,M>(){
    @Override public boolean isEmpty(){
      return isEmpty;
    }
    @Override public Class<? extends T> loadClass(){
      if (isEmpty) {
        classLoaderCache.remove(classLoaderId);
        return emptyScriptGenerator.generate(scriptBaseClass);
      }
      try {
        ClassLoader loader=classLoaderCache.get(classLoaderId,new DefaultClassPath(scriptCacheDir),classLoader,null);
        return loader.loadClass(source.getClassName()).asSubclass(scriptBaseClass);
      }
 catch (      Exception e) {
        File expectedClassFile=new File(scriptCacheDir,source.getClassName() + ".class");
        if (!expectedClassFile.exists()) {
          throw new GradleException(String.format("Could not load compiled classes for %s from cache. Expected class file %s does not exist.",source.getDisplayName(),expectedClassFile.getAbsolutePath()),e);
        }
        throw new GradleException(String.format("Could not load compiled classes for %s from cache.",source.getDisplayName()),e);
      }
    }
    @Override public M getData(){
      return metadata;
    }
  }
);
}
