{
  final Transformer transformer=extractingTransformer != null ? extractingTransformer.getTransformer() : null;
  logger.info("Compiling {} using {}.",source.getDisplayName(),transformer != null ? transformer.getClass().getSimpleName() : "no transformer");
  final EmptyScriptDetector emptyScriptDetector=new EmptyScriptDetector();
  final PackageStatementDetector packageDetector=new PackageStatementDetector();
  final ImperativeStatementDetector imperativeStatementDetector=new ImperativeStatementDetector(classpathClosureName);
  GroovyClassLoader groovyClassLoader=new GroovyClassLoader(classLoader,configuration,false){
    @Override protected CompilationUnit createCompilationUnit(    CompilerConfiguration compilerConfiguration,    CodeSource codeSource){
      CompilationUnit compilationUnit=new CustomCompilationUnit(compilerConfiguration,codeSource,customVerifier,source,this);
      if (transformer != null) {
        transformer.register(compilationUnit);
      }
      compilationUnit.addPhaseOperation(packageDetector,Phases.CANONICALIZATION);
      compilationUnit.addPhaseOperation(emptyScriptDetector,Phases.CANONICALIZATION);
      compilationUnit.addPhaseOperation(imperativeStatementDetector,Phases.CANONICALIZATION);
      return compilationUnit;
    }
  }
;
  String scriptText=source.getResource().getText();
  String scriptName=source.getClassName();
  GroovyCodeSource codeSource=new GroovyCodeSource(scriptText == null ? "" : scriptText,scriptName,"/groovy/script");
  try {
    groovyClassLoader.parseClass(codeSource,false);
  }
 catch (  MultipleCompilationErrorsException e) {
    wrapCompilationFailure(source,e);
  }
catch (  CompilationFailedException e) {
    throw new GradleException(String.format("Could not compile %s.",source.getDisplayName()),e);
  }
  if (packageDetector.hasPackageStatement) {
    throw new UnsupportedOperationException(String.format("%s should not contain a package statement.",StringUtils.capitalize(source.getDisplayName())));
  }
  if (emptyScriptDetector.isEmptyScript()) {
    GFileUtils.touch(new File(classesDir,EMPTY_SCRIPT_MARKER_FILE_NAME));
  }
  if (imperativeStatementDetector.hasImperativeStatements) {
    GFileUtils.touch(new File(classesDir,IMPERATIVE_STATEMENTS_MARKER_FILE_NAME));
  }
  serializeMetadata(source,extractingTransformer,metadataDir);
}
