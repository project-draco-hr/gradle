{
  DefaultGradleLauncher launcher=(DefaultGradleLauncher)buildController.getLauncher();
  final PayloadSerializer payloadSerializer=launcher.getGradle().getServices().get(PayloadSerializer.class);
  final AtomicReference<Object> model=new AtomicReference<Object>();
  final AtomicReference<RuntimeException> failure=new AtomicReference<RuntimeException>();
  final Action<GradleInternal> action=new Action<GradleInternal>(){
    public void execute(    GradleInternal gradle){
      ToolingModelBuilderRegistry builderRegistry=getToolingModelBuilderRegistry(gradle);
      ToolingModelBuilder builder;
      try {
        builder=builderRegistry.getBuilder(modelName);
      }
 catch (      UnknownModelException e) {
        failure.set((InternalUnsupportedModelException)(new InternalUnsupportedModelException().initCause(e)));
        return;
      }
      Object result;
      if (builder instanceof ProjectSensitiveToolingModelBuilder) {
        result=((ProjectSensitiveToolingModelBuilder)builder).buildAll(modelName,gradle.getDefaultProject(),true);
      }
 else {
        result=builder.buildAll(modelName,gradle.getDefaultProject());
      }
      model.set(result);
    }
  }
;
  if (runTasks) {
    launcher.addListener(new TasksCompletionListener(){
      public void onTasksFinished(      GradleInternal gradle){
        action.execute(gradle);
      }
    }
);
    buildController.run();
  }
 else {
    launcher.addListener(new ModelConfigurationListener(){
      public void onConfigure(      GradleInternal gradle){
        ensureAllProjectsEvaluated(gradle);
        action.execute(gradle);
      }
    }
);
    buildController.configure();
  }
  if (failure.get() != null) {
    throw failure.get();
  }
  return new BuildActionResult(payloadSerializer.serialize(model.get()),null);
}
