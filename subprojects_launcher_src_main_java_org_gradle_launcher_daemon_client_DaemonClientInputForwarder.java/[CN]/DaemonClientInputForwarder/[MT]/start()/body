{
  lifecycleLock.lock();
  try {
    if (started) {
      throw new IllegalStateException("DaemonClientInputForwarder already started");
    }
    Action<String> dispatcher=new Action<String>(){
      public void execute(      String input){
        if (LOGGER.isDebugEnabled()) {
          LOGGER.debug("Forwarding input to daemon: '{}'",input.replace("\n","\\n"));
        }
        dispatch.dispatch(new ForwardInput(idGenerator.generateId(),input.getBytes()));
      }
    }
;
    Runnable onFinish=new Runnable(){
      public void run(){
        CloseInput message=new CloseInput(idGenerator.generateId());
        LOGGER.debug("Dispatching close input message: {}",message);
        dispatch.dispatch(message);
      }
    }
;
    forwarder=new InputForwarder(inputStream,dispatcher,onFinish,executorFactory,bufferSize).start();
    started=true;
    return this;
  }
  finally {
    lifecycleLock.unlock();
  }
}
