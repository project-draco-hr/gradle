{
  String prefix=dir.getAbsolutePath() + File.separator;
  if (!file.getAbsolutePath().startsWith(prefix)) {
    return false;
  }
  if (checkExistence && !file.isFile()) {
    return false;
  }
  RelativePath path=new RelativePath(true,file.getAbsolutePath().substring(prefix.length()).split(Pattern.quote(File.separator)));
  return patternSet.getAsSpec().isSatisfiedBy(new DefaultFileTreeElement(file,path,fileSystem,fileSystem));
}
