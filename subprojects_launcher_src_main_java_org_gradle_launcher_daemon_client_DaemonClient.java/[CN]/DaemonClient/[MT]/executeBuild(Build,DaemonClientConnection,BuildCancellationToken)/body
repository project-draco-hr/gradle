{
  Object result;
  try {
    LOGGER.info("Connected to the daemon. Dispatching {} request.",build);
    connection.dispatch(build);
    result=connection.receive();
  }
 catch (  StaleDaemonAddressException e) {
    LOGGER.debug("Connected to a stale daemon address.",e);
    throw new DaemonInitialConnectException("Connected to a stale daemon address.",e);
  }
  if (result == null) {
    throw new DaemonInitialConnectException("The first result from the daemon was empty. Most likely the process died immediately after connection.");
  }
  if (result instanceof BuildStarted) {
    DaemonDiagnostics diagnostics=((BuildStarted)result).getDiagnostics();
    result=monitorBuild(build,diagnostics,connection,cancellationToken);
  }
  connection.dispatch(new Finished());
  if (result instanceof Failure) {
    throw UncheckedException.throwAsUncheckedException(((Failure)result).getValue());
  }
 else   if (result instanceof DaemonUnavailable) {
    throw new DaemonInitialConnectException("The daemon we connected to was unavailable: " + ((DaemonUnavailable)result).getReason());
  }
 else   if (result instanceof Result) {
    return ((Result)result).getValue();
  }
 else {
    throw invalidResponse(result,build);
  }
}
