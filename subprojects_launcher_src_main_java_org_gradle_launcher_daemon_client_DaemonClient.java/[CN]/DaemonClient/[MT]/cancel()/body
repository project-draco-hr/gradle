{
  long start=System.currentTimeMillis();
  long expiry=start + STOP_TIMEOUT_SECONDS * 1000;
  Set<String> cancelled=new HashSet<String>();
  DaemonClientConnection connection=connector.maybeConnect(compatibilitySpec);
  if (connection == null) {
    LOGGER.lifecycle(DaemonMessages.NO_DAEMONS_RUNNING);
    return;
  }
  LOGGER.lifecycle("Cancelling daemon build(s).");
  while (connection != null && System.currentTimeMillis() < expiry) {
    try {
      if (cancelled.add(connection.getUid())) {
        new CancelDispatcher(idGenerator).dispatch(connection);
        LOGGER.lifecycle("Gradle build stopped.");
      }
    }
  finally {
      connection.stop();
    }
    connection=connector.maybeConnect(compatibilitySpec);
  }
  if (connection != null) {
    throw new GradleException(String.format("Timeout waiting for all daemons to cancel their builds. Waited %s seconds.",(System.currentTimeMillis() - start) / 1000));
  }
}
