{
  DaemonClientInputForwarder inputForwarder=new DaemonClientInputForwarder(daemonServerStandardInput,build.getClientMetaData(),connection);
  try {
    connection.dispatch(build);
    inputForwarder.start();
    while (true) {
      Object object=connection.receive();
      if (object == null) {
        throw new DaemonDisappearedException(build,connection);
      }
 else       if (object instanceof OutputEvent) {
        outputEventListener.onOutput((OutputEvent)object);
      }
 else       if (object instanceof Result) {
        @SuppressWarnings("unchecked") Result<T> result=(Result<T>)object;
        return result;
      }
 else {
        throw new IllegalStateException(String.format("Daemon returned %s (type: %s) for which there is no strategy to handle",object,object.getClass()));
      }
    }
  }
  finally {
    inputForwarder.stop();
    connection.stop();
  }
}
