{
  TestNG testNg=new TestNG();
  testNg.setOutputDirectory(testReportDir.getAbsolutePath());
  testNg.setDefaultSuiteName(options.getDefaultSuiteName());
  testNg.setDefaultTestName(options.getDefaultTestName());
  testNg.setParallel(options.getParallel());
  testNg.setThreadCount(options.getThreadCount());
  try {
    final Method setAnnotations=TestNG.class.getMethod("setAnnotations");
    setAnnotations.invoke(testNg,options.getAnnotations());
  }
 catch (  NoSuchMethodException e) {
  }
catch (  Exception e) {
    throw new GradleException(String.format("Could not configure TestNG annotations with value '%s'.",options.getAnnotations()),e);
  }
  if (options.getJavadocAnnotations()) {
    testNg.setSourcePath(CollectionUtils.join(File.pathSeparator,options.getTestResources()));
  }
  testNg.setUseDefaultListeners(options.getUseDefaultListeners());
  testNg.addListener((Object)adaptListener(testResultProcessor));
  testNg.setVerbose(0);
  testNg.setGroups(CollectionUtils.join(",",options.getIncludeGroups()));
  testNg.setExcludedGroups(CollectionUtils.join(",",options.getExcludeGroups()));
  for (  String listenerClass : options.getListeners()) {
    try {
      testNg.addListener(applicationClassLoader.loadClass(listenerClass).newInstance());
    }
 catch (    Throwable e) {
      throw new GradleException(String.format("Could not add a test listener with class '%s'.",listenerClass),e);
    }
  }
  if (!suiteFiles.isEmpty()) {
    testNg.setTestSuites(GFileUtils.toPaths(suiteFiles));
  }
 else {
    Class[] classes=testClasses.toArray(new Class[testClasses.size()]);
    testNg.setTestClasses(classes);
  }
  testNg.run();
}
