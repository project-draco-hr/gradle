{
  TestNG testNg=new TestNG();
  testNg.setOutputDirectory(testReportDir.getAbsolutePath());
  testNg.setDefaultSuiteName(options.getDefaultSuiteName());
  testNg.setDefaultTestName(options.getDefaultTestName());
  testNg.setParallel(options.getParallel());
  testNg.setThreadCount(options.getThreadCount());
  try {
    JavaReflectionUtil.method(TestNG.class,Object.class,"setAnnotations").invoke(testNg,options.getAnnotations());
  }
 catch (  NoSuchMethodException e) {
  }
  if (options.getJavadocAnnotations()) {
    testNg.setSourcePath(CollectionUtils.join(File.pathSeparator,options.getTestResources()));
  }
  testNg.setUseDefaultListeners(options.getUseDefaultListeners());
  testNg.addListener((Object)adaptListener(testResultProcessor));
  testNg.setVerbose(0);
  testNg.setGroups(CollectionUtils.join(",",options.getIncludeGroups()));
  testNg.setExcludedGroups(CollectionUtils.join(",",options.getExcludeGroups()));
  for (  String listenerClass : options.getListeners()) {
    try {
      testNg.addListener(applicationClassLoader.loadClass(listenerClass).newInstance());
    }
 catch (    Throwable e) {
      throw new GradleException(String.format("Could not add a test listener with class '%s'.",listenerClass),e);
    }
  }
  if (!suiteFiles.isEmpty()) {
    testNg.setTestSuites(GFileUtils.toPaths(suiteFiles));
  }
 else {
    if (options.getIncludedTests().isEmpty()) {
      testNg.setTestClasses(testClasses.toArray(new Class[testClasses.size()]));
    }
 else {
      configureXmlTestSuite(testNg,testClasses,options.getIncludedTests());
    }
  }
  testNg.run();
}
