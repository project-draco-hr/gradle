{
  ListenerBroadcast<TestResultProcessor> processors=new ListenerBroadcast<TestResultProcessor>(TestResultProcessor.class);
  processors.add(resultProcessor);
  if (testReportOn) {
    processors.add(new TestNGJUnitXmlReportGenerator(testResultsDir));
  }
  TestResultProcessor resultProcessorChain=new CaptureTestOutputTestResultProcessor(processors.getSource(),outputRedirector);
  testResultProcessor=new TestNGTestResultProcessorAdapter(resultProcessorChain,idGenerator);
  applicationClassLoader=Thread.currentThread().getContextClassLoader();
}
