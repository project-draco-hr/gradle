{
  Receive<Message> receive;
  lock.lock();
  try {
    while (receiveState == State.AwaitConnect) {
      try {
        condition.await();
      }
 catch (      InterruptedException e) {
        throw new UncheckedException(e);
      }
    }
switch (receiveState) {
case Stopping:
      setState(State.Stopped,dispatchState);
    return new EndOfStreamEvent();
case Stopped:
  return null;
case Connected:
break;
default :
throw new IllegalStateException(String.format("Connection is in unexpected receive state %s.",receiveState));
}
receive=connection;
}
  finally {
lock.unlock();
}
Message message;
try {
message=receive.receive();
}
 catch (Throwable throwable) {
LOGGER.error(String.format("Could not receive next message using %s. Discarding connection.",receive),throwable);
message=new EndOfStreamEvent();
}
if (message == null) {
LOGGER.warn("Received unexpected end-of-stream. Discarding connection");
message=new EndOfStreamEvent();
}
if (!(message instanceof EndOfStreamEvent)) {
return message;
}
lock.lock();
try {
switch (receiveState) {
case Connected:
setState(State.Stopped,dispatchState);
break;
default :
throw new IllegalStateException(String.format("Connection is in unexpected state %s.",receiveState));
}
}
  finally {
lock.unlock();
}
cleanup();
return message;
}
