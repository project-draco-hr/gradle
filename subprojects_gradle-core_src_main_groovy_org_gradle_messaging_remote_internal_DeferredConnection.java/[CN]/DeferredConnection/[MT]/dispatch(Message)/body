{
  Dispatch<Message> dispatch;
  lock.lock();
  try {
    boolean endOfStream=message instanceof EndOfStreamEvent;
    while (!endOfStream && dispatchState == State.AwaitConnect) {
      try {
        condition.await();
      }
 catch (      InterruptedException e) {
        throw new UncheckedException(e);
      }
    }
switch (dispatchState) {
case AwaitConnect:
      setState(receiveState.onDispatchEndOfStream(),State.Stopped);
    return;
case Connected:
  if (endOfStream) {
    setState(receiveState.onDispatchEndOfStream(),State.Stopped);
  }
break;
case Stopping:
if (endOfStream) {
setState(receiveState,State.Stopped);
return;
}
LOGGER.error("Could not send message, as connection is stopping.");
return;
default :
throw new IllegalStateException(String.format("Connection is in unexpected dispatch state %s.",dispatchState));
}
dispatch=connection;
}
  finally {
lock.unlock();
}
try {
dispatch.dispatch(message);
}
 catch (Throwable throwable) {
LOGGER.error(String.format("Could not send message using %s. Discarding connection.",dispatch),throwable);
lock.lock();
try {
switch (dispatchState) {
case Connected:
setState(receiveState.onDispatchEndOfStream(),State.Stopped);
break;
default :
throw new IllegalStateException(String.format("Connection is in unexpected dispatch state %s.",dispatchState));
}
}
  finally {
lock.unlock();
}
}
cleanup();
}
