{
  try {
    MessageDigestStream digestStream=new MessageDigestStream();
    keySerializer.write(digestStream,key);
    long hashCode=digestStream.getChecksum();
    Lookup lookup=header.getRoot().find(hashCode);
    boolean needNewBlock=true;
    if (lookup.entry != null) {
      DataBlock block=store.read(lookup.entry.dataBlock,DataBlock.class);
      needNewBlock=!block.useNewValue(value);
      if (needNewBlock) {
        store.remove(block);
      }
    }
    if (needNewBlock) {
      DataBlock block=new DataBlock(value);
      store.write(block);
      lookup.indexBlock.put(hashCode,block.getPos());
    }
    store.flush();
  }
 catch (  Exception e) {
    throw new UncheckedIOException(String.format("Could not add entry '%s' to %s.",key,this),e);
  }
}
